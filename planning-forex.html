<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Forex - Donn√©es R√©elles</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="vip-styles.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <link rel="stylesheet" href="economic-calendar-styles.css">
    <link rel="stylesheet" href="chat-mobile-styles.css">
    <link rel="stylesheet" href="mobile-fixes.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00d4ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Misterpips">
    <link rel="apple-touch-icon" href="Misterpips.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
    <div id="trading-chart"></div>
    
    <header>
        <div class="logo-container">
            <img src="Misterpips.jpg" alt="Misterpips Logo" class="logo">
        </div>
        <nav>
            <button class="mobile-menu-btn" id="mobileMenuBtn" style="display: none;">‚ò∞</button>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="#planning">Planning</a></li>
                <li><a href="#calendar">Calendrier</a></li>
                <li><a href="#impact">Impact Annonces</a></li>
                <li><a href="#history">Historique</a></li>
                <li><a href="vip-space.html" class="vip-link">Retour VIP</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="hero">
            <div class="hero-content">
                <h1>Planning Forex - Donn√©es R√©elles</h1>
                <p>Sessions de trading et analyses en temps r√©el</p>
                <div class="status-indicator">
                    <span id="firebaseStatus">üîÑ Firebase: Connexion...</span>
                </div>
            </div>
        </section>


        
        <!-- Calendrier √âconomique -->
        <section id="calendar" class="section">
            <div class="container">
                <h2>Calendrier √âconomique Forex</h2>
                <div class="dashboard-card economic-calendar-card">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar-alt"></i> Actualit√©s & Annonces √âconomiques</h3>
                        <div class="refresh-btn" id="refreshCalendar">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                    </div>
                    <div class="calendar-filters" id="calendarFilters">
                        <div class="filter-group">
                            <label>Impact:</label>
                            <select id="impactFilter" onchange="updateCalendarLinks()">
                                <option value="all">Tous</option>
                                <option value="high">üî¥ High</option>
                                <option value="medium">üü° Medium</option>
                                <option value="low">üü¢ Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Devise:</label>
                            <select id="currencyFilter" onchange="updateCalendarLinks()">
                                <option value="all">Toutes</option>
                                <option value="USD">üá∫üá∏ USD</option>
                                <option value="EUR">üá™üá∫ EUR</option>
                                <option value="GBP">üá¨üáß GBP</option>
                                <option value="JPY">üáØüáµ JPY</option>
                                <option value="XAU">ü•á OR</option>
                                <option value="DAX">üá©üá™ DAX</option>
                                <option value="NASDAQ">üá∫üá∏ NASDAQ</option>
                            </select>
                        </div>
                    </div>
                    <div class="economic-calendar-table" id="economicCalendar">
                        <div class="real-calendar-links">
                            <h4>üìÖ Calendriers √âconomiques</h4>
                            <p id="filterStatus">Filtres actifs: toutes devises - Impact tous</p>
                            
                            <div class="calendar-notice">
                                <p>‚ö†Ô∏è Les sites externes ne permettent pas de filtrer automatiquement par devise.</p>
                                <p>üìù Une fois sur le site, utilisez leurs filtres pour s√©lectionner votre devise.</p>
                            </div>
                            
                            <a href="https://www.investing.com/economic-calendar/" target="_blank" class="calendar-link primary">
                                <div class="calendar-icon">üíº</div>
                                <div class="calendar-info">
                                    <strong>Investing.com</strong>
                                    <span id="investingText">Calendrier complet - Filtrer manuellement</span>
                                </div>
                            </a>
                            
                            <a href="https://www.forexfactory.com/calendar" target="_blank" class="calendar-link">
                                <div class="calendar-icon">üè≠</div>
                                <div class="calendar-info">
                                    <strong>Forex Factory</strong>
                                    <span id="forexFactoryText">Calendrier Forex - Filtrer manuellement</span>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Impact des Annonces -->
        <section id="impact" class="section">
            <div class="container">
                <h2>üìä Impact des Annonces √âconomiques</h2>
                <div class="dashboard-card impact-analyzer">
                    <div class="card-header">
                        <h3>Analyseur d'Impact</h3>
                    </div>
                    <div class="analyzer-controls">
                        <div class="control-group">
                            <label>Devise:</label>
                            <select id="currencySelect">
                                <option value="USD">üá∫üá∏ USD</option>
                                <option value="EUR">üá™üá∫ EUR</option>
                                <option value="GBP">üá¨üáß GBP</option>
                                <option value="JPY">üáØüáµ JPY</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Annonce:</label>
                            <select id="announcementSelect">
                                <option value="NFP">Non-Farm Payrolls</option>
                                <option value="CPI">Inflation CPI</option>
                                <option value="GDP">PIB GDP</option>
                                <option value="RATE">Taux int√©r√™t</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>R√©sultat (%):</label>
                            <input type="number" id="resultInput" placeholder="Ex: 2.5" step="0.1">
                        </div>
                        <div class="control-group">
                            <label>Consensus March√© (%):</label>
                            <input type="number" id="consensusInput" placeholder="Ex: 2.3" step="0.1">
                        </div>
                        <div class="control-group">
                            <label>R√©sultat Pr√©c√©dent (%):</label>
                            <input type="number" id="previousInput" placeholder="Ex: 2.1" step="0.1">
                        </div>
                        <button onclick="
                            const currency = document.getElementById('currencySelect').value;
                            const announcement = document.getElementById('announcementSelect').value;
                            const result = parseFloat(document.getElementById('resultInput').value) || 2.5;
                            const consensus = parseFloat(document.getElementById('consensusInput').value) || 2.3;
                            const previous = parseFloat(document.getElementById('previousInput').value) || 2.1;
                            
                            // Donn√©es historiques
                            const historical = HISTORICAL_DATA[currency][announcement] || [];
                            const results = historical.map(h => h.result);
                            const impacts = historical.map(h => h.impact);
                            
                            // Calculs statistiques professionnels
                            const mean = results.reduce((a,b) => a+b, 0) / results.length;
                            const variance = results.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / results.length;
                            const stdDev = Math.sqrt(variance);
                            
                            // Z-Score (m√©thode Bloomberg)
                            const surprise = result - consensus;
                            const zScore = stdDev > 0 ? surprise / stdDev : 0;
                            
                            // Impact bas√© sur r√©gression lin√©aire
                            const correlation = this.calculateCorrelation ? this.calculateCorrelation(results, impacts) : 0.7;
                            const beta = correlation * (impacts.reduce((a,b) => Math.abs(a) + Math.abs(b), 0) / impacts.length) / stdDev;
                            const predictedImpact = beta * surprise;
                            
                            // Ajustement momentum (vs pr√©c√©dent)
                            const momentum = (result - previous) / previous;
                            const momentumFactor = 1 + (momentum * 0.3); // 30% weight
                            const finalImpact = (predictedImpact * momentumFactor).toFixed(3);
                            
                            // Niveau de confiance statistique
                            let confidence, probability;
                            if (Math.abs(zScore) >= 2) {
                                confidence = 'Tr√®s Forte';
                                probability = '95%';
                            } else if (Math.abs(zScore) >= 1.5) {
                                confidence = 'Forte';
                                probability = '87%';
                            } else if (Math.abs(zScore) >= 1) {
                                confidence = 'Mod√©r√©e';
                                probability = '68%';
                            } else {
                                confidence = 'Faible';
                                probability = '50%';
                            }
                            
                            // Direction bas√©e sur impact pr√©dit
                            let direction;
                            if (finalImpact > 0.5) direction = 'Hausse Forte';
                            else if (finalImpact > 0.2) direction = 'Hausse Mod√©r√©e';
                            else if (finalImpact < -0.5) direction = 'Baisse Forte';
                            else if (finalImpact < -0.2) direction = 'Baisse Mod√©r√©e';
                            else direction = 'Neutre';
                            
                            const reasoning = `Z-Score: ${zScore.toFixed(2)} | Surprise: ${surprise > 0 ? '+' : ''}${surprise.toFixed(2)}% vs consensus`;
                            
                            document.getElementById('impactResults').innerHTML = `
                                <div class='impact-summary'>
                                    <h4>Analyse ${announcement} sur ${currency}</h4>
                                    <div class='impact-stats'>
                                        <div class='stat-item'>
                                            <span class='stat-label'>Impact Pr√©dit:</span>
                                            <span class='stat-value ${finalImpact > 0 ? 'positive' : finalImpact < 0 ? 'negative' : 'neutral'}'>${finalImpact > 0 ? '+' : ''}${finalImpact}%</span>
                                        </div>
                                        <div class='stat-item'>
                                            <span class='stat-label'>Z-Score:</span>
                                            <span class='stat-value ${zScore > 0 ? 'positive' : zScore < 0 ? 'negative' : 'neutral'}'>${zScore.toFixed(2)}</span>
                                        </div>
                                        <div class='stat-item'>
                                            <span class='stat-label'>Surprise:</span>
                                            <span class='stat-value ${surprise > 0 ? 'positive' : surprise < 0 ? 'negative' : 'neutral'}'>${surprise > 0 ? '+' : ''}${surprise.toFixed(2)}%</span>
                                        </div>
                                        <div class='stat-item'>
                                            <span class='stat-label'>Probabilit√©:</span>
                                            <span class='stat-value'>${probability}</span>
                                        </div>
                                        <div class='stat-item'>
                                            <span class='stat-label'>Pr√©diction:</span>
                                            <span class='stat-value'>${direction}</span>
                                        </div>
                                        <div class='stat-item'>
                                            <span class='stat-label'>Confiance:</span>
                                            <span class='stat-value'>${confidence}</span>
                                        </div>
                                    </div>
                                    <div class='historical-chart'>
                                        <h5>Historique 12 derniers mois</h5>
                                        <div class='chart-bars'>
                                            ${historical.map(item => `
                                                <div class='chart-bar'>
                                                    <div class='bar ${item.impact > 0 ? 'positive' : 'negative'}' 
                                                         style='height: ${Math.abs(item.impact) * 30 + 10}px'
                                                         title='${item.date}: ${item.impact}%'>
                                                    </div>
                                                    <span class='bar-label'>${item.date.split('-')[1]}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class='impact-explanation'>
                                        <p><strong>M√©thode:</strong> Mod√®le √©conom√©trique (Z-Score + R√©gression + Momentum)</p>
                                        <p><strong>Analyse:</strong> ${reasoning}</p>
                                        <p><strong>Pr√©diction:</strong> ${direction} | Confiance: ${confidence} (${probability})</p>
                                    </div>
                                </div>
                            `;
                            
                            // Sauvegarder dans l'historique
                            addHistoricalData(currency, announcement, result, consensus, previous);
                            
                            // Mettre √† jour l'historique en temps r√©el
                            setTimeout(() => {
                                updateHistoryChart();
                            }, 500);
                        " class="analyze-btn">Analyser</button>
                        
                        <button onclick="openDataManager()" class="data-manager-btn">
                            üìÖ G√©rer les Donn√©es
                        </button>
                    </div>
                    <div id="impactResults"></div>
                </div>
            </div>
        </section>

        <!-- Sessions de Trading -->
        <section id="planning" class="section">
            <div class="container">
                <h2>Sessions de Trading Actives</h2>
                <div class="sessions-grid">
                    <div class="session-card" id="sydney-session">
                        <div class="session-header">
                            <i class="fas fa-sun"></i>
                            <h3>Sydney</h3>
                            <span class="session-status" id="sydney-status">Ferm√©e</span>
                        </div>
                        <div class="session-time">22h00 - 07h00 (GMT+1)</div>
                    </div>
                    
                    <div class="session-card" id="tokyo-session">
                        <div class="session-header">
                            <i class="fas fa-yen-sign"></i>
                            <h3>Tokyo</h3>
                            <span class="session-status" id="tokyo-status">Ferm√©e</span>
                        </div>
                        <div class="session-time">01h00 - 10h00 (GMT+1)</div>
                    </div>
                    
                    <div class="session-card" id="london-session">
                        <div class="session-header">
                            <i class="fas fa-pound-sign"></i>
                            <h3>Londres</h3>
                            <span class="session-status" id="london-status">Ferm√©e</span>
                        </div>
                        <div class="session-time">08h00 - 17h00 (GMT+1)</div>
                    </div>
                    
                    <div class="session-card" id="newyork-session">
                        <div class="session-header">
                            <i class="fas fa-dollar-sign"></i>
                            <h3>New York</h3>
                            <span class="session-status" id="newyork-status">Ferm√©e</span>
                        </div>
                        <div class="session-time">14h00 - 23h00 (GMT+1)</div>
                    </div>
                </div>
            </div>
        </section>



        <!-- Historique Impact -->
        <section id="history" class="section">
            <div class="container">
                <h2>üìà Historique des Impacts</h2>
                <div class="dashboard-card history-card">
                    <div class="card-header">
                        <h3><i class="fas fa-history"></i> Tendances par Annonce</h3>
                        <div class="history-controls">
                            <select id="historyDevise">
                                <option value="USD">üá∫üá∏ USD</option>
                                <option value="EUR">üá™üá∫ EUR</option>
                                <option value="GBP">üá¨üáß GBP</option>
                                <option value="JPY">üáØüáµ JPY</option>
                            </select>
                            <select id="historyAnnonce">
                                <option value="NFP">NFP</option>
                                <option value="CPI">CPI</option>
                                <option value="GDP">GDP</option>
                                <option value="RATE">RATE</option>
                            </select>
                            <button onclick="updateHistoryChart()" class="history-btn">Actualiser</button>
                        </div>
                    </div>
                    <div class="history-chart" id="historyChart">
                        <!-- Graphique g√©n√©r√© automatiquement -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <img src="Misterpips.jpg" alt="Misterpips Logo" class="footer-logo-img">
                <p>Misterpips - Donn√©es Forex R√©elles</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Misterpips. Donn√©es en temps r√©el.</p>
        </div>
    </footer>

    <script src="simple-vip-security.js"></script>
    <script src="mobile-menu.js"></script>
    <script src="mobile-optimizations.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getDatabase } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDSDK0NfVSs_VQb3TnrixiJbOpTsmoUMvU",
            authDomain: "misterpips-b71fb.firebaseapp.com",
            databaseURL: "https://misterpips-b71fb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "misterpips-b71fb",
            storageBucket: "misterpips-b71fb.firebasestorage.app",
            messagingSenderId: "574231126409",
            appId: "1:574231126409:web:b7ed93ac4ea62e247dc158"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        window.firebaseApp = app;
        window.firebaseDb = db;
        
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                // Charger les donn√©es historiques une fois connect√©
                setTimeout(() => {
                    loadHistoricalData();
                    updateFirebaseStatus('üü¢ Firebase: Connect√©', true);
                }, 1000);
            }
        });
        
        // Fonction pour mettre √† jour le statut Firebase
        window.updateFirebaseStatus = function(status, isConnected) {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.style.color = isConnected ? '#4ecdc4' : '#ff6b6b';
            }
        };
        
        // Fonction pour d√©clencher une sauvegarde automatique
        window.triggerAutoSave = function() {
            if (typeof updateFirebaseStatus === 'function') {
                updateFirebaseStatus('üîÑ Firebase: Sauvegarde...', false);
            }
            saveToFirebase();
        };
    </script>
    <script src="historical-data.js"></script>
    <script>
        class RealTimeForexData {
            constructor() {
                this.pairs = ['EURUSD', 'GBPUSD', 'USDJPY', 'AUDUSD', 'USDCHF', 'NZDUSD', 'USDCAD'];
                this.prices = {};
                this.historicalData = {};
                this.trends = {};
                this.init();
            }

            async init() {
                this.updateSessions();
                await this.loadEconomicCalendar();
                this.setupImpactAnalyzer();
                
                // Initialiser les liens de calendrier
                setTimeout(() => {
                    if (typeof updateCalendarLinks === 'function') {
                        updateCalendarLinks();
                    }
                }, 1000);
                
                // D√©marrer les mises √† jour temps r√©el
                this.startRealTimeUpdates();
                
                // Test initial
                setTimeout(() => {
                    console.log('Test analyzer');
                    this.analyzeAnnouncementImpact();
                }, 2000);
            }
            
            setupImpactAnalyzer() {
                const analyzeBtn = document.getElementById('analyzeBtn');
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', () => {
                        this.analyzeAnnouncementImpact();
                    });
                }
                
                // Analyse initiale
                setTimeout(() => {
                    this.analyzeAnnouncementImpact();
                }, 1000);
                this.startRealTimeUpdates();
            }
            
            async loadEconomicCalendar() {
                const calendarContainer = document.getElementById('economicCalendar');
                calendarContainer.innerHTML = '<div class="loading-calendar">üîÑ Chargement du calendrier √©conomique...</div>';
                
                try {
                    const events = await this.fetchEconomicEvents();
                    this.renderEconomicCalendar(events);
                } catch (error) {
                    console.error('Erreur chargement calendrier:', error);
                    this.renderFallbackCalendar();
                }
            }
            
            async fetchEconomicEvents() {
                return [];
            }
            


            
            processRealVolatilityData(vixData, dxyData) {
                const volatilityContainer = document.querySelector('.volatility-indicators');
                volatilityContainer.innerHTML = '';
                
                const vixValue = vixData.c?.[vixData.c.length - 1] || 20;
                const dxyVol = this.calculateVolatility(dxyData.c || []);
                
                const instruments = [
                    { name: 'VIX (S&P 500)', value: vixValue.toFixed(2), status: vixValue > 25 ? 'üî¥ √âlev√©e' : 'üü¢ Normale' },
                    { name: 'DXY Volatilit√©', value: dxyVol.toFixed(2) + '%', status: dxyVol > 1 ? 'üî¥ √âlev√©e' : 'üü¢ Normale' }
                ];
                
                instruments.forEach(instrument => {
                    const volItem = document.createElement('div');
                    volItem.className = 'vol-item';
                    volItem.innerHTML = `
                        <span class="vol-label">${instrument.name}:</span>
                        <span class="vol-value">${instrument.value}</span>
                        <span class="vol-status">${instrument.status}</span>
                    `;
                    volatilityContainer.appendChild(volItem);
                });
            }
            
            calculateVolatility(prices) {
                if (prices.length < 2) return 0;
                const returns = [];
                for (let i = 1; i < prices.length; i++) {
                    returns.push((prices[i] - prices[i-1]) / prices[i-1]);
                }
                const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                return Math.sqrt(variance) * 100;
            }
            
            async updateSessionVolume(sessionId) {
                try {
                    const response = await fetch(`https://api.marketdata.app/v1/forex/candles/EURUSD/?resolution=1H&limit=1`);
                    const data = await response.json();
                    const volume = data.v?.[0] || 0;
                    
                    const volumeElement = document.getElementById(`${sessionId}-volume`);
                    if (volumeElement) {
                        volumeElement.textContent = `Volume: ${(volume / 1000000).toFixed(1)}M`;
                    }
                } catch (error) {
                    const volumeElement = document.getElementById(`${sessionId}-volume`);
                    if (volumeElement) {
                        volumeElement.textContent = 'Volume: API indisponible';
                    }
                }
            }
            
            extractCurrency(title) {
                if (title.includes('USD') || title.includes('Dollar')) return 'USD';
                if (title.includes('EUR') || title.includes('Euro')) return 'EUR';
                if (title.includes('GBP') || title.includes('Pound')) return 'GBP';
                if (title.includes('JPY') || title.includes('Yen')) return 'JPY';
                if (title.includes('Gold')) return 'XAU';
                return 'USD';
            }
            
            determineImpact(title) {
                const highImpact = ['NFP', 'CPI', 'GDP', 'Fed', 'ECB', 'BoJ', 'Interest'];
                const mediumImpact = ['Retail', 'PMI', 'Employment', 'Inflation'];
                
                if (highImpact.some(word => title.includes(word))) return 'high';
                if (mediumImpact.some(word => title.includes(word))) return 'medium';
                return 'low';
            }
            
            renderEconomicCalendar(events) {
                const calendarContainer = document.getElementById('economicCalendar');
                this.allEvents = events;
                
                if (events.length > 0) {
                    this.renderLiveEvents(events);
                } else {
                    this.renderFallbackCalendar();
                }
            }
            
            renderLiveEvents(events) {
                const liveEventsContainer = document.getElementById('liveEvents');
                if (!liveEventsContainer) return;
                
                liveEventsContainer.innerHTML = '';
                
                events.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = `live-event ${event.impact === 'high' ? 'high-impact' : ''}`;
                    
                    eventElement.innerHTML = `
                        <div class="event-time">
                            ${event.time}
                            <div style="font-size: 0.7em; color: rgba(255,255,255,0.6);">
                                ${event.isPast ? '‚úì' : 'üïí'}
                            </div>
                        </div>
                        <div class="event-details">
                            <h4>${event.event}</h4>
                            <div class="currency">${this.getCurrencyFlag(event.currency)} ${event.currency}</div>
                        </div>
                        <div class="event-forecast">
                            <span class="label">Pr√©v.</span>
                            <span class="value">${event.forecast}</span>
                        </div>
                        <div class="event-impact impact-${event.impact}">
                            ${event.impact.toUpperCase()}
                        </div>
                    `;
                    
                    liveEventsContainer.appendChild(eventElement);
                });
            }
            
            setupFilters() {
                const impactFilter = document.getElementById('impactFilter');
                const currencyFilter = document.getElementById('currencyFilter');
                const sourceFilter = document.getElementById('sourceFilter');
                
                [impactFilter, currencyFilter, sourceFilter].forEach(filter => {
                    if (filter) {
                        filter.addEventListener('change', () => this.applyFilters());
                    }
                });
            }
            
            applyFilters() {
                const impactFilter = document.getElementById('impactFilter').value;
                const currencyFilter = document.getElementById('currencyFilter').value;
                const sourceFilter = document.getElementById('sourceFilter').value;
                
                let filteredEvents = this.allEvents.filter(event => {
                    const impactMatch = impactFilter === 'all' || event.impact === impactFilter;
                    const currencyMatch = currencyFilter === 'all' || event.currency === currencyFilter;
                    const sourceMatch = sourceFilter === 'all' || event.source === sourceFilter;
                    return impactMatch && currencyMatch && sourceMatch;
                });
                
                this.renderTable(filteredEvents);
            }
            
            renderTable(events) {
                const calendarContainer = document.getElementById('economicCalendar');
                
                let html = `
                    <table class="economic-table">
                        <thead>
                            <tr>
                                <th>Date/Heure</th>
                                <th>Devise</th>
                                <th>√âv√©nement</th>
                                <th>Impact</th>
                                <th>Pr√©vision</th>
                                <th>Pr√©c√©dent</th>
                                <th>R√©sultat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                events.forEach(event => {
                    const impactIcon = event.impact === 'high' ? 'üî¥' : event.impact === 'medium' ? 'üü°' : 'üü¢';
                    const impactClass = `impact-${event.impact}`;
                    const isPastClass = event.isPast ? 'event-past' : 'event-upcoming';
                    const timeStatus = event.isPast ? '‚úì' : 'üïí';
                    
                    html += `
                        <tr class="event-row ${impactClass} ${isPastClass}">
                            <td class="event-datetime">
                                <div class="date">${event.dateFormatted}</div>
                                <div class="time">${timeStatus} ${event.time}</div>
                            </td>
                            <td class="event-currency">
                                <span class="currency-flag">${this.getCurrencyFlag(event.currency)}</span>
                                <strong>${event.currency}</strong>
                            </td>
                            <td class="event-name">
                                <div class="event-title">${event.event}</div>
                                ${event.isPast ? '<div class="event-status">‚úì Publi√©</div>' : '<div class="event-status">üïí √Ä venir</div>'}
                            </td>
                            <td class="event-impact">
                                <span class="impact-indicator ${impactClass}">
                                    ${impactIcon} ${event.impact.toUpperCase()}
                                </span>
                            </td>
                            <td class="event-forecast">${event.forecast}</td>
                            <td class="event-previous">${event.previous}</td>
                            <td class="event-result">
                                ${event.actual ? `
                                    <div class="actual-value ${this.getResultClass(event.actual, event.forecast)}">${event.actual}</div>
                                    <div class="market-impact ${event.marketImpact}">
                                        ${this.getMarketImpactIcon(event.marketImpact)} ${event.marketImpactText}
                                    </div>
                                ` : `<span class="pending">${event.isPast ? 'üîÑ Mise √† jour...' : 'üïí En attente'}</span>`}
                            </td>
                            <td class="event-actions">
                                <div class="action-buttons">
                                    <a href="https://www.investing.com/economic-calendar/" target="_blank" class="action-btn investing-btn" title="Voir sur Investing.com">
                                        <i class="fas fa-chart-line"></i>
                                    </a>
                                    <a href="https://www.forexfactory.com/calendar" target="_blank" class="action-btn factory-btn" title="Voir sur ForexFactory">
                                        <i class="fas fa-calendar-alt"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    <div class="table-footer">
                        <div class="events-count">
                            üìä ${events.length} √©v√©nement${events.length > 1 ? 's' : ''} affich√©${events.length > 1 ? 's' : ''}
                            ${events.filter(e => e.isPast).length > 0 ? `| ‚úÖ ${events.filter(e => e.isPast).length} publi√©${events.filter(e => e.isPast).length > 1 ? 's' : ''}` : ''}
                        </div>
                        <div class="sources-info">
                            <span>Sources officielles:</span>
                            <a href="https://www.investing.com/economic-calendar/" target="_blank" class="source-badge investing">
                                Investing.com
                            </a>
                            <a href="https://www.forexfactory.com/calendar" target="_blank" class="source-badge forexfactory">
                                ForexFactory
                            </a>
                        </div>
                        <div class="last-update">
                            üîÑ Mise √† jour: ${new Date().toLocaleTimeString()}
                            | üïí Prochaine: ${new Date(Date.now() + 300000).toLocaleTimeString()}
                        </div>
                        <div class="legend">
                            <span class="legend-title">L√©gende:</span>
                            <span class="legend-item">üìà Mieux que pr√©vu</span>
                            <span class="legend-item">üìâ Moins bien que pr√©vu</span>
                            <span class="legend-item">‚ö° Volatilit√©</span>
                            <span class="legend-item">‚û°Ô∏è Conforme</span>
                        </div>
                    </div>
                `;
                
                calendarContainer.innerHTML = html;
            }
            
            renderFallbackCalendar() {
                const calendarContainer = document.getElementById('economicCalendar');
                calendarContainer.innerHTML = `
                    <div class="real-calendar-links">
                        <h4>üìÖ Calendriers √âconomiques</h4>
                        <p>Filtres actifs: toutes devises - Impact tous</p>
                        
                        <a href="https://www.investing.com/economic-calendar/" target="_blank" class="calendar-link primary">
                            <div class="calendar-icon">üíº</div>
                            <div class="calendar-info">
                                <strong>Investing.com</strong>
                                <span>Calendrier complet avec tous les √©v√©nements</span>
                            </div>
                        </a>
                        
                        <a href="https://www.forexfactory.com/calendar" target="_blank" class="calendar-link">
                            <div class="calendar-icon">üè≠</div>
                            <div class="calendar-info">
                                <strong>Forex Factory</strong>
                                <span>Calendrier de r√©f√©rence pour le Forex</span>
                            </div>
                        </a>
                        
                        <div id="calendarLinksGrid"></div>
                    </div>
                `;
                
                // Initialiser les liens apr√®s un court d√©lai
                setTimeout(() => {
                    if (typeof updateCalendarLinks === 'function') {
                        updateCalendarLinks();
                    }
                }, 500);
            }
            
            getCurrencyFlag(currency) {
                const flags = {
                    'USD': 'üá∫üá∏', 'EUR': 'üá™üá∫', 'GBP': 'üá¨üáß', 'JPY': 'üáØüáµ',
                    'AUD': 'üá¶üá∫', 'CAD': 'üá®üá¶', 'CHF': 'üá®üá≠', 'NZD': 'üá≥üáø',
                    'XAU': 'ü•á', 'DAX': 'üá©üá™', 'NASDAQ': 'üá∫üá∏'
                };
                return flags[currency] || 'üè≥Ô∏è';
            }
            
            getMarketImpactIcon(impact) {
                const icons = {
                    'bullish': 'üìà',
                    'bearish': 'üìâ',
                    'neutral': '‚û°Ô∏è',
                    'volatile': '‚ö°'
                };
                return icons[impact] || '‚ùì';
            }
            
            getResultClass(actual, forecast) {
                if (!actual || !forecast) return '';
                
                const actualNum = parseFloat(actual.replace(/[+%KM,]/g, ''));
                const forecastNum = parseFloat(forecast.replace(/[+%KM,]/g, ''));
                
                if (actualNum > forecastNum) return 'result-better';
                if (actualNum < forecastNum) return 'result-worse';
                return 'result-equal';
            }

            analyzeAnnouncementImpact() {
                console.log('Analyze function called');
                const currency = document.getElementById('currencySelect')?.value || 'USD';
                const announcement = document.getElementById('announcementSelect')?.value || 'NFP';
                const result = parseFloat(document.getElementById('resultInput')?.value) || 2.5;
                const resultsContainer = document.getElementById('impactResults');
                
                console.log('Values:', currency, announcement, result);
                
                if (!resultsContainer) {
                    console.error('Results container not found');
                    return;
                }
                
                const impact = this.calculateImpact(currency, announcement, result);
                
                resultsContainer.innerHTML = `
                    <div class="impact-summary">
                        <h4>Analyse ${announcement} sur ${currency}</h4>
                        <div class="impact-stats">
                            <div class="stat-item">
                                <span class="stat-label">Impact Actuel:</span>
                                <span class="stat-value">${impact.currentImpact}%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Moyenne 24M:</span>
                                <span class="stat-value">${impact.historicalAvg}%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Pr√©diction:</span>
                                <span class="stat-value ${impact.direction === 'Hausse' ? 'positive' : impact.direction === 'Baisse' ? 'negative' : 'neutral'}">
                                    ${impact.direction}
                                </span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Confiance:</span>
                                <span class="stat-value">${impact.confidence}</span>
                            </div>
                        </div>
                        <div class="historical-chart">
                            <h5>Historique 12 derniers mois</h5>
                            <div class="chart-bars">
                                ${impact.history.map(item => `
                                    <div class="chart-bar">
                                        <div class="bar ${item.impact > 0 ? 'positive' : 'negative'}" 
                                             style="height: ${Math.abs(item.impact) * 20 + 10}px"
                                             title="${item.date}: ${item.impact}%">
                                        </div>
                                        <span class="bar-label">${item.date}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="impact-explanation">
                            <p><strong>Analyse:</strong> ${impact.explanation}</p>
                            <p><strong>Recommandation th√©orique:</strong> ${impact.prediction}</p>
                        </div>
                    </div>
                `;
            }
            
            calculateImpact(currency, announcement, result) {
                // G√©n√©rer historique 24 mois
                const history = this.generateHistoricalData(currency, announcement, 24);
                
                // Calculer tendance bas√©e sur l'historique
                const trend = this.analyzeTrend(history, result);
                const prediction = this.predictMarketDirection(history, result, currency, announcement);
                
                return {
                    currentImpact: (result * 0.1).toFixed(2),
                    historicalAvg: trend.average.toFixed(2),
                    direction: prediction.direction,
                    confidence: prediction.confidence,
                    prediction: prediction.text,
                    history: history.slice(-12), // 12 derniers mois
                    explanation: `Bas√© sur 24 mois: ${prediction.reasoning}`
                };
            }
            
            generateHistoricalData(currency, announcement, months) {
                const data = [];
                const basePatterns = {
                    'USD': { 'NFP': 0.8, 'CPI': -0.3, 'GDP': 0.5, 'RATE': 1.2 },
                    'EUR': { 'NFP': -0.4, 'CPI': 0.6, 'GDP': 0.3, 'RATE': 0.9 },
                    'GBP': { 'NFP': -0.3, 'CPI': 0.4, 'GDP': 0.4, 'RATE': 0.7 },
                    'JPY': { 'NFP': -0.5, 'CPI': -0.2, 'GDP': 0.2, 'RATE': -0.8 }
                };
                
                const base = basePatterns[currency]?.[announcement] || 0;
                
                for (let i = months; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const variation = (Math.random() - 0.5) * 1.5;
                    data.push({
                        date: date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' }),
                        impact: parseFloat((base + variation).toFixed(2)),
                        result: parseFloat((Math.random() * 5 + 1).toFixed(1))
                    });
                }
                return data;
            }
            
            analyzeTrend(history, currentResult) {
                const impacts = history.map(h => h.impact);
                const average = impacts.reduce((a, b) => a + b, 0) / impacts.length;
                const recent = impacts.slice(-6); // 6 derniers mois
                const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                
                return {
                    average: average,
                    recent: recentAvg,
                    isImproving: recentAvg > average,
                    volatility: this.calculateVolatility(impacts)
                };
            }
            
            predictMarketDirection(history, result, currency, announcement) {
                const trend = this.analyzeTrend(history, result);
                const currentImpact = result * 0.1;
                
                let direction, confidence, reasoning;
                
                if (currentImpact > trend.recent + 0.5) {
                    direction = 'Hausse';
                    confidence = 'Forte';
                    reasoning = `R√©sultat sup√©rieur √† la tendance r√©cente (+${(currentImpact - trend.recent).toFixed(2)}%)`;
                } else if (currentImpact < trend.recent - 0.5) {
                    direction = 'Baisse';
                    confidence = 'Forte';
                    reasoning = `R√©sultat inf√©rieur √† la tendance r√©cente (${(currentImpact - trend.recent).toFixed(2)}%)`;
                } else {
                    direction = 'Stabilit√©';
                    confidence = 'Mod√©r√©e';
                    reasoning = 'R√©sultat conforme aux attentes historiques';
                }
                
                return {
                    direction: direction,
                    confidence: confidence,
                    text: `${direction} probable (${confidence.toLowerCase()})`,
                    reasoning: reasoning
                };
            }
            
            calculateVolatility(values) {
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                return Math.sqrt(variance);
            }
            

            
            async loadFromBackup() {
                // Utiliser les derniers prix r√©els stock√©s
                const storedPrices = localStorage.getItem('realPrices');
                if (storedPrices) {
                    this.prices = JSON.parse(storedPrices);
                    this.updateConnectionStatus('üü° Cache R√©el', true);
                } else {
                    // Prix r√©els actuels du march√© (snapshot)
                    this.prices = {
                        'EUR/USD': '1.08420',
                        'GBP/USD': '1.26180', 
                        'USD/JPY': '149.250',
                        'AUD/USD': '0.67340',
                        'USD/CHF': '0.88650',
                        'NZD/USD': '0.62180',
                        'USD/CAD': '1.34820'
                    };
                    this.updateConnectionStatus('üî¥ Snapshot R√©el', false);
                }
            }

            async loadPricesFromBackup() {
                try {
                    // API gratuite alternative - ExchangeRate-API
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    const data = await response.json();
                    this.processPriceDataBackup(data);
                    this.updateConnectionStatus('üü° Backup API', true);
                } catch (error) {
                    console.error('Erreur API backup:', error);
                    this.generateMockData();
                    this.updateConnectionStatus('üî¥ Mode D√©mo', false);
                }
            }

            processPriceData(data) {
                const rates = data.rates;
                this.prices = {
                    'EUR/USD': (1 / rates.USD * rates.EUR).toFixed(5),
                    'GBP/USD': (1 / rates.USD * rates.GBP).toFixed(5),
                    'USD/JPY': (rates.JPY / rates.USD).toFixed(3),
                    'AUD/USD': (1 / rates.USD * rates.AUD).toFixed(5),
                    'USD/CHF': (rates.CHF / rates.USD).toFixed(5),
                    'NZD/USD': (1 / rates.USD * rates.NZD).toFixed(5),
                    'USD/CAD': (rates.CAD / rates.USD).toFixed(5)
                };
                this.renderPrices();
            }

            processPriceDataBackup(data) {
                const rates = data.rates;
                this.prices = {
                    'EUR/USD': (1 / rates.EUR).toFixed(5),
                    'GBP/USD': (1 / rates.GBP).toFixed(5),
                    'USD/JPY': rates.JPY.toFixed(3),
                    'AUD/USD': (1 / rates.AUD).toFixed(5),
                    'USD/CHF': rates.CHF.toFixed(5),
                    'NZD/USD': (1 / rates.NZD).toFixed(5),
                    'USD/CAD': rates.CAD.toFixed(5)
                };
                this.renderPrices();
            }

            async generateMockData() {
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    const data = await response.json();
                    
                    this.prices = {
                        'EUR/USD': (1 / data.rates.EUR).toFixed(5),
                        'GBP/USD': (1 / data.rates.GBP).toFixed(5),
                        'USD/JPY': data.rates.JPY.toFixed(3),
                        'AUD/USD': (1 / data.rates.AUD).toFixed(5),
                        'USD/CHF': data.rates.CHF.toFixed(5),
                        'NZD/USD': (1 / data.rates.NZD).toFixed(5),
                        'USD/CAD': data.rates.CAD.toFixed(5)
                    };
                    
                    localStorage.setItem('lastPrices', JSON.stringify(this.prices));
                    localStorage.setItem('lastUpdate', Date.now().toString());
                    
                } catch (error) {
                    const lastPrices = localStorage.getItem('lastPrices');
                    if (lastPrices) {
                        this.prices = JSON.parse(lastPrices);
                    }
                }
                this.renderPrices();
            }



            calculateCorrelations() {
                // Matrice de corr√©lation ICT bas√©e sur les √©tapes de trading
                const correlationMatrix = document.getElementById('correlationMatrix');
                correlationMatrix.innerHTML = '';

                // R√©cup√©rer les donn√©es des trades depuis Firebase/localStorage
                const tradeData = this.getTradeStepsData();
                
                // Cr√©er la matrice de corr√©lation ICT
                const matrix = document.createElement('div');
                matrix.className = 'ict-correlation-matrix';

                // Titre de la matrice
                const title = document.createElement('div');
                title.className = 'matrix-title';
                title.innerHTML = '<h3>üéØ Matrice de Corr√©lation ICT - √âtapes de Trading</h3>';
                matrix.appendChild(title);

                // √âtapes ICT
                const ictSteps = [
                    { key: 'contextGlobal', name: 'Contexte Global', icon: 'üåç' },
                    { key: 'zoneInstitutionnelle', name: 'Zone Institutionnelle', icon: 'üè¶' },
                    { key: 'structureMarche', name: 'Structure March√©', icon: 'üìä' },
                    { key: 'timingKillzones', name: 'Timing Killzones', icon: '‚è∞' },
                    { key: 'signalEntree', name: 'Signal Entr√©e', icon: 'üéØ' },
                    { key: 'riskManagement', name: 'Risk Management', icon: 'üõ°Ô∏è' },
                    { key: 'discipline', name: 'Discipline', icon: 'üß†' }
                ];

                // En-t√™te de la matrice
                const header = document.createElement('div');
                header.className = 'ict-correlation-row header';
                header.innerHTML = '<div class="ict-correlation-cell corner">√âtapes ICT</div>';
                ictSteps.forEach(step => {
                    header.innerHTML += `<div class="ict-correlation-cell header-cell">${step.icon}<br>${step.name}</div>`;
                });
                matrix.appendChild(header);

                // Lignes de donn√©es avec corr√©lations calcul√©es
                ictSteps.forEach((step1, i) => {
                    const row = document.createElement('div');
                    row.className = 'ict-correlation-row';
                    row.innerHTML = `<div class="ict-correlation-cell row-header">${step1.icon} ${step1.name}</div>`;
                    
                    ictSteps.forEach((step2, j) => {
                        let correlation;
                        if (i === j) {
                            correlation = 100; // Auto-corr√©lation parfaite
                        } else {
                            // Calculer la corr√©lation bas√©e sur les trades r√©els
                            correlation = this.calculateICTStepCorrelation(step1.key, step2.key, tradeData);
                        }
                        
                        const cell = document.createElement('div');
                        cell.className = `ict-correlation-cell data-cell ${this.getICTCorrelationClass(correlation)}`;
                        cell.innerHTML = `<div class="correlation-value">${correlation}%</div>`;
                        
                        // Ajouter tooltip avec d√©tails
                        cell.title = `Corr√©lation ${step1.name} ‚Üî ${step2.name}: ${correlation}%`;
                        
                        row.appendChild(cell);
                    });
                    
                    matrix.appendChild(row);
                });

                // Statistiques globales
                const stats = this.calculateICTStats(tradeData);
                const statsDiv = document.createElement('div');
                statsDiv.className = 'ict-stats';
                statsDiv.innerHTML = `
                    <div class="stats-row">
                        <div class="stat-item">
                            <span class="stat-label">üìä Trades Analys√©s:</span>
                            <span class="stat-value">${stats.totalTrades}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">‚úÖ √âtapes Compl√®tes:</span>
                            <span class="stat-value">${stats.completeSteps}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">üéØ Efficacit√© Globale:</span>
                            <span class="stat-value">${stats.globalEfficiency}%</span>
                        </div>
                    </div>
                `;
                matrix.appendChild(statsDiv);

                correlationMatrix.appendChild(matrix);
                
                // Ajouter un indicateur de derni√®re mise √† jour
                const updateIndicator = document.createElement('div');
                updateIndicator.className = 'update-indicator';
                updateIndicator.innerHTML = `
                    <small style="color: rgba(255, 255, 255, 0.6); text-align: center; display: block; margin-top: 10px;">
                        üîÑ Derni√®re mise √† jour: ${new Date().toLocaleTimeString()}
                        ${tradeData.hasData ? '| üìä Donn√©es en temps r√©el' : '| ‚ö†Ô∏è Aucune donn√©e de trading'}
                    </small>
                `;
                correlationMatrix.appendChild(updateIndicator);
            }

            getTradeStepsData() {
                try {
                    // R√©cup√©rer les donn√©es depuis localStorage (m√™me structure que le dashboard)
                    const firebaseUID = sessionStorage.getItem('firebaseUID');
                    if (!firebaseUID) return { trades: [], hasData: false };
                    
                    const savedData = localStorage.getItem(`dashboard_${firebaseUID}`);
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        return {
                            trades: data.trades || [],
                            hasData: true
                        };
                    }
                } catch (error) {
                    console.error('Erreur r√©cup√©ration donn√©es trades:', error);
                }
                return { trades: [], hasData: false };
            }

            calculateICTStepCorrelation(step1, step2, tradeData) {
                if (!tradeData.hasData || tradeData.trades.length === 0) {
                    return 0; // Pas de donn√©es = corr√©lation √† z√©ro
                }

                const trades = tradeData.trades.filter(t => t.confluences && t.confluences[step1] && t.confluences[step2]);
                
                if (trades.length === 0) {
                    return 0; // Pas de trades avec ces √©tapes = corr√©lation √† z√©ro
                }

                // Calculer la corr√©lation bas√©e sur les r√©sultats des trades
                let positiveCorrelation = 0;
                let totalComparisons = 0;

                trades.forEach(trade => {
                    const step1Value = this.getStepScore(trade.confluences[step1]);
                    const step2Value = this.getStepScore(trade.confluences[step2]);
                    const tradeResult = parseFloat(trade.pnl || 0) > 0 ? 1 : 0;

                    // Si les deux √©tapes sont bien ex√©cut√©es et le trade est gagnant
                    if (step1Value >= 0.7 && step2Value >= 0.7 && tradeResult === 1) {
                        positiveCorrelation++;
                    }
                    totalComparisons++;
                });

                const correlation = totalComparisons > 0 ? (positiveCorrelation / totalComparisons * 100) : 0;
                return Math.round(correlation);
            }

            getStepScore(stepValue) {
                return 0;
            }

            calculateICTStats(tradeData) {
                if (!tradeData.hasData || tradeData.trades.length === 0) {
                    return {
                        totalTrades: 0,
                        completeSteps: 0,
                        globalEfficiency: 0
                    };
                }

                const trades = tradeData.trades;
                const tradesWithSteps = trades.filter(t => t.confluences && Object.keys(t.confluences).length > 0);
                
                let totalStepsCompleted = 0;
                let totalPossibleSteps = 0;
                let winningTradesWithCompleteSteps = 0;

                tradesWithSteps.forEach(trade => {
                    const stepCount = Object.keys(trade.confluences).length;
                    totalStepsCompleted += stepCount;
                    totalPossibleSteps += 7; // 7 √©tapes ICT
                    
                    if (stepCount === 7 && parseFloat(trade.pnl || 0) > 0) {
                        winningTradesWithCompleteSteps++;
                    }
                });

                const completeSteps = totalPossibleSteps > 0 ? Math.round((totalStepsCompleted / totalPossibleSteps) * 100) : 0;
                const globalEfficiency = tradesWithSteps.length > 0 ? Math.round((winningTradesWithCompleteSteps / tradesWithSteps.length) * 100) : 0;

                return {
                    totalTrades: trades.length,
                    completeSteps,
                    globalEfficiency
                };
            }

            // Fonction pour surveiller les changements de donn√©es
            watchForDataChanges() {
                const firebaseUID = sessionStorage.getItem('firebaseUID');
                if (!firebaseUID) return;
                
                let lastDataHash = '';
                
                setInterval(() => {
                    try {
                        const savedData = localStorage.getItem(`dashboard_${firebaseUID}`);
                        if (savedData) {
                            const currentHash = this.hashCode(savedData);
                            if (currentHash !== lastDataHash) {
                                lastDataHash = currentHash;
                                this.calculateCorrelations(); // Recalculer automatiquement
                                console.log('üîÑ Donn√©es de trading mises √† jour - Matrice ICT recalcul√©e');
                            }
                        }
                    } catch (error) {
                        console.error('Erreur surveillance donn√©es:', error);
                    }
                }, 5000); // V√©rifier toutes les 5 secondes
            }
            
            hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return hash;
            }

            getICTCorrelationClass(value) {
                if (value >= 80) return 'ict-excellent';
                if (value >= 60) return 'ict-good';
                if (value >= 40) return 'ict-average';
                if (value >= 20) return 'ict-poor';
                return 'ict-none';
            }


            

            
            getInstrumentIcon(type) {
                const icons = {
                    'forex': 'üí±',
                    'commodity': 'ü•á',
                    'index': 'üìà'
                };
                return icons[type] || 'üìä';
            }
            


            updateSessions() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentDay = now.getDay();
                
                // Test : forcer au moins Londres ouverte entre 8h-17h
                const sessions = [
                    { id: 'sydney', start: 22, end: 7, name: 'Sydney' },
                    { id: 'tokyo', start: 1, end: 10, name: 'Tokyo' },
                    { id: 'london', start: 8, end: 17, name: 'Londres' },
                    { id: 'newyork', start: 14, end: 23, name: 'New York' }
                ];

                sessions.forEach(session => {
                    const status = document.getElementById(`${session.id}-status`);
                    const volume = document.getElementById(`${session.id}-volume`);
                    
                    if (!status || !volume) return;
                    
                    // Test simple : Londres toujours ouverte pour d√©boguer
                    if (session.id === 'london') {
                        status.textContent = 'Ouverte';
                        status.className = 'session-status active';
                        volume.textContent = `Test: ${currentHour}h`;
                    } else {
                        status.textContent = 'Ferm√©e';
                        status.className = 'session-status';
                        volume.textContent = 'Test: Ferm√©';
                    }
                });
            }
            
            updateGlobalMarketStatus(isWeekend) {
                const statusElement = document.getElementById('connectionStatus');
                if (statusElement) {
                    if (isWeekend) {
                        statusElement.textContent = 'üî¥ March√© Forex Ferm√© (Weekend)';
                        statusElement.style.color = '#ff6b6b';
                    } else {
                        const now = new Date();
                        const currentHour = now.getHours();
                        const anySessionActive = this.isAnySessionActive(currentHour);
                        
                        if (anySessionActive) {
                            statusElement.textContent = 'üü¢ March√© Forex Ouvert';
                            statusElement.style.color = '#4ecdc4';
                        } else {
                            statusElement.textContent = 'üü° Entre Sessions';
                            statusElement.style.color = '#ffc107';
                        }
                    }
                }
            }
            
            isAnySessionActive(currentHour) {
                const sessions = [
                    { start: 22, end: 7 },   // Sydney
                    { start: 1, end: 10 },   // Tokyo
                    { start: 8, end: 17 },   // Londres
                    { start: 14, end: 23 }   // New York
                ];
                
                return sessions.some(session => 
                    this.isSessionActive(currentHour, session.start, session.end)
                );
            }

            isSessionActive(currentHour, start, end) {
                // G√©rer les sessions qui traversent minuit (comme Sydney)
                if (start <= end) {
                    return currentHour >= start && currentHour < end;
                } else {
                    return currentHour >= start || currentHour < end;
                }
            }

            updateConnectionStatus(status, isConnected) {
                // Fonction conserv√©e pour compatibilit√© mais ne fait plus rien
            }
            
            updateTimeDisplay() {
                // Fonction conserv√©e pour compatibilit√© mais ne fait plus rien
            }

            startRealTimeUpdates() {
                // Mise √† jour des sessions toutes les 30 secondes
                setInterval(() => {
                    this.updateSessions();
                }, 30000);
                
                // Mise √† jour du calendrier toutes les 5 minutes
                setInterval(() => {
                    this.loadEconomicCalendar();
                }, 300000);
                
                // D√©marrer imm√©diatement
                this.updateSessions();
            }
            
            updatePastEvents() {
                // Recharger le calendrier pour mettre √† jour les r√©sultats des √©v√©nements pass√©s
                this.loadEconomicCalendar();
            }
        }

        // Fonctions globales
        function testAnalyze() {
            const currency = document.getElementById('currencySelect').value;
            const announcement = document.getElementById('announcementSelect').value;
            const result = parseFloat(document.getElementById('resultInput').value) || 2.5;
            
            document.getElementById('impactResults').innerHTML = `
                <div class="impact-summary">
                    <h4>Test ${announcement} sur ${currency}</h4>
                    <p>R√©sultat: ${result}% ‚Üí Impact estim√©: ${(result * 0.1).toFixed(2)}%</p>
                </div>
            `;
        }
        

        
        window.calculatePosition = function() {
            const balance = parseFloat(document.getElementById('accountBalance').value) || 0;
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 0;
            const entryPrice = parseFloat(document.getElementById('entryPrice').value) || 0;
            const stopLoss = parseFloat(document.getElementById('stopLoss').value) || 0;
            const takeProfit = parseFloat(document.getElementById('takeProfit').value) || 0;
            const pair = document.getElementById('currencyPair').value;
            
            if (!balance || !riskPercent || !entryPrice || !stopLoss) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            // Calculs
            const riskAmount = (balance * riskPercent) / 100;
            const isJPY = pair.includes('JPY');
            const pipValue = isJPY ? 0.01 : 0.0001;
            
            const riskPips = Math.abs(entryPrice - stopLoss) / pipValue;
            const rewardPips = takeProfit ? Math.abs(takeProfit - entryPrice) / pipValue : 0;
            
            // V√©rifier la coh√©rence du trade
            const isLong = entryPrice < takeProfit;
            const isShort = entryPrice > takeProfit;
            if (takeProfit && ((isLong && stopLoss >= entryPrice) || (isShort && stopLoss <= entryPrice))) {
                alert('Erreur: V√©rifiez la coh√©rence Entry/SL/TP');
                return;
            }
            const rrRatio = rewardPips > 0 ? (rewardPips / riskPips).toFixed(2) : 'N/A';
            
            // Calcul taille de position pr√©cis
            const pipValuePerLot = isJPY ? 1000 : 10;
            let lots = riskAmount / (riskPips * pipValuePerLot);
            lots = Math.max(0.01, Math.round(lots * 100) / 100);
            const positionSize = lots * 100000;
            
            // Recalculer le risk r√©el avec la taille ajust√©e
            const actualRiskAmount = lots * riskPips * pipValuePerLot;
            const potentialProfit = takeProfit ? (rewardPips * pipValuePerLot * lots) : 0;
            
            // Afficher les r√©sultats pr√©cis
            document.getElementById('positionSize').textContent = `${lots.toFixed(2)} lots (${Math.round(positionSize).toLocaleString()} unit√©s)`;
            document.getElementById('riskAmount').textContent = `$${actualRiskAmount.toFixed(2)}`;
            document.getElementById('riskPips').textContent = `${riskPips.toFixed(1)} pips`;
            document.getElementById('rewardPips').textContent = rewardPips > 0 ? `${rewardPips.toFixed(1)} pips` : 'N/A';
            document.getElementById('rrRatio').textContent = rrRatio !== 'N/A' ? `${rrRatio}:1` : 'N/A';
            document.getElementById('potentialProfit').textContent = potentialProfit > 0 ? `$${potentialProfit.toFixed(2)}` : 'N/A';
            
            // Animation des r√©sultats
            const results = document.querySelectorAll('.result-value');
            results.forEach(result => {
                result.style.animation = 'none';
                setTimeout(() => {
                    result.style.animation = 'pulse 0.5s ease-in-out';
                }, 10);
            });
        };
        
            setupImpactAnalyzer() {
                // Test direct
            }


        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            window.forexData = new RealTimeForexData();
            
            // Initialiser l'historique avec les vraies donn√©es
            setTimeout(() => {
                updateHistoryChart();
            }, 2000);
            

            
            // Boutons de rafra√Æchissement
            const refreshCalendar = document.getElementById('refreshCalendar');
            if (refreshCalendar) {
                refreshCalendar.addEventListener('click', () => {
                    window.forexData.loadEconomicCalendar();
                    const originalHTML = refreshCalendar.innerHTML;
                    refreshCalendar.innerHTML = '<i class="fas fa-check" style="color: #4ecdc4;"></i>';
                    setTimeout(() => {
                        refreshCalendar.innerHTML = originalHTML;
                    }, 1000);
                });
            }
            

        });
    </script>

    <style>
        .status-indicator {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            font-size: 0.85em;
            flex-wrap: wrap;
        }
        
        #firebaseStatus {
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .price-card {
            background: linear-gradient(135deg, rgba(30, 34, 45, 0.95), rgba(20, 25, 35, 0.95));
            border: 2px solid rgba(0, 212, 255, 0.4);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .price-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 212, 255, 0.6);
        }

        .price-pair {
            font-size: 1.2em;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 10px;
        }

        .price-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffffff;
            margin: 10px 0;
        }

        .price-change {
            font-size: 1em;
            font-weight: bold;
        }

        .price-change.positive {
            color: #4ecdc4;
        }

        .price-change.negative {
            color: #ff6b6b;
        }

        .session-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .session-status.active {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }

        .session-status.weekend {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .session-card.weekend {
            opacity: 0.6;
            border-color: rgba(255, 107, 107, 0.3);
        }

        .session-card.weekend .session-header i {
            color: #ff6b6b;
        }

        /* Anciens styles de corr√©lation - gard√©s pour compatibilit√© */
        .correlation-table {
            display: none; /* Masqu√© car remplac√© par la matrice ICT */
        }

        .trend-timeframe {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        
        .trend-reason {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
            font-style: italic;
        }
        
        .trend-source {
            font-size: 0.7em;
            color: rgba(0, 212, 255, 0.8);
            margin-top: 3px;
            font-weight: bold;
        }
        
        .trend-update {
            font-size: 0.65em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 2px;
            font-style: italic;
        }

        /* Styles pour la matrice de corr√©lation ICT */
        .ict-correlation-matrix {
            background: linear-gradient(135deg, rgba(30, 34, 45, 0.95), rgba(20, 25, 35, 0.95));
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(0, 212, 255, 0.3);
        }

        .matrix-title {
            text-align: center;
            margin-bottom: 20px;
            color: #00d4ff;
            font-size: 1.2em;
        }

        .ict-correlation-row {
            display: grid;
            grid-template-columns: 200px repeat(7, 1fr);
            gap: 3px;
            margin-bottom: 3px;
        }

        .ict-correlation-cell {
            padding: 12px 8px;
            text-align: center;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .ict-correlation-cell.corner {
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
            color: white;
            font-size: 1em;
        }

        .ict-correlation-cell.header-cell {
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
            color: white;
            font-size: 0.75em;
            line-height: 1.2;
        }

        .ict-correlation-cell.row-header {
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
            color: white;
            text-align: left;
            padding-left: 15px;
            font-size: 0.8em;
        }

        .ict-correlation-cell.data-cell {
            cursor: pointer;
            position: relative;
        }

        .ict-correlation-cell.data-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }

        .correlation-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        /* Classes de corr√©lation ICT */
        .ict-correlation-cell.ict-excellent {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .ict-correlation-cell.ict-good {
            background: linear-gradient(135deg, #5b86e5, #4a90e2);
            color: white;
        }

        .ict-correlation-cell.ict-average {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #000;
        }

        .ict-correlation-cell.ict-poor {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .ict-correlation-cell.ict-none {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            border: 2px dashed rgba(255, 255, 255, 0.2);
        }

        /* Statistiques ICT */
        .ict-stats {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #00d4ff;
        }

        /* Responsive pour la matrice ICT */
        @media (max-width: 1200px) {
            .ict-correlation-row {
                grid-template-columns: 150px repeat(7, 1fr);
            }
            
            .ict-correlation-cell {
                font-size: 0.75em;
                padding: 8px 4px;
                min-height: 50px;
            }
            
            .economic-table {
                font-size: 0.85em;
            }
            
            .table-footer {
                flex-direction: column;
                text-align: center;
            }
        }

        @media (max-width: 768px) {
            .ict-correlation-row {
                grid-template-columns: 120px repeat(7, 1fr);
            }
            
            .ict-correlation-cell {
                font-size: 0.65em;
                padding: 6px 2px;
                min-height: 40px;
            }
            
            .stats-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .economic-table {
                font-size: 0.75em;
            }
            
            .economic-table th,
            .economic-table td {
                padding: 8px 5px;
            }
            
            .event-name {
                max-width: 150px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* Indicateur de mise √† jour */
        .update-indicator {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Styles pour les filtres du calendrier */
        .calendar-filters {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            color: #00d4ff;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(0, 212, 255, 0.4);
            background: rgba(30, 34, 45, 0.95);
            color: white;
            font-size: 0.9em;
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
        }
        
        /* Fallback pour calendrier indisponible */
        .calendar-fallback {
            text-align: center;
            padding: 40px 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
        }
        
        .calendar-redirect h4 {
            color: #00d4ff;
            margin-bottom: 15px;
        }
        
        .main-calendar-link {
            display: block;
            margin: 15px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(91, 134, 229, 0.2));
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 12px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .main-calendar-link:hover {
            transform: translateY(-3px);
            border-color: #00d4ff;
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
        }
        
        .main-calendar-link i {
            font-size: 2em;
            color: #00d4ff;
            margin-bottom: 10px;
        }
        
        .main-calendar-link span {
            display: block;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .main-calendar-link small {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }
        
        .myfxbook-calendar {
            background: rgba(30, 34, 45, 0.95);
            border-radius: 10px;
            padding: 10px;
            border: 2px solid rgba(0, 212, 255, 0.3);
        }
        
        .myfxbook-calendar iframe {
            border-radius: 8px;
            background: white;
        }
        
        .calendar-footer {
            text-align: center;
            margin-top: 10px;
        }
        
        .calendar-source-link {
            color: #00d4ff;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .calendar-source-link:hover {
            color: white;
        }
        
        .calendar-source-link i {
            margin-right: 5px;
        }
        
        .real-calendar-links {
            text-align: center;
            padding: 30px;
            background: rgba(30, 34, 45, 0.95);
            border-radius: 15px;
            border: 2px solid rgba(0, 212, 255, 0.3);
        }
        
        .real-calendar-links h4 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .real-calendar-links p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 25px;
        }
        
        .calendar-link {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(30, 34, 45, 0.95), rgba(20, 25, 35, 0.95));
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .calendar-link:hover {
            transform: translateY(-3px);
            border-color: #00d4ff;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
        }
        
        .calendar-link.primary {
            border-color: rgba(0, 212, 255, 0.6);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(91, 134, 229, 0.1));
        }
        
        .calendar-icon {
            font-size: 2.5em;
            margin-right: 20px;
            min-width: 60px;
        }
        
        .calendar-info {
            text-align: left;
        }
        
        .calendar-info strong {
            display: block;
            font-size: 1.2em;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        
        .calendar-info span {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }
        
        /* Styles pour √©v√©nements √©conomiques live */
        .economic-events-live {
            background: rgba(30, 34, 45, 0.95);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(0, 212, 255, 0.3);
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: #4ecdc4;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .events-container {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .live-event {
            background: rgba(0, 0, 0, 0.3);
            border-left: 4px solid #00d4ff;
            padding: 15px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 80px 1fr 100px 80px;
            gap: 15px;
            align-items: center;
        }
        
        .live-event.high-impact {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }
        
        .event-time {
            font-weight: bold;
            color: #00d4ff;
            text-align: center;
        }
        
        .event-details h4 {
            color: white;
            margin-bottom: 5px;
            font-size: 1em;
        }
        
        .event-details .currency {
            color: #ffc107;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .event-forecast {
            text-align: center;
            font-size: 0.9em;
        }
        
        .event-forecast .label {
            color: rgba(255, 255, 255, 0.6);
            display: block;
            font-size: 0.8em;
        }
        
        .event-forecast .value {
            color: #00d4ff;
            font-weight: bold;
        }
        
        .event-impact {
            text-align: center;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .impact-high {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .impact-medium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .external-sources {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .source-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .source-links a {
            color: #00d4ff;
            text-decoration: none;
            padding: 8px 15px;
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 20px;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .source-links a:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: translateY(-2px);
        }
        


        /* Animation pour le bouton de rafra√Æchissement */
        .refresh-btn {
            transition: all 0.3s ease;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #00d4ff;
            font-size: 1.2em;
        }

        .refresh-btn:hover {
            transform: rotate(180deg);
            color: #00d4ff;
            background: rgba(0, 212, 255, 0.3);
        }
        
        /* Styles pour les √©v√©nements pass√©s et √† venir */
        .event-row.event-past {
            background: rgba(255, 255, 255, 0.05);
            opacity: 0.8;
        }
        
        .event-row.event-upcoming {
            background: rgba(0, 212, 255, 0.05);
            border-left: 3px solid #00d4ff;
        }
        
        .event-status {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 3px;
        }
        
        .event-past .event-status {
            color: #4ecdc4;
        }
        
        .event-upcoming .event-status {
            color: #00d4ff;
        }
        
        /* Styles pour les r√©sultats */
        .actual-value.result-better {
            color: #4ecdc4;
            font-weight: bold;
        }
        
        .actual-value.result-worse {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .actual-value.result-equal {
            color: #ffc107;
            font-weight: bold;
        }
        
        .pending {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }
        
        /* Animation pour les prix en temps r√©el */
        .price-card {
            transition: all 0.3s ease;
        }
        
        .price-card.updating {
            animation: priceUpdate 0.5s ease-in-out;
        }
        
        @keyframes priceUpdate {
            0% { transform: scale(1); border-color: rgba(0, 212, 255, 0.4); }
            50% { transform: scale(1.02); border-color: rgba(0, 212, 255, 0.8); }
            100% { transform: scale(1); border-color: rgba(0, 212, 255, 0.4); }
        }
        
        /* Indicateur de mise √† jour temps r√©el */
        .status-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Loading pour calendrier */
        .loading-calendar {
            text-align: center;
            padding: 40px;
            color: #00d4ff;
            font-size: 1.1em;
            animation: pulse 1.5s infinite;
        }
        
        /* Styles pour le calculateur */
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }
        
        .calculator-card, .results-card {
            background: linear-gradient(135deg, rgba(30, 34, 45, 0.95), rgba(20, 25, 35, 0.95));
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 15px;
            padding: 20px;
        }
        
        .calculator-form {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1em;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        .calculate-btn {
            padding: 15px;
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        
        .results-grid {
            display: grid;
            gap: 15px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid #00d4ff;
        }
        
        .result-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }
        
        .result-value {
            color: #00d4ff;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        /* Styles pour l'analyseur d'impact */
        .impact-analyzer {
            background: linear-gradient(135deg, rgba(30, 34, 45, 0.95), rgba(20, 25, 35, 0.95));
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .analyzer-controls {
            display: flex;
            gap: 20px;
            align-items: end;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            color: #00d4ff;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .control-group select,
        .control-group input {
            padding: 10px 15px;
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1em;
            min-width: 150px;
        }
        
        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
        }
        
        .analyze-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        
        .impact-results {
            min-height: 200px;
            margin-top: 20px;
        }
        
        .impact-explanation {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #00d4ff;
        }
        
        .impact-explanation p {
            margin: 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95em;
        }
        
        .impact-summary h4 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .impact-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
        }
        
        .stat-value.positive {
            color: #4ecdc4;
        }
        
        .stat-value.negative {
            color: #ff6b6b;
        }
        
        .stat-value.neutral {
            color: #ffc107;
        }
        
        .historical-data h5 {
            color: #00d4ff;
            margin-bottom: 15px;
        }
        
        .reaction-bars {
            display: grid;
            gap: 8px;
        }
        
        .reaction-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }
        
        .reaction-date {
            min-width: 60px;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .reaction-visual {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .bar {
            height: 6px;
            border-radius: 3px;
            min-width: 2px;
        }
        
        .bar.positive {
            background: #4ecdc4;
        }
        
        .bar.negative {
            background: #ff6b6b;
        }
        
        .reaction-value {
            font-size: 0.9em;
            font-weight: bold;
            min-width: 50px;
        }
        
        .history-card {
            background: linear-gradient(135deg, rgba(30, 34, 45, 0.95), rgba(20, 25, 35, 0.95));
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 15px;
            padding: 25px;
        }
        
        .trend-chart {
            position: relative;
            height: 100px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .chart-point {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .point {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-bottom: 5px;
        }
        
        .point.positive {
            background: #4ecdc4;
        }
        
        .point.negative {
            background: #ff6b6b;
        }
        
        .point-label {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.6);
            position: absolute;
            top: 25px;
            left: -15px;
            width: 30px;
            text-align: center;
        }
        
        .chart-summary {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00d4ff;
        }
        
        .chart-summary p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .historical-chart {
            margin: 20px 0;
        }
        
        .historical-chart h5 {
            color: #00d4ff;
            margin-bottom: 15px;
        }
        
        .line-chart {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin: 20px 0;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-table th {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 12px;
            text-align: center;
            font-weight: bold;
        }
        
        .data-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .positive-row {
            background: rgba(78, 205, 196, 0.1);
        }
        
        .negative-row {
            background: rgba(255, 107, 107, 0.1);
        }
        
        .impact-cell.positive {
            color: #4ecdc4;
            font-weight: bold;
        }
        
        .impact-cell.negative {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .chart-bars {
            display: flex;
            align-items: end;
            gap: 8px;
            height: 120px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .chart-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
        }
        
        .bar {
            width: 20px;
            border-radius: 2px 2px 0 0;
            margin-bottom: 5px;
        }
        
        .bar.positive {
            background: linear-gradient(to top, #4ecdc4, #44a08d);
        }
        
        .bar.negative {
            background: linear-gradient(to top, #ff6b6b, #ee5a52);
        }
        
        .bar-label {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.6);
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        /* Styles pour l'historique */
        .history-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .history-controls select {
            padding: 8px 12px;
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 0.9em;
        }
        
        .history-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .history-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 3px solid #00d4ff;
        }
        
        .stat-box .stat-label {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8em;
            margin-bottom: 8px;
        }
        
        .stat-box .stat-value {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .timeline-chart h4 {
            color: #00d4ff;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .timeline-point {
            position: absolute;
            bottom: 0;
            transform: translateX(-50%);
        }
        
        .timeline-point .point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }
        
        .timeline-point .point.positive {
            background: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }
        
        .timeline-point .point.negative {
            background: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        
        .point-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            font-weight: bold;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .timeline-point:hover .point-value {
            opacity: 1;
        }
        
        .point-date {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            font-size: 0.6em;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
        }
        
        .chart-axis {
            position: absolute;
            left: 10px;
            top: 0;
            height: 100%;
            width: 2px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .axis-label {
            position: absolute;
            left: -30px;
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .trend-analysis {
            background: rgba(0, 212, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #00d4ff;
            margin-top: 20px;
        }
        
        .trend-analysis h5 {
            color: #00d4ff;
            margin-bottom: 15px;
        }
        
        .trend-analysis p {
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .analyzer-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group select {
                min-width: auto;
            }
            
            .impact-stats {
                grid-template-columns: 1fr;
            }
            
            .history-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .history-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* Animation pulse pour les r√©sultats */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .card-header h3 {
            color: #00d4ff;
            font-size: 1.3em;
            margin: 0;
        }
        
        .correlation-card {
            background: linear-gradient(135deg, rgba(30, 34, 45, 0.95), rgba(20, 25, 35, 0.95));
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .correlation-card:hover {
            border-color: rgba(0, 212, 255, 0.6);
            transform: translateY(-2px);
        }
        
        /* Styles pour le tableau √©conomique */
        .economic-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(30, 34, 45, 0.95);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .economic-table th {
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .economic-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            vertical-align: middle;
        }
        
        .event-datetime {
            text-align: left !important;
        }
        
        .event-datetime .date {
            font-weight: bold;
            color: #00d4ff;
            font-size: 0.9em;
        }
        
        .event-datetime .time {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8em;
            margin-top: 2px;
        }
        
        .event-currency {
            font-weight: bold;
        }
        
        .currency-flag {
            margin-right: 5px;
            font-size: 1.2em;
        }
        
        .event-name {
            text-align: left !important;
            max-width: 200px;
        }
        
        .event-title {
            font-weight: bold;
            color: white;
            font-size: 0.9em;
        }
        
        .impact-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }
        
        .impact-high {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .impact-medium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .impact-low {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }
        
        .market-impact {
            font-size: 0.8em;
            margin-top: 3px;
            font-weight: bold;
        }
        
        .market-impact.bullish {
            color: #4ecdc4;
        }
        
        .market-impact.bearish {
            color: #ff6b6b;
        }
        
        .market-impact.neutral {
            color: #ffc107;
        }
        
        .market-impact.volatile {
            color: #ff9800;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .action-btn {
            padding: 6px 8px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }
        
        .investing-btn {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.4);
        }
        
        .factory-btn {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
            border: 1px solid rgba(78, 205, 196, 0.4);
        }
        
        .action-btn:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }
        
        .table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 0.85em;
        }
        
        .events-count {
            color: #00d4ff;
            font-weight: bold;
        }
        
        .sources-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .source-badge {
            padding: 4px 8px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .source-badge.investing {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.4);
        }
        
        .source-badge.forexfactory {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
            border: 1px solid rgba(78, 205, 196, 0.4);
        }
        
        .source-badge:hover {
            transform: scale(1.05);
            opacity: 0.8;
        }
        
        .last-update {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .legend {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .legend-title {
            font-weight: bold;
            color: #00d4ff;
        }
        
        .legend-item {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Style pour le bouton VIP */
        .vip-link {
            background: linear-gradient(135deg, #00d4ff, #5b86e5) !important;
            color: white !important;
            padding: 8px 16px !important;
            border-radius: 20px !important;
            font-weight: bold !important;
            text-decoration: none !important;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3) !important;
            transition: all 0.3s ease !important;
        }
        
        .vip-link:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.5) !important;
        }
        .calendar-redirect-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .calendar-notice {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .calendar-notice p {
            margin: 5px 0;
            color: #ffc107;
            font-size: 0.9em;
        }
        
        .data-manager-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-left: 15px;
        }
        
        .data-manager-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(30, 34, 45, 0.95), rgba(20, 25, 35, 0.95));
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            color: #00d4ff;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .save-btn, .clear-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
        }
        
        .clear-btn {
            background: #6c757d;
            color: white;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }
        
        .data-actions {
            display: flex;
            gap: 5px;
        }
        
        .edit-btn, .delete-btn {
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .edit-btn {
            background: #ffc107;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
        }
    </style>
    
    <script>
        // Mise √† jour des sessions de trading
        function updateTradingSessions() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentDay = now.getDay();
            
            const isWeekend = currentDay === 0 || currentDay === 6;
            
            const sessions = [
                { id: 'sydney', start: 22, end: 7 },
                { id: 'tokyo', start: 1, end: 10 },
                { id: 'london', start: 8, end: 17 },
                { id: 'newyork', start: 14, end: 23 }
            ];
            
            sessions.forEach(session => {
                const status = document.getElementById(`${session.id}-status`);
                
                if (!status) return;
                
                let isActive = false;
                if (session.start <= session.end) {
                    isActive = currentHour >= session.start && currentHour < session.end;
                } else {
                    isActive = currentHour >= session.start || currentHour < session.end;
                }
                
                if (isWeekend) {
                    status.textContent = 'Weekend';
                    status.className = 'session-status weekend';
                } else if (isActive) {
                    status.textContent = 'Ouverte';
                    status.className = 'session-status active';
                } else {
                    status.textContent = 'Ferm√©e';
                    status.className = 'session-status';
                }
            });
        }
        
        setTimeout(() => {
            updateTradingSessions();
            setInterval(updateTradingSessions, 30000);
        }, 1000);
        // Fonction pour mettre √† jour les liens de calendrier
        // Gestionnaire de donn√©es
        window.openDataManager = function() {
            const modal = document.createElement('div');
            modal.className = 'data-manager-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üìÖ Gestionnaire de Donn√©es</h3>
                        <button onclick="closeDataManager()" class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="data-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date:</label>
                                    <input type="date" id="dataDate" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>Devise:</label>
                                    <select id="dataDevise">
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="GBP">GBP</option>
                                        <option value="JPY">JPY</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Annonce:</label>
                                    <select id="dataAnnonce">
                                        <option value="NFP">NFP</option>
                                        <option value="CPI">CPI</option>
                                        <option value="GDP">GDP</option>
                                        <option value="RATE">RATE</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>R√©sultat (%):</label>
                                    <input type="number" id="dataResult" step="0.1" placeholder="2.5">
                                </div>
                                <div class="form-group">
                                    <label>Consensus (%):</label>
                                    <input type="number" id="dataConsensus" step="0.1" placeholder="2.3">
                                </div>
                                <div class="form-group">
                                    <label>Pr√©c√©dent (%):</label>
                                    <input type="number" id="dataPrevious" step="0.1" placeholder="2.1">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button onclick="saveDataEntry()" class="save-btn">üíæ Sauvegarder</button>
                                <button onclick="clearDataForm()" class="clear-btn">üóëÔ∏è Effacer</button>
                            </div>
                        </div>
                        
                        <div class="data-list">
                            <h4>üìà Donn√©es Existantes</h4>
                            <div id="dataListContainer"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadDataList();
        };
        
        window.closeDataManager = function() {
            const modal = document.querySelector('.data-manager-modal');
            if (modal) modal.remove();
        };
        
        window.saveDataEntry = function() {
            const date = document.getElementById('dataDate').value;
            const devise = document.getElementById('dataDevise').value;
            const annonce = document.getElementById('dataAnnonce').value;
            const result = parseFloat(document.getElementById('dataResult').value);
            const consensus = parseFloat(document.getElementById('dataConsensus').value);
            const previous = parseFloat(document.getElementById('dataPrevious').value);
            
            if (!result || !consensus || !previous) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            addHistoricalDataWithDate(devise, annonce, result, consensus, previous, date);
            clearDataForm();
            loadDataList();
            updateHistoryChart();
        };
        
        window.clearDataForm = function() {
            document.getElementById('dataResult').value = '';
            document.getElementById('dataConsensus').value = '';
            document.getElementById('dataPrevious').value = '';
        };
        
        window.loadDataList = function() {
            const container = document.getElementById('dataListContainer');
            let html = '';
            
            Object.keys(HISTORICAL_DATA).forEach(currency => {
                Object.keys(HISTORICAL_DATA[currency]).forEach(announcement => {
                    const data = HISTORICAL_DATA[currency][announcement];
                    data.forEach((item, index) => {
                        html += `
                            <div class="data-item">
                                <div class="data-info">
                                    <strong>${currency} ${announcement}</strong> - ${item.date}
                                    <br>R√©sultat: ${item.result}% | Impact: ${item.impact > 0 ? '+' : ''}${item.impact}%
                                </div>
                                <div class="data-actions">
                                    <button onclick="editDataItem('${currency}', '${announcement}', ${index})" class="edit-btn">‚úèÔ∏è</button>
                                    <button onclick="deleteDataItem('${currency}', '${announcement}', ${index})" class="delete-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                });
            });
            
            container.innerHTML = html || '<p>Aucune donn√©e enregistr√©e</p>';
        };
        
        window.deleteDataItem = function(currency, announcement, index) {
            if (confirm('Supprimer cette donn√©e ?')) {
                HISTORICAL_DATA[currency][announcement].splice(index, 1);
                saveToFirebase();
                localStorage.setItem('historicalData', JSON.stringify(HISTORICAL_DATA));
                loadDataList();
                updateHistoryChart();
            }
        };
        
        window.updateCalendarLinks = function() {
            const impact = document.getElementById('impactFilter')?.value || 'all';
            const currency = document.getElementById('currencyFilter')?.value || 'all';
            const statusElement = document.getElementById('filterStatus');
            
            if (statusElement) {
                const impactText = impact === 'all' ? 'tous' : impact;
                const currencyText = currency === 'all' ? 'toutes devises' : currency;
                statusElement.textContent = `Filtres actifs: ${currencyText} - Impact ${impactText}`;
            }
            
            // Mettre √† jour les textes des liens
            const investingText = document.getElementById('investingText');
            const forexFactoryText = document.getElementById('forexFactoryText');
            
            if (investingText) {
                investingText.textContent = `Calendrier ${currency === 'all' ? 'toutes devises' : currency} - Impact ${impact === 'all' ? 'tous' : impact}`;
            }
            if (forexFactoryText) {
                forexFactoryText.textContent = `Calendrier ${currency === 'all' ? 'toutes devises' : currency} - Impact ${impact === 'all' ? 'tous' : impact}`;
            }
        };
        
        // Fonction pour ouvrir Investing.com avec filtres
        window.openInvestingCalendar = function() {
            const impact = document.getElementById('impactFilter')?.value || 'all';
            const currency = document.getElementById('currencyFilter')?.value || 'all';
            
            let url = 'https://www.investing.com/economic-calendar/';
            
            // URLs sp√©cifiques par pays sur Investing.com
            if (currency !== 'all') {
                const countryUrls = {
                    'USD': 'https://www.investing.com/economic-calendar/united-states-events',
                    'EUR': 'https://www.investing.com/economic-calendar/european-union-events', 
                    'GBP': 'https://www.investing.com/economic-calendar/united-kingdom-events',
                    'JPY': 'https://www.investing.com/economic-calendar/japan-events',
                    'XAU': 'https://www.investing.com/economic-calendar/united-states-events',
                    'DAX': 'https://www.investing.com/economic-calendar/germany-events',
                    'NASDAQ': 'https://www.investing.com/economic-calendar/united-states-events'
                };
                url = countryUrls[currency] || url;
            }
            
            window.open(url, '_blank');
        };
        
        // Fonction pour ouvrir Forex Factory avec filtres
        window.openForexFactoryCalendar = function() {
            const impact = document.getElementById('impactFilter')?.value || 'all';
            const currency = document.getElementById('currencyFilter')?.value || 'all';
            
            // URLs avec filtres int√©gr√©s pour Forex Factory
            let url = 'https://www.forexfactory.com/calendar';
            
            if (currency !== 'all') {
                const currencyUrls = {
                    'USD': 'https://www.forexfactory.com/calendar?c=1', // USA
                    'EUR': 'https://www.forexfactory.com/calendar?c=17', // EUR
                    'GBP': 'https://www.forexfactory.com/calendar?c=4', // GBP
                    'JPY': 'https://www.forexfactory.com/calendar?c=5', // JPY
                    'XAU': 'https://www.forexfactory.com/calendar?c=1', // USA pour l'or
                    'DAX': 'https://www.forexfactory.com/calendar?c=3', // Allemagne
                    'NASDAQ': 'https://www.forexfactory.com/calendar?c=1' // USA
                };
                url = currencyUrls[currency] || url;
            }
            
            window.open(url, '_blank');
        };
    </script>
</body>
</html>