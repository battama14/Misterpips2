<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Diagnostic Firebase - Misterpips</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #0f0f23; 
            color: white; 
            padding: 20px; 
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #00d4ff; margin-bottom: 20px; text-align: center; }
        .section { 
            background: rgba(255,255,255,0.1); 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #00d4ff;
        }
        .section h2 { color: #00d4ff; margin-bottom: 15px; }
        .test-btn { 
            background: #00d4ff; 
            color: #0f0f23; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: bold;
        }
        .test-btn:hover { background: #0099cc; }
        .result { 
            background: rgba(0,0,0,0.3); 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #00d4ff;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left-color: #4CAF50; color: #4CAF50; }
        .error { border-left-color: #f44336; color: #f44336; }
        .warning { border-left-color: #ff9800; color: #ff9800; }
        .info { border-left-color: #2196F3; color: #2196F3; }
        .status { 
            display: inline-block; 
            padding: 5px 10px; 
            border-radius: 15px; 
            font-size: 12px; 
            font-weight: bold;
            margin-left: 10px;
        }
        .status.online { background: #4CAF50; color: white; }
        .status.offline { background: #f44336; color: white; }
        .status.loading { background: #ff9800; color: white; }
        input, select { 
            background: rgba(255,255,255,0.1); 
            border: 1px solid #00d4ff; 
            color: white; 
            padding: 8px; 
            border-radius: 5px; 
            margin: 5px;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Diagnostic Firebase - Misterpips</h1>
        
        <div class="section">
            <h2>ğŸ“Š Ã‰tat de la Connexion Firebase</h2>
            <div id="connectionStatus">
                <span>Firebase:</span><span id="firebaseStatus" class="status loading">VÃ©rification...</span>
                <span>Auth:</span><span id="authStatus" class="status loading">VÃ©rification...</span>
                <span>Database:</span><span id="dbStatus" class="status loading">VÃ©rification...</span>
            </div>
            <button class="test-btn" onclick="checkFirebaseConnection()">ğŸ”„ VÃ©rifier Connexion</button>
            <div id="connectionResult" class="result"></div>
        </div>

        <div class="grid">
            <div class="section">
                <h2>ğŸ‘¤ Test Authentification</h2>
                <button class="test-btn" onclick="testAuth()">ğŸ” Tester Auth</button>
                <button class="test-btn" onclick="testUserPermissions()">ğŸ›¡ï¸ Tester Permissions</button>
                <div id="authResult" class="result"></div>
            </div>

            <div class="section">
                <h2>ğŸ’¾ Test Base de DonnÃ©es</h2>
                <button class="test-btn" onclick="testDatabaseRead()">ğŸ“– Test Lecture</button>
                <button class="test-btn" onclick="testDatabaseWrite()">âœï¸ Test Ã‰criture</button>
                <button class="test-btn" onclick="testUserData()">ğŸ‘¤ DonnÃ©es Utilisateur</button>
                <div id="dbResult" class="result"></div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ’¬ Test Chat</h2>
            <input type="text" id="testMessage" placeholder="Message de test..." maxlength="50">
            <button class="test-btn" onclick="testChatSend()">ğŸ“¤ Envoyer Test</button>
            <button class="test-btn" onclick="testChatRead()">ğŸ“¥ Lire Messages</button>
            <button class="test-btn" onclick="clearTestMessages()">ğŸ—‘ï¸ Nettoyer Tests</button>
            <button class="test-btn" onclick="diagnoseChatDoubles()">ğŸ” Diagnostic Doublons</button>
            <div id="chatResult" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ“ˆ Test Trading Data</h2>
            <button class="test-btn" onclick="testTradingData()">ğŸ“Š VÃ©rifier Trades</button>
            <button class="test-btn" onclick="testRankingData()">ğŸ† Test Classement</button>
            <button class="test-btn" onclick="syncLocalToFirebase()">ğŸ”„ Sync Localâ†’Firebase</button>
            <div id="tradingResult" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ‘¥ Gestion Utilisateurs VIP</h2>
            <div style="margin-bottom: 15px;">
                <input type="email" id="userEmail" placeholder="Email utilisateur...">
                <input type="password" id="userPassword" placeholder="Mot de passe...">
                <button class="test-btn" onclick="addVIPUser()">â• Ajouter VIP</button>
                <button class="test-btn" onclick="removeVIPUser()">â– Supprimer VIP</button>
            </div>
            <button class="test-btn" onclick="listVIPUsers()">ğŸ“‹ Lister VIP</button>
            <button class="test-btn" onclick="checkUserExists()">ğŸ” VÃ©rifier Utilisateur</button>
            <button class="test-btn" onclick="repairExistingUser()">ğŸ”§ RÃ©parer Utilisateur</button>
            <button class="test-btn" onclick="forceDeleteUser()">ğŸ—‘ï¸ Supprimer ComplÃ¨tement</button>
            <button class="test-btn" onclick="cleanAuthUser()">ğŸ§¹ Nettoyer Auth</button>
            <button class="test-btn" onclick="createWithNewEmail()">ğŸ”„ CrÃ©er avec Email ModifiÃ©</button>
            <div id="vipResult" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ”§ Actions de RÃ©paration</h2>
            <button class="test-btn" onclick="repairUserProfile()">ğŸ‘¤ RÃ©parer Profil</button>
            <button class="test-btn" onclick="repairPermissions()">ğŸ›¡ï¸ RÃ©parer Permissions</button>
            <button class="test-btn" onclick="cleanDuplicates()">ğŸ§¹ Nettoyer Doublons</button>
            <button class="test-btn" onclick="resetFirebaseConnection()">ğŸ”„ Reset Connexion</button>
            <div id="repairResult" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ“‹ Logs en Temps RÃ©el</h2>
            <button class="test-btn" onclick="clearLogs()">ğŸ—‘ï¸ Vider Logs</button>
            <button class="test-btn" onclick="exportLogs()">ğŸ’¾ Exporter Logs</button>
            <div id="realTimeLogs" class="result" style="max-height: 200px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, deleteUser, updatePassword, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getDatabase, ref, set, get, push, remove, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDSDK0NfVSs_VQb3TnrixiJbOpTsmoUMvU",
            authDomain: "misterpips-b71fb.firebaseapp.com",
            databaseURL: "https://misterpips-b71fb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "misterpips-b71fb",
            storageBucket: "misterpips-b71fb.firebasestorage.app",
            messagingSenderId: "574231126409",
            appId: "1:574231126409:web:b7ed93ac4ea62e247dc158"
        };

        let app, auth, db, currentUser = null;
        let logs = [];

        // Initialisation
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
            window.firebaseApp = app;
            window.firebaseAuth = auth;
            window.firebaseDB = db;
            log('âœ… Firebase initialisÃ© avec succÃ¨s', 'success');
        } catch (error) {
            log('âŒ Erreur initialisation Firebase: ' + error.message, 'error');
        }

        // Surveillance auth
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateAuthStatus(user);
            if (user) {
                log(`ğŸ‘¤ Utilisateur connectÃ©: ${user.email} (${user.uid})`, 'success');
                sessionStorage.setItem('firebaseUID', user.uid);
                sessionStorage.setItem('userEmail', user.email);
            } else {
                log('âŒ Aucun utilisateur connectÃ©', 'warning');
            }
        });

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ timestamp, message, type });
            
            const logsDiv = document.getElementById('realTimeLogs');
            if (logsDiv) {
                logsDiv.innerHTML = logs.slice(-20).map(l => 
                    `<div class="${l.type}">[${l.timestamp}] ${l.message}</div>`
                ).join('');
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }
            console.log(logEntry);
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status ${status}`;
                element.textContent = text;
            }
        }

        function updateAuthStatus(user) {
            if (user) {
                updateStatus('authStatus', 'online', 'ConnectÃ©');
                updateStatus('firebaseStatus', 'online', 'Actif');
            } else {
                updateStatus('authStatus', 'offline', 'DÃ©connectÃ©');
            }
        }

        // Tests globaux
        window.checkFirebaseConnection = async function() {
            const result = document.getElementById('connectionResult');
            result.innerHTML = '';
            
            try {
                // Test Firebase App
                if (app) {
                    log('âœ… Firebase App: OK', 'success');
                    updateStatus('firebaseStatus', 'online', 'ConnectÃ©');
                } else {
                    throw new Error('Firebase App non initialisÃ©');
                }

                // Test Auth
                if (auth) {
                    log('âœ… Firebase Auth: OK', 'success');
                    if (currentUser) {
                        log(`ğŸ‘¤ Utilisateur: ${currentUser.email}`, 'info');
                        updateStatus('authStatus', 'online', 'ConnectÃ©');
                    } else {
                        log('âš ï¸ Aucun utilisateur connectÃ©', 'warning');
                        updateStatus('authStatus', 'offline', 'DÃ©connectÃ©');
                    }
                } else {
                    throw new Error('Firebase Auth non initialisÃ©');
                }

                // Test Database
                if (db) {
                    const testRef = ref(db, '.info/connected');
                    const snapshot = await get(testRef);
                    if (snapshot.exists()) {
                        log('âœ… Firebase Database: ConnectÃ©', 'success');
                        updateStatus('dbStatus', 'online', 'ConnectÃ©');
                    } else {
                        log('âš ï¸ Firebase Database: DÃ©connectÃ©', 'warning');
                        updateStatus('dbStatus', 'offline', 'DÃ©connectÃ©');
                    }
                } else {
                    throw new Error('Firebase Database non initialisÃ©');
                }

                result.innerHTML = '<div class="success">âœ… Tous les services Firebase sont opÃ©rationnels</div>';
                
            } catch (error) {
                log('âŒ Erreur connexion: ' + error.message, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.testAuth = async function() {
            const result = document.getElementById('authResult');
            result.innerHTML = '';
            
            try {
                if (!currentUser) {
                    result.innerHTML = '<div class="warning">âš ï¸ Aucun utilisateur connectÃ©. Redirection vers la page de connexion...</div>';
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }

                log(`ğŸ” Test auth pour: ${currentUser.email}`, 'info');
                
                // VÃ©rifier le token
                const token = await currentUser.getIdToken();
                log('âœ… Token Firebase obtenu', 'success');
                
                // VÃ©rifier les claims
                const tokenResult = await currentUser.getIdTokenResult();
                log(`ğŸ« Token valide jusqu'Ã : ${new Date(tokenResult.expirationTime)}`, 'info');
                
                result.innerHTML = `
                    <div class="success">âœ… Authentification OK</div>
                    <div class="info">Email: ${currentUser.email}</div>
                    <div class="info">UID: ${currentUser.uid}</div>
                    <div class="info">Token valide: ${tokenResult.expirationTime}</div>
                `;
                
            } catch (error) {
                log('âŒ Erreur auth: ' + error.message, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.testUserPermissions = async function() {
            const result = document.getElementById('authResult');
            
            try {
                if (!currentUser) {
                    result.innerHTML = '<div class="error">âŒ Aucun utilisateur connectÃ©</div>';
                    return;
                }

                log('ğŸ›¡ï¸ Test permissions utilisateur...', 'info');
                
                // VÃ©rifier profil utilisateur
                const userRef = ref(db, `users/${currentUser.uid}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    log(`âœ… Profil utilisateur trouvÃ©: VIP=${userData.isVIP}`, 'success');
                    
                    result.innerHTML += `
                        <div class="success">âœ… Profil utilisateur trouvÃ©</div>
                        <div class="info">VIP: ${userData.isVIP ? 'Oui' : 'Non'}</div>
                        <div class="info">Email: ${userData.email || 'Non dÃ©fini'}</div>
                        <div class="info">DerniÃ¨re connexion: ${userData.lastLogin || 'Jamais'}</div>
                    `;
                } else {
                    log('âŒ Profil utilisateur introuvable', 'error');
                    result.innerHTML += '<div class="error">âŒ Profil utilisateur introuvable dans Firebase</div>';
                }
                
            } catch (error) {
                log('âŒ Erreur permissions: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.testDatabaseRead = async function() {
            const result = document.getElementById('dbResult');
            result.innerHTML = '';
            
            try {
                log('ğŸ“– Test lecture base de donnÃ©es...', 'info');
                
                // Test lecture gÃ©nÃ©rale
                const testRef = ref(db, 'test');
                const snapshot = await get(testRef);
                log('âœ… Lecture DB: OK', 'success');
                
                // Test lecture utilisateurs
                const usersRef = ref(db, 'users');
                const usersSnapshot = await get(usersRef);
                const userCount = usersSnapshot.exists() ? Object.keys(usersSnapshot.val()).length : 0;
                log(`ğŸ‘¥ Utilisateurs trouvÃ©s: ${userCount}`, 'info');
                
                result.innerHTML = `
                    <div class="success">âœ… Lecture base de donnÃ©es: OK</div>
                    <div class="info">Utilisateurs dans la DB: ${userCount}</div>
                `;
                
            } catch (error) {
                log('âŒ Erreur lecture DB: ' + error.message, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.testDatabaseWrite = async function() {
            const result = document.getElementById('dbResult');
            
            try {
                if (!currentUser) {
                    result.innerHTML += '<div class="error">âŒ Aucun utilisateur connectÃ©</div>';
                    return;
                }

                log('âœï¸ Test Ã©criture base de donnÃ©es...', 'info');
                
                const testData = {
                    timestamp: Date.now(),
                    user: currentUser.uid,
                    test: 'diagnostic'
                };
                
                const testRef = ref(db, `diagnostic_tests/${Date.now()}`);
                await set(testRef, testData);
                log('âœ… Ã‰criture DB: OK', 'success');
                
                result.innerHTML += '<div class="success">âœ… Ã‰criture base de donnÃ©es: OK</div>';
                
            } catch (error) {
                log('âŒ Erreur Ã©criture DB: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.testUserData = async function() {
            const result = document.getElementById('dbResult');
            
            try {
                if (!currentUser) {
                    result.innerHTML += '<div class="error">âŒ Aucun utilisateur connectÃ©</div>';
                    return;
                }

                log('ğŸ‘¤ Test donnÃ©es utilisateur...', 'info');
                
                // VÃ©rifier donnÃ©es dashboard
                const dashboardRef = ref(db, `dashboards/${currentUser.uid}`);
                const dashboardSnapshot = await get(dashboardRef);
                
                if (dashboardSnapshot.exists()) {
                    const data = dashboardSnapshot.val();
                    const tradesCount = data.trades ? (Array.isArray(data.trades) ? data.trades.length : Object.keys(data.trades).length) : 0;
                    log(`ğŸ“Š Dashboard trouvÃ©: ${tradesCount} trades`, 'success');
                    
                    result.innerHTML += `
                        <div class="success">âœ… DonnÃ©es dashboard trouvÃ©es</div>
                        <div class="info">Trades: ${tradesCount}</div>
                        <div class="info">Capital: ${data.capital || 'Non dÃ©fini'}</div>
                    `;
                } else {
                    log('âš ï¸ Aucune donnÃ©e dashboard trouvÃ©e', 'warning');
                    result.innerHTML += '<div class="warning">âš ï¸ Aucune donnÃ©e dashboard trouvÃ©e</div>';
                }
                
            } catch (error) {
                log('âŒ Erreur donnÃ©es utilisateur: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.testChatSend = async function() {
            const result = document.getElementById('chatResult');
            const messageInput = document.getElementById('testMessage');
            const message = messageInput.value.trim() || 'Test diagnostic';
            
            try {
                if (!currentUser) {
                    result.innerHTML = '<div class="error">âŒ Aucun utilisateur connectÃ©</div>';
                    return;
                }

                log('ğŸ“¤ Test envoi message chat...', 'info');
                
                const messageData = {
                    id: Date.now(),
                    userId: currentUser.uid,
                    nickname: 'Test Diagnostic',
                    message: `[TEST] ${message}`,
                    timestamp: Date.now(),
                    date: new Date().toISOString().split('T')[0]
                };
                
                const messagesRef = ref(db, 'vip_chat');
                await push(messagesRef, messageData);
                log('âœ… Message envoyÃ© avec succÃ¨s', 'success');
                
                messageInput.value = '';
                result.innerHTML = '<div class="success">âœ… Message de test envoyÃ©</div>';
                
            } catch (error) {
                log('âŒ Erreur envoi message: ' + error.message, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.testChatRead = async function() {
            const result = document.getElementById('chatResult');
            
            try {
                log('ğŸ“¥ Test lecture messages chat...', 'info');
                
                const messagesRef = ref(db, 'vip_chat');
                const snapshot = await get(messagesRef);
                
                if (snapshot.exists()) {
                    const messages = Object.values(snapshot.val());
                    const testMessages = messages.filter(m => m.message && m.message.includes('[TEST]'));
                    log(`ğŸ’¬ Messages trouvÃ©s: ${messages.length} (${testMessages.length} tests)`, 'success');
                    
                    result.innerHTML += `
                        <div class="success">âœ… Messages chargÃ©s</div>
                        <div class="info">Total: ${messages.length}</div>
                        <div class="info">Messages de test: ${testMessages.length}</div>
                    `;
                } else {
                    log('âš ï¸ Aucun message trouvÃ©', 'warning');
                    result.innerHTML += '<div class="warning">âš ï¸ Aucun message dans le chat</div>';
                }
                
            } catch (error) {
                log('âŒ Erreur lecture messages: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.clearTestMessages = async function() {
            const result = document.getElementById('chatResult');
            
            try {
                log('ğŸ—‘ï¸ Nettoyage messages de test...', 'info');
                
                const messagesRef = ref(db, 'vip_chat');
                const snapshot = await get(messagesRef);
                
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    let deletedCount = 0;
                    
                    for (const [key, message] of Object.entries(messages)) {
                        if (message.message && message.message.includes('[TEST]')) {
                            await remove(ref(db, `vip_chat/${key}`));
                            deletedCount++;
                        }
                    }
                    
                    log(`ğŸ—‘ï¸ ${deletedCount} messages de test supprimÃ©s`, 'success');
                    result.innerHTML += `<div class="success">âœ… ${deletedCount} messages de test supprimÃ©s</div>`;
                } else {
                    result.innerHTML += '<div class="info">â„¹ï¸ Aucun message Ã  supprimer</div>';
                }
                
            } catch (error) {
                log('âŒ Erreur nettoyage: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.testTradingData = async function() {
            const result = document.getElementById('tradingResult');
            result.innerHTML = '';
            
            try {
                if (!currentUser) {
                    result.innerHTML = '<div class="error">âŒ Aucun utilisateur connectÃ©</div>';
                    return;
                }

                log('ğŸ“ˆ Test donnÃ©es de trading...', 'info');
                
                const tradesRef = ref(db, `dashboards/${currentUser.uid}/trades`);
                const snapshot = await get(tradesRef);
                
                if (snapshot.exists()) {
                    const trades = snapshot.val();
                    const tradesArray = Array.isArray(trades) ? trades : Object.values(trades);
                    const today = new Date().toISOString().split('T')[0];
                    const todayTrades = tradesArray.filter(t => t.date === today);
                    
                    log(`ğŸ“Š Trades trouvÃ©s: ${tradesArray.length} (${todayTrades.length} aujourd'hui)`, 'success');
                    
                    result.innerHTML = `
                        <div class="success">âœ… DonnÃ©es de trading trouvÃ©es</div>
                        <div class="info">Total trades: ${tradesArray.length}</div>
                        <div class="info">Trades aujourd'hui: ${todayTrades.length}</div>
                    `;
                } else {
                    log('âš ï¸ Aucune donnÃ©e de trading trouvÃ©e', 'warning');
                    result.innerHTML = '<div class="warning">âš ï¸ Aucune donnÃ©e de trading trouvÃ©e</div>';
                }
                
            } catch (error) {
                log('âŒ Erreur donnÃ©es trading: ' + error.message, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.testRankingData = async function() {
            const result = document.getElementById('tradingResult');
            
            try {
                log('ğŸ† Test donnÃ©es classement...', 'info');
                
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const vipUsers = Object.entries(users).filter(([uid, data]) => data.isVIP);
                    log(`ğŸ‘¥ Utilisateurs VIP trouvÃ©s: ${vipUsers.length}`, 'success');
                    
                    result.innerHTML += `
                        <div class="success">âœ… DonnÃ©es classement OK</div>
                        <div class="info">Utilisateurs VIP: ${vipUsers.length}</div>
                    `;
                } else {
                    log('âš ï¸ Aucun utilisateur trouvÃ©', 'warning');
                    result.innerHTML += '<div class="warning">âš ï¸ Aucun utilisateur trouvÃ©</div>';
                }
                
            } catch (error) {
                log('âŒ Erreur classement: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.syncLocalToFirebase = async function() {
            const result = document.getElementById('tradingResult');
            
            try {
                if (!currentUser) {
                    result.innerHTML += '<div class="error">âŒ Aucun utilisateur connectÃ©</div>';
                    return;
                }

                log('ğŸ”„ Synchronisation localStorage â†’ Firebase...', 'info');
                
                const localData = localStorage.getItem('dashboardData');
                if (localData) {
                    const data = JSON.parse(localData);
                    if (data.trades && data.trades.length > 0) {
                        const tradesRef = ref(db, `dashboards/${currentUser.uid}/trades`);
                        await set(tradesRef, data.trades);
                        log(`âœ… ${data.trades.length} trades synchronisÃ©s`, 'success');
                        
                        result.innerHTML += `<div class="success">âœ… ${data.trades.length} trades synchronisÃ©s</div>`;
                    } else {
                        result.innerHTML += '<div class="warning">âš ï¸ Aucun trade Ã  synchroniser</div>';
                    }
                } else {
                    result.innerHTML += '<div class="warning">âš ï¸ Aucune donnÃ©e locale trouvÃ©e</div>';
                }
                
            } catch (error) {
                log('âŒ Erreur synchronisation: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.repairUserProfile = async function() {
            const result = document.getElementById('repairResult');
            result.innerHTML = '';
            
            try {
                if (!currentUser) {
                    result.innerHTML = '<div class="error">âŒ Aucun utilisateur connectÃ©</div>';
                    return;
                }

                log('ğŸ”§ RÃ©paration profil utilisateur...', 'info');
                
                const userRef = ref(db, `users/${currentUser.uid}`);
                const userData = {
                    email: currentUser.email,
                    isVIP: true,
                    lastLogin: new Date().toISOString(),
                    repaired: true,
                    repairedAt: Date.now()
                };
                
                await set(userRef, userData);
                log('âœ… Profil utilisateur rÃ©parÃ©', 'success');
                
                result.innerHTML = '<div class="success">âœ… Profil utilisateur rÃ©parÃ©</div>';
                
            } catch (error) {
                log('âŒ Erreur rÃ©paration profil: ' + error.message, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.repairPermissions = async function() {
            const result = document.getElementById('repairResult');
            
            try {
                if (!currentUser) {
                    result.innerHTML += '<div class="error">âŒ Aucun utilisateur connectÃ©</div>';
                    return;
                }

                log('ğŸ›¡ï¸ RÃ©paration permissions...', 'info');
                
                // Forcer le rafraÃ®chissement du token
                await currentUser.getIdToken(true);
                log('âœ… Token rafraÃ®chi', 'success');
                
                result.innerHTML += '<div class="success">âœ… Permissions rafraÃ®chies</div>';
                
            } catch (error) {
                log('âŒ Erreur rÃ©paration permissions: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.cleanDuplicates = async function() {
            const result = document.getElementById('repairResult');
            
            try {
                log('ğŸ§¹ Nettoyage doublons...', 'info');
                
                // Nettoyer les messages en double dans le chat
                const messagesRef = ref(db, 'vip_chat');
                const snapshot = await get(messagesRef);
                
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    const seen = new Set();
                    let duplicates = 0;
                    
                    for (const [key, message] of Object.entries(messages)) {
                        const signature = `${message.userId}_${message.message}_${message.timestamp}`;
                        if (seen.has(signature)) {
                            await remove(ref(db, `vip_chat/${key}`));
                            duplicates++;
                        } else {
                            seen.add(signature);
                        }
                    }
                    
                    log(`ğŸ§¹ ${duplicates} doublons supprimÃ©s`, 'success');
                    result.innerHTML += `<div class="success">âœ… ${duplicates} doublons supprimÃ©s</div>`;
                } else {
                    result.innerHTML += '<div class="info">â„¹ï¸ Aucun message Ã  nettoyer</div>';
                }
                
            } catch (error) {
                log('âŒ Erreur nettoyage: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.resetFirebaseConnection = async function() {
            const result = document.getElementById('repairResult');
            
            try {
                log('ğŸ”„ Reset connexion Firebase...', 'info');
                
                // RÃ©initialiser les rÃ©fÃ©rences
                window.firebaseApp = app;
                window.firebaseAuth = auth;
                window.firebaseDB = db;
                
                // Vider le cache
                sessionStorage.clear();
                
                log('âœ… Connexion Firebase rÃ©initialisÃ©e', 'success');
                result.innerHTML += '<div class="success">âœ… Connexion rÃ©initialisÃ©e</div>';
                
                // Recharger la page aprÃ¨s 2 secondes
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                log('âŒ Erreur reset: ' + error.message, 'error');
                result.innerHTML += `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.clearLogs = function() {
            logs = [];
            document.getElementById('realTimeLogs').innerHTML = '';
            log('ğŸ—‘ï¸ Logs vidÃ©s', 'info');
        };

        window.exportLogs = function() {
            const logText = logs.map(l => `[${l.timestamp}] ${l.type.toUpperCase()}: ${l.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `firebase-diagnostic-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('ğŸ’¾ Logs exportÃ©s', 'success');
        };

        // Gestion utilisateurs VIP
        window.addVIPUser = async function() {
            const result = document.getElementById('vipResult');
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            
            if (!email || !password) {
                result.innerHTML = '<div class="error">âŒ Email et mot de passe requis</div>';
                return;
            }
            
            try {
                log(`â• CrÃ©ation utilisateur VIP: ${email}`, 'info');
                
                // CrÃ©er l'utilisateur
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;
                
                // Ajouter Ã  la base VIP
                const userRef = ref(db, `users/${newUser.uid}`);
                await set(userRef, {
                    email: email,
                    isVIP: true,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.email || 'admin'
                });
                
                log(`âœ… Utilisateur VIP crÃ©Ã©: ${email}`, 'success');
                result.innerHTML = `<div class="success">âœ… Utilisateur VIP crÃ©Ã©: ${email}</div>`;
                
                // Vider les champs
                document.getElementById('userEmail').value = '';
                document.getElementById('userPassword').value = '';
                
            } catch (error) {
                log(`âŒ Erreur crÃ©ation VIP: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };
        
        window.removeVIPUser = async function() {
            const result = document.getElementById('vipResult');
            const email = document.getElementById('userEmail').value.trim();
            
            if (!email) {
                result.innerHTML = '<div class="error">âŒ Email requis</div>';
                return;
            }
            
            try {
                log(`â– Suppression utilisateur VIP: ${email}`, 'info');
                
                // Trouver l'utilisateur par email
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const userEntry = Object.entries(users).find(([uid, data]) => data.email === email);
                    
                    if (userEntry) {
                        const [uid, userData] = userEntry;
                        
                        // Supprimer de la base VIP
                        await remove(ref(db, `users/${uid}`));
                        
                        // Supprimer les donnÃ©es dashboard
                        await remove(ref(db, `dashboards/${uid}`));
                        
                        log(`âœ… Utilisateur VIP supprimÃ©: ${email}`, 'success');
                        result.innerHTML = `<div class="success">âœ… Utilisateur VIP supprimÃ©: ${email}</div>`;
                        
                        document.getElementById('userEmail').value = '';
                    } else {
                        result.innerHTML = `<div class="warning">âš ï¸ Utilisateur non trouvÃ©: ${email}</div>`;
                    }
                } else {
                    result.innerHTML = '<div class="warning">âš ï¸ Aucun utilisateur dans la base</div>';
                }
                
            } catch (error) {
                log(`âŒ Erreur suppression VIP: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };
        
        window.listVIPUsers = async function() {
            const result = document.getElementById('vipResult');
            
            try {
                log('ğŸ“‹ Liste des utilisateurs VIP...', 'info');
                
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const vipUsers = Object.entries(users)
                        .filter(([uid, data]) => data.isVIP)
                        .map(([uid, data]) => ({ uid, ...data }));
                    
                    log(`ğŸ‘¥ ${vipUsers.length} utilisateurs VIP trouvÃ©s`, 'success');
                    
                    let html = `<div class="success">âœ… ${vipUsers.length} utilisateurs VIP:</div>`;
                    vipUsers.forEach(user => {
                        html += `
                            <div class="info">
                                ğŸ‘¤ ${user.email} (${user.uid.substring(0, 8)}...)
                                <br>Â Â Â Â CrÃ©Ã©: ${user.createdAt || 'Inconnu'}
                            </div>
                        `;
                    });
                    
                    result.innerHTML = html;
                } else {
                    result.innerHTML = '<div class="warning">âš ï¸ Aucun utilisateur dans la base</div>';
                }
                
            } catch (error) {
                log(`âŒ Erreur liste VIP: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };
        
        window.resetUserPassword = async function() {
            const result = document.getElementById('vipResult');
            const email = document.getElementById('userEmail').value.trim();
            const newPassword = document.getElementById('userPassword').value.trim();
            
            if (!email || !newPassword) {
                result.innerHTML = '<div class="error">âŒ Email et nouveau mot de passe requis</div>';
                return;
            }
            
            try {
                log(`ğŸ”‘ Reset mot de passe pour: ${email}`, 'info');
                
                result.innerHTML = `
                    <div class="warning">âš ï¸ Pour reset le mot de passe:</div>
                    <div class="info">1. L'utilisateur doit se connecter avec son ancien mot de passe</div>
                    <div class="info">2. Ou utiliser "Mot de passe oubliÃ©" sur la page de connexion</div>
                    <div class="info">3. Ou supprimer et recrÃ©er le compte avec le nouveau mot de passe</div>
                `;
                
            } catch (error) {
                log(`âŒ Erreur reset password: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };
        
        window.checkUserExists = async function() {
            const result = document.getElementById('vipResult');
            const email = document.getElementById('userEmail').value.trim();
            
            if (!email) {
                result.innerHTML = '<div class="error">âŒ Email requis</div>';
                return;
            }
            
            try {
                log(`ğŸ” VÃ©rification utilisateur: ${email}`, 'info');
                
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const userEntry = Object.entries(users).find(([uid, data]) => data.email === email);
                    
                    if (userEntry) {
                        const [uid, userData] = userEntry;
                        log(`âœ… Utilisateur trouvÃ© dans Firebase: ${uid}`, 'success');
                        
                        result.innerHTML = `
                            <div class="success">âœ… Utilisateur existe dans Firebase</div>
                            <div class="info">Email: ${userData.email}</div>
                            <div class="info">UID: ${uid}</div>
                            <div class="info">VIP: ${userData.isVIP ? 'Oui' : 'Non'}</div>
                            <div class="info">CrÃ©Ã©: ${userData.createdAt || 'Inconnu'}</div>
                        `;
                    } else {
                        log(`âŒ Utilisateur non trouvÃ© dans Firebase: ${email}`, 'error');
                        result.innerHTML = `<div class="error">âŒ Utilisateur non trouvÃ© dans Firebase</div>`;
                    }
                } else {
                    result.innerHTML = '<div class="warning">âš ï¸ Aucun utilisateur dans la base</div>';
                }
                
            } catch (error) {
                log(`âŒ Erreur vÃ©rification: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };
        
        window.repairExistingUser = async function() {
            const result = document.getElementById('vipResult');
            const email = document.getElementById('userEmail').value.trim();
            
            if (!email) {
                result.innerHTML = '<div class="error">âŒ Email requis</div>';
                return;
            }
            
            try {
                log(`ğŸ”§ RÃ©paration utilisateur: ${email}`, 'info');
                
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const userEntry = Object.entries(users).find(([uid, data]) => data.email === email);
                    
                    if (userEntry) {
                        const [uid, userData] = userEntry;
                        
                        const userRef = ref(db, `users/${uid}`);
                        await set(userRef, {
                            email: email,
                            isVIP: true,
                            lastLogin: new Date().toISOString(),
                            repaired: true,
                            repairedAt: Date.now(),
                            createdAt: userData.createdAt || new Date().toISOString()
                        });
                        
                        log(`âœ… Profil rÃ©parÃ© pour: ${email}`, 'success');
                        result.innerHTML = `<div class="success">âœ… Profil utilisateur rÃ©parÃ©</div>`;
                    } else {
                        result.innerHTML = `<div class="error">âŒ Utilisateur non trouvÃ©: ${email}</div>`;
                    }
                } else {
                    result.innerHTML = '<div class="warning">âš ï¸ Aucun utilisateur dans la base</div>';
                }
                
            } catch (error) {
                log(`âŒ Erreur rÃ©paration: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };
        
        window.forceDeleteUser = async function() {
            const result = document.getElementById('vipResult');
            const email = document.getElementById('userEmail').value.trim();
            
            if (!email) {
                result.innerHTML = '<div class="error">âŒ Email requis</div>';
                return;
            }
            
            if (!confirm(`âš ï¸ ATTENTION: Supprimer complÃ¨tement ${email} ?`)) {
                return;
            }
            
            try {
                log(`ğŸ—‘ï¸ Suppression complÃ¨te: ${email}`, 'info');
                
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const userEntry = Object.entries(users).find(([uid, data]) => data.email === email);
                    
                    if (userEntry) {
                        const [uid, userData] = userEntry;
                        
                        await remove(ref(db, `users/${uid}`));
                        await remove(ref(db, `dashboards/${uid}`));
                        
                        log(`âœ… Utilisateur supprimÃ© complÃ¨tement: ${email}`, 'success');
                        result.innerHTML = `
                            <div class="success">âœ… Utilisateur supprimÃ© complÃ¨tement</div>
                            <div class="info">Vous pouvez maintenant le recrÃ©er</div>
                        `;
                        
                        document.getElementById('userEmail').value = '';
                        document.getElementById('userPassword').value = '';
                    } else {
                        result.innerHTML = `<div class="warning">âš ï¸ Utilisateur non trouvÃ©: ${email}</div>`;
                    }
                } else {
                    result.innerHTML = '<div class="warning">âš ï¸ Aucun utilisateur dans la base</div>';
                }
                
            } catch (error) {
                log(`âŒ Erreur suppression: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };
        
        window.cleanAuthUser = async function() {
            const result = document.getElementById('vipResult');
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            
            if (!email || !password) {
                result.innerHTML = '<div class="error">âŒ Email et mot de passe requis pour nettoyer Auth</div>';
                return;
            }
            
            try {
                log(`ğŸ§¹ Nettoyage Firebase Auth pour: ${email}`, 'info');
                
                // Essayer de se connecter avec les identifiants
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                log(`âœ… Connexion rÃ©ussie, suppression du compte Auth...`, 'info');
                
                // Supprimer le compte de Firebase Auth
                await deleteUser(user);
                
                log(`âœ… Compte Auth supprimÃ© pour: ${email}`, 'success');
                result.innerHTML = `
                    <div class="success">âœ… Compte Firebase Auth nettoyÃ©</div>
                    <div class="info">Vous pouvez maintenant recrÃ©er le compte</div>
                `;
                
            } catch (error) {
                if (error.code === 'auth/invalid-credential') {
                    log(`âš ï¸ Identifiants incorrects, tentative de suppression manuelle...`, 'warning');
                    result.innerHTML = `
                        <div class="warning">âš ï¸ Identifiants incorrects</div>
                        <div class="info">Le compte existe dans Auth mais mot de passe incorrect</div>
                        <div class="info">Contactez l'administrateur Firebase pour suppression manuelle</div>
                    `;
                } else {
                    log(`âŒ Erreur nettoyage Auth: ${error.message}`, 'error');
                    result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
                }
            }
        };
        
        window.createWithNewEmail = async function() {
            const result = document.getElementById('vipResult');
            const originalEmail = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            
            if (!originalEmail || !password) {
                result.innerHTML = '<div class="error">âŒ Email et mot de passe requis</div>';
                return;
            }
            
            try {
                // CrÃ©er un email lÃ©gÃ¨rement modifiÃ©
                const [localPart, domain] = originalEmail.split('@');
                const newEmail = `${localPart}+vip@${domain}`;
                
                log(`ğŸ”„ CrÃ©ation avec email modifiÃ©: ${newEmail}`, 'info');
                
                // CrÃ©er le nouveau compte
                const userCredential = await createUserWithEmailAndPassword(auth, newEmail, password);
                const newUser = userCredential.user;
                
                // Ajouter Ã  la base VIP avec l'email original
                const userRef = ref(db, `users/${newUser.uid}`);
                await set(userRef, {
                    email: originalEmail, // Utiliser l'email original
                    authEmail: newEmail,  // Garder trace de l'email auth
                    isVIP: true,
                    createdAt: new Date().toISOString(),
                    workaround: true
                });
                
                log(`âœ… Compte crÃ©Ã© avec succÃ¨s: ${newEmail}`, 'success');
                result.innerHTML = `
                    <div class="success">âœ… Compte crÃ©Ã© avec email modifiÃ©</div>
                    <div class="info">Email de connexion: ${newEmail}</div>
                    <div class="info">Email affichÃ©: ${originalEmail}</div>
                    <div class="info">Mot de passe: ${password}</div>
                `;
                
                // Mettre Ã  jour les champs
                document.getElementById('userEmail').value = newEmail;
                
            } catch (error) {
                log(`âŒ Erreur crÃ©ation email modifiÃ©: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };

        window.diagnoseChatDoubles = async function() {
            const result = document.getElementById('chatResult');
            
            try {
                log('ğŸ” Diagnostic doublons chat...', 'info');
                
                const messagesRef = ref(db, 'vip_chat');
                const snapshot = await get(messagesRef);
                
                if (snapshot.exists()) {
                    const messages = Object.entries(snapshot.val());
                    const duplicates = new Map();
                    
                    messages.forEach(([key, message]) => {
                        const signature = `${message.userId}_${message.message}_${Math.floor(message.timestamp / 1000)}`;
                        if (!duplicates.has(signature)) {
                            duplicates.set(signature, []);
                        }
                        duplicates.get(signature).push({ key, message });
                    });
                    
                    const realDuplicates = Array.from(duplicates.values()).filter(group => group.length > 1);
                    
                    log(`ğŸ“Š ${realDuplicates.length} groupes de doublons trouvÃ©s`, realDuplicates.length > 0 ? 'warning' : 'success');
                    
                    let html = `<div class="${realDuplicates.length > 0 ? 'warning' : 'success'}">ğŸ“Š ${realDuplicates.length} groupes de doublons</div>`;
                    
                    if (realDuplicates.length > 0) {
                        html += '<div class="info">Doublons dÃ©tectÃ©s:</div>';
                        realDuplicates.slice(0, 5).forEach(group => {
                            html += `<div class="info">â€¢ "${group[0].message.message.substring(0, 30)}..." (${group.length}x)</div>`;
                        });
                        html += '<button class="test-btn" onclick="fixChatDoubles()" style="margin-top: 10px;">ğŸ”§ Corriger Doublons</button>';
                    }
                    
                    result.innerHTML = html;
                } else {
                    result.innerHTML = '<div class="info">â„¹ï¸ Aucun message dans le chat</div>';
                }
                
            } catch (error) {
                log(`âŒ Erreur diagnostic doublons: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };
        
        window.fixChatDoubles = async function() {
            const result = document.getElementById('chatResult');
            
            try {
                log('ğŸ”§ Correction doublons chat...', 'info');
                
                const messagesRef = ref(db, 'vip_chat');
                const snapshot = await get(messagesRef);
                
                if (snapshot.exists()) {
                    const messages = Object.entries(snapshot.val());
                    const seen = new Set();
                    let deletedCount = 0;
                    
                    for (const [key, message] of messages) {
                        const signature = `${message.userId}_${message.message}_${Math.floor(message.timestamp / 1000)}`;
                        
                        if (seen.has(signature)) {
                            await remove(ref(db, `vip_chat/${key}`));
                            deletedCount++;
                            log(`ğŸ—‘ï¸ Doublon supprimÃ©: ${key}`, 'info');
                        } else {
                            seen.add(signature);
                        }
                    }
                    
                    log(`âœ… ${deletedCount} doublons supprimÃ©s`, 'success');
                    result.innerHTML = `<div class="success">âœ… ${deletedCount} doublons supprimÃ©s du chat</div>`;
                } else {
                    result.innerHTML = '<div class="info">â„¹ï¸ Aucun message Ã  corriger</div>';
                }
                
            } catch (error) {
                log(`âŒ Erreur correction doublons: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">âŒ Erreur: ${error.message}</div>`;
            }
        };
        
        // VÃ©rification automatique au chargement
        setTimeout(() => {
            checkFirebaseConnection();
            // Charger la liste VIP au dÃ©marrage
            if (currentUser) {
                listVIPUsers();
            }
        }, 1000);
    </script>
</body>
</html>