<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Trading</title>
    <link rel="stylesheet" href="dashboard-styles.css">
    <link rel="stylesheet" href="vip-styles-new.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <link rel="stylesheet" href="ict-matrix-styles.css">
    <link rel="stylesheet" href="chat-mobile-styles.css">
    <link rel="stylesheet" href="chat-optimized.css">
    <link rel="stylesheet" href="mobile-fixes.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00d4ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Misterpips">
    <link rel="apple-touch-icon" href="Misterpips.jpg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getDatabase, ref, set, get, onValue, push } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDSDK0NfVSs_VQb3TnrixiJbOpTsmoUMvU",
            authDomain: "misterpips-b71fb.firebaseapp.com",
            databaseURL: "https://misterpips-b71fb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "misterpips-b71fb",
            storageBucket: "misterpips-b71fb.firebasestorage.app",
            messagingSenderId: "574231126409",
            appId: "1:574231126409:web:b7ed93ac4ea62e247dc158"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const messaging = getMessaging(app);
        
        // Activer Firebase avec authentification existante
        window.firebaseDB = db;
        window.firebaseAuth = auth;
        
        // V√©rifier l'authentification existante
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // Rediriger vers la page de connexion si pas connect√©
                window.location.href = 'index.html';
            } else {
                console.log('Utilisateur connect√©:', user.email, user.uid);
                // D√©finir l'utilisateur pour le dashboard
                sessionStorage.setItem('firebaseUID', user.uid);
                sessionStorage.setItem('userEmail', user.email);
            }
        });
    </script>

</head>
<body>
    <script>
        // Initialisation avec utilisateur authentifi√©
        window.addEventListener('DOMContentLoaded', function() {
            // Attendre l'authentification Firebase
            const checkAuth = setInterval(() => {
                const firebaseUID = sessionStorage.getItem('firebaseUID');
                const userEmail = sessionStorage.getItem('userEmail');
                
                if (firebaseUID && userEmail) {
                    sessionStorage.setItem('currentUser', firebaseUID);
                    sessionStorage.setItem('authenticated', 'true');
                    
                    // Afficher l'email de l'utilisateur
                    document.querySelector('header h1').innerHTML = `Dashboard Trading <span style="font-size: 0.6em; opacity: 0.7;">- ${userEmail}</span>`;
                    
                    clearInterval(checkAuth);
                }
            }, 100);
        });
    </script>
    
    <div class="container">
        <header>
            <h1>Dashboard Trading</h1>
            <div class="account-selector">
                <label for="accountSelect">üíº Compte:</label>
                <select id="accountSelect">
                    <option value="compte1">Compte Principal</option>
                    <option value="compte2">Compte D√©mo</option>
                    <option value="compte3">Compte Swing</option>
                </select>
                <button id="addAccountBtn" class="btn-info" style="padding: 5px 10px; margin-left: 10px;">+ Nouveau</button>
                <button id="deleteAccountBtn" class="btn-danger" style="padding: 5px 10px; margin-left: 5px;">üóëÔ∏è</button>
                <div id="syncStatus" style="margin-left: 10px; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; background: rgba(78,205,196,0.2); color: #4ecdc4;">üîÑ Sync Auto</div>
            </div>
            <div class="stats-overview">
                <div class="stat-card">
                    <h3>Capital</h3>
                    <span id="capital">$1000</span>
                </div>
                <div class="stat-card">
                    <h3>Winrate</h3>
                    <span id="winRate">0%</span>
                </div>
                <div class="stat-card">
                    <h3>P&L Total</h3>
                    <span id="totalPnL">$0</span>
                </div>
                <div class="stat-card">
                    <h3>Trades Ouverts</h3>
                    <span id="openTrades">0</span>
                </div>
                <div class="stat-card">
                    <h3>Total Trades</h3>
                    <span id="totalTrades">0</span>
                </div>
            </div>
        </header>

        <main>
            <div class="actions">
                <button id="newTradeBtn" class="btn-primary">Nouveau Trade</button>
                <button id="historyTradeBtn" class="btn-success">üìÖ TRADE PASS√â</button>
                <button id="settingsBtn" class="btn-secondary">‚öôÔ∏è Param√®tres</button>
                <button id="closeTradeBtn" class="btn-warning">Cl√¥turer Trade</button>
                <button id="resetBtn" class="btn-danger">Reset Donn√©es</button>
                <button id="manualCloseBtn" class="btn-warning">üéØ Cl√¥ture Manuelle</button>
                <button id="exportBtn" class="btn-info">üìä Export Excel</button>
            </div>

            <div class="charts-section">
                <div class="chart-container" style="height: 350px; padding: 25px;">
                    <h3>üìà Performance Cumulative</h3>
                    <canvas id="performanceChart" style="max-height: 250px;"></canvas>
                </div>
                <div class="chart-container" style="height: 350px; padding: 25px; display: flex; flex-direction: column; justify-content: center;">
                    <h3>üéØ Taux de R√©ussite</h3>
                    <div style="height: 220px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="winRateChart" style="max-width: 180px; max-height: 180px;"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="height: 350px; padding: 25px;">
                    <h3>üìä Performance Mensuelle</h3>
                    <canvas id="monthlyChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
            
            <div class="charts-section">
                <div class="chart-container" style="height: 500px; padding: 25px;">
                    <div class="gauge-container">
                        <h3>üí∞ Performance Totale</h3>
                        <div id="gainsGauge" class="gauge" style="width: 160px; height: 160px; margin: 15px auto;"></div>
                        <div id="gainsValue" class="gauge-value">$0</div>
                        <div id="gainsPercent" class="gauge-percent">0%</div>
                    </div>
                </div>
                <div class="chart-container" style="height: 500px; padding: 25px;">
                    <h3>üìä Analyse des Confluences</h3>
                    <canvas id="confluencesChart" style="max-height: 180px;"></canvas>
                    <div id="confluenceAnalysis" class="confluence-analysis" style="margin-top: 10px;">
                        <h4>üîç Analyse des Confluences ICT</h4>
                        <div class="analysis-item">
                            <span class="confluence-name">Contexte Global</span>
                            <span class="confluence-score score-excellent">Excellent</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container" style="margin-top: 30px; padding: 25px; height: 900px;">
                <h3>üîó Matrice de Corr√©lation ICT - √âtapes de Trading</h3>
                <div class="dashboard-card correlation-card">
                    <div class="card-header">
                        <h3><i class="fas fa-brain"></i> Analyse ICT en Temps R√©el</h3>
                        <div class="refresh-btn" id="refreshCorrelations">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                    </div>
                    <div class="correlation-matrix" id="correlationMatrix">
                        <!-- Matrice g√©n√©r√©e dynamiquement -->
                    </div>
                </div>
            </div>

            <!-- Plan de Trading avec Objectifs -->
            <div class="trading-plan-section">
                <h2>üéØ Plan de Trading & Objectifs</h2>
                <div class="plan-stats">
                    <div class="plan-card">
                        <h4>‚òÄÔ∏è Objectif Journalier</h4>
                        <div class="target-info">
                            <div class="target-amount">Cible: <span id="dailyTargetPercent">1%</span> : $<span id="dailyTarget">10</span></div>
                            <div class="target-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="dailyProgressBar" style="width: 0%"></div>
                                </div>
                                <span id="dailyProgress">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="plan-card">
                        <h4>üìä Objectif Mensuel</h4>
                        <div class="target-info">
                            <div class="target-amount">Cible: <span id="monthlyTargetPercent">15%</span> : $<span id="monthlyTarget">150</span></div>
                            <div class="target-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="monthlyProgressBar" style="width: 0%"></div>
                                </div>
                                <span id="monthProgress">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="plan-card">
                        <h4>üìÖ Objectif Hebdomadaire</h4>
                        <div class="target-info">
                            <div class="target-amount">Cible: <span id="weeklyTargetPercent">3%</span> : $<span id="weeklyTarget">30</span></div>
                            <div class="target-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="weeklyProgressBar" style="width: 0%"></div>
                                </div>
                                <span id="weekProgress">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="plan-card">
                        <h4>üéØ Objectif Annuel</h4>
                        <div class="target-info">
                            <div class="target-amount">Cible: <span id="yearlyTargetPercent">200%</span> : $<span id="yearlyTarget">2000</span></div>
                            <div class="target-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="yearlyProgressBar" style="width: 0%"></div>
                                </div>
                                <span id="yearProgress">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="plan-card">
                        <h4>üìà Rendement Annuel</h4>
                        <div class="return-info">
                            <div class="return-value" id="yearReturn">0%</div>
                            <div class="return-label">du capital initial</div>
                        </div>
                    </div>
                    
                    <!-- Classement VIP en Temps R√©el -->
                    <div class="plan-card">
                        <h4>üèÜ Classement VIP Journalier</h4>
                        <div class="vip-ranking-content">
                            <div class="ranking-list" id="rankingList">
                                <!-- Le classement sera charg√© ici -->
                            </div>
                        </div>
                    </div>
                    

                </div>
            </div>

            <!-- Calendrier de Trading -->
            <div class="calendar-section">
                <h2>üìÖ Calendrier de Trading</h2>
                <div class="calendar-wrapper">
                    <div class="calendar-controls">
                        <button id="prevMonth" class="btn-secondary">‚óÄ</button>
                        <div id="monthYear" class="month-label">Mois</div>
                        <button id="nextMonth" class="btn-secondary">‚ñ∂</button>
                    </div>
                    <div class="calendar-grid-container">
                        <div id="calendarGrid" class="calendar-grid">
                            <!-- Le calendrier sera g√©n√©r√© ici -->
                        </div>
                    </div>
                    <div class="calendar-stats">
                        <div class="calendar-stat">
                            <h4>üìä Ce Mois</h4>
                            <div class="stat-value" id="monthPnL">$0</div>
                            <div class="stat-label">WinRate: <span id="monthWinRate">0%</span></div>
                        </div>
                        <div class="calendar-stat">
                            <h4>üìà Cette Ann√©e</h4>
                            <div class="stat-value" id="yearPnL">$0</div>
                            <div class="stat-label">WinRate: <span id="yearWinRate">0%</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="trades-history">
                <h2>Historique des Trades</h2>
                <table id="tradesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Devise</th>
                            <th>Entr√©e</th>
                            <th>SL</th>
                            <th>TP</th>
                            <th>Lot</th>
                            <th>Risque %</th>
                            <th>Risque R√©el</th>
                            <th>R√©sultat</th>
                            <th>Gain/Perte</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal Nouveau Trade -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal Plein √âcran pour Graphiques -->
    <div id="fullscreenModal" class="modal fullscreen-modal">
        <div class="fullscreen-content" id="fullscreenContent">
            <span class="close-fullscreen">&times;</span>
        </div>
    </div>

    <!-- Modal Trade Pass√© -->
    <div id="historyTradeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÖ Ajouter un Trade Pass√©</h3>
                <span class="close" onclick="closeHistoryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="historyTradeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date du Trade</label>
                            <input type="date" id="tradeDate" required>
                        </div>
                        <div class="form-group">
                            <label>Paire</label>
                            <select id="tradePair" required>
                                <option value="EUR/USD">EUR/USD</option>
                                <option value="GBP/USD">GBP/USD</option>
                                <option value="USD/JPY">USD/JPY</option>
                                <option value="AUD/USD">AUD/USD</option>
                                <option value="USD/CHF">USD/CHF</option>
                                <option value="NZD/USD">NZD/USD</option>
                                <option value="USD/CAD">USD/CAD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type</label>
                            <select id="tradeType" required>
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Taille (lots)</label>
                            <input type="number" id="tradeSize" step="0.01" min="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Prix d'Entr√©e</label>
                            <input type="number" id="entryPrice" step="0.00001" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>R√©sultat Final</label>
                            <select id="tradeResult" required>
                                <option value="TP">Take Profit (TP)</option>
                                <option value="SL">Stop Loss (SL)</option>
                                <option value="BE">Break Even (BE)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>P&L ($)</label>
                            <input type="number" id="tradePnL" step="0.01" placeholder="Sera calcul√© automatiquement">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Stop Loss</label>
                            <input type="number" id="stopLoss" step="0.00001" required>
                        </div>
                        <div class="form-group">
                            <label>Take Profit</label>
                            <input type="number" id="takeProfit" step="0.00001" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes (optionnel)</label>
                        <textarea id="tradeNotes" placeholder="Analyse du trade..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeHistoryModal()" class="btn-secondary">Annuler</button>
                        <button type="button" class="btn-primary" onclick="addHistoryTrade()">Ajouter le Trade</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="simple-vip-security.js"></script>
    <script src="mobile-menu.js"></script>
    <script src="mobile-optimizations.js"></script>
    <script src="dashboard-script-working.js"></script>
    <script>
        document.getElementById('historyTradeBtn').addEventListener('click', () => {
            document.getElementById('historyTradeModal').style.display = 'block';
            document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
        });

        function closeHistoryModal() {
            document.getElementById('historyTradeModal').style.display = 'none';
            document.getElementById('historyTradeForm').reset();
        }
        
        window.closeHistoryModal = closeHistoryModal;

        function calculatePnL() {
            const entryPrice = parseFloat(document.getElementById('entryPrice').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);
            const size = parseFloat(document.getElementById('tradeSize').value);
            const type = document.getElementById('tradeType').value;
            const pair = document.getElementById('tradePair').value;
            const result = document.getElementById('tradeResult').value;

            if (entryPrice && stopLoss && takeProfit && size && result) {
                let exitPrice = 0;
                
                // D√©terminer le prix de sortie selon le r√©sultat
                if (result === 'TP') {
                    exitPrice = takeProfit;
                } else if (result === 'SL') {
                    exitPrice = stopLoss;
                } else if (result === 'BE') {
                    exitPrice = entryPrice;
                }
                
                let pnl = 0;
                
                // Calcul du P&L
                if (type === 'BUY') {
                    pnl = (exitPrice - entryPrice) * size * 100000;
                } else {
                    pnl = (entryPrice - exitPrice) * size * 100000;
                }
                
                // Ajustement pour les paires JPY
                if (pair.includes('JPY')) {
                    pnl = pnl / 100;
                }
                
                document.getElementById('tradePnL').value = pnl.toFixed(2);
            }
        }

        ['entryPrice', 'stopLoss', 'takeProfit', 'tradeSize', 'tradeType', 'tradePair', 'tradeResult'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculatePnL);
            document.getElementById(id).addEventListener('change', calculatePnL);
        });

        function addHistoryTrade() {
            console.log('addHistoryTrade called');
            
            try {
                const entryPrice = parseFloat(document.getElementById('entryPrice').value);
                const stopLoss = parseFloat(document.getElementById('stopLoss').value);
                const takeProfit = parseFloat(document.getElementById('takeProfit').value);
                const result = document.getElementById('tradeResult').value;
                
                let closePrice = entryPrice;
                if (result === 'TP') closePrice = takeProfit;
                if (result === 'SL') closePrice = stopLoss;
                
                const tradeData = {
                    id: `trader_vip_${Date.now()}`,
                    date: document.getElementById('tradeDate').value,
                    currency: document.getElementById('tradePair').value,
                    type: document.getElementById('tradeType').value,
                    lotSize: parseFloat(document.getElementById('tradeSize').value),
                    entryPoint: entryPrice,
                    stopLoss: stopLoss,
                    takeProfit: takeProfit,
                    closePrice: closePrice,
                    pnl: parseFloat(document.getElementById('tradePnL').value),
                    result: result,
                    notes: document.getElementById('tradeNotes').value,
                    status: 'closed',
                    createdAt: Date.now(),
                    isHistorical: true
                };

                console.log('Trade data:', tradeData);
                console.log('Dashboard exists:', !!window.dashboard);

                if (window.dashboard) {
                    window.dashboard.trades.push(tradeData);
                    window.dashboard.saveData();
                    window.dashboard.updateStats();
                    window.dashboard.renderTradesTable();
                    window.dashboard.renderCalendar();
                    
                    // D√©truire tous les graphiques Chart.js existants
                    Object.values(Chart.instances).forEach(chart => chart.destroy());
                    
                    // Recr√©er les graphiques
                    setTimeout(() => {
                        window.dashboard.initCharts();
                        window.dashboard.initGauge();
                        window.dashboard.updateCalendarStats();
                    }, 100);
                    
                    console.log('Dashboard updated');
                }
                
                console.log('Closing modal');
                const modal = document.getElementById('historyTradeModal');
                const form = document.getElementById('historyTradeForm');
                
                if (modal) {
                    modal.style.display = 'none';
                    console.log('Modal closed');
                }
                
                if (form) {
                    form.reset();
                    console.log('Form reset');
                }
                
                alert('Trade pass√© ajout√©!');
                
            } catch (error) {
                console.error('Error in addHistoryTrade:', error);
                alert('Erreur: ' + error.message);
            }
        }
        
        window.addHistoryTrade = addHistoryTrade;

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('historyTradeModal');
            if (e.target === modal) {
                closeHistoryModal();
            }
        });
    </script>

    <style>
        /* CSS EMOJI PANEL - ULTRA SIMPLE */
        .emoji-picker-panel {
            position: absolute !important;
            bottom: 50px !important;
            left: 0 !important;
            width: 300px !important;
            max-height: 400px !important;
            background: #1a1a2e !important;
            border: 2px solid #00d4ff !important;
            border-radius: 10px !important;
            z-index: 9999 !important;
            display: none !important;
            overflow: hidden !important;
        }
        
        .emoji-header {
            padding: 10px !important;
            background: rgba(0, 212, 255, 0.1) !important;
            border-bottom: 1px solid #00d4ff !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }
        
        .emoji-title {
            color: #00d4ff !important;
            font-weight: bold !important;
            font-size: 14px !important;
        }
        
        .emoji-close {
            background: none !important;
            border: none !important;
            color: #ff6b6b !important;
            font-size: 18px !important;
            cursor: pointer !important;
            padding: 0 !important;
            width: 20px !important;
            height: 20px !important;
        }
        
        .emoji-grid {
            padding: 10px !important;
            display: grid !important;
            grid-template-columns: repeat(8, 1fr) !important;
            gap: 5px !important;
            max-height: 250px !important;
            overflow-y: auto !important;
        }
        
        .emoji-item {
            background: none !important;
            border: none !important;
            font-size: 20px !important;
            padding: 8px !important;
            cursor: pointer !important;
            border-radius: 5px !important;
            transition: all 0.2s ease !important;
        }
        
        .emoji-item:hover {
            background: rgba(0, 212, 255, 0.2) !important;
            transform: scale(1.2) !important;
        }
        
        .emoji-footer {
            padding: 8px 10px !important;
            background: rgba(0, 212, 255, 0.05) !important;
            border-top: 1px solid rgba(0, 212, 255, 0.2) !important;
            font-size: 12px !important;
            color: #888 !important;
            text-align: center !important;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #00d4ff;
        }

        .modal-body {
            padding: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #00d4ff;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
    
    <!-- Bouton de retour VIP -->
    <div style="position: fixed; top: 20px; left: 20px; z-index: 500;">
        <button onclick="window.location.href='vip-space.html'" style="background: rgba(0, 212, 255, 0.8); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">üîô Retour VIP</button>
    </div>
    

    
    <!-- Bouton Chat Flottant -->
    <div id="chatToggle" class="chat-toggle">
        üí¨
        <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
    </div>
    
    <!-- Fen√™tre Chat Flottante -->
    <div id="chatWindow" class="chat-window">
        <div class="chat-header">
            <h4>üí¨ Chat VIP</h4>
            <div class="chat-controls">
                <button id="chatSettingsBtn" class="chat-settings-btn">‚öôÔ∏è</button>
                <button id="closeChatBtn" class="close-chat-btn">√ó</button>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <div class="chat-toolbar">
                <button class="tool-btn" id="emojiToggle" onclick="window.toggleEmojiPanel(); console.log('Bouton emoji cliqu√©');">üòÄ</button>
                <button class="tool-btn" id="fileBtn">üìÅ</button>
                <button class="tool-btn" id="gifBtn">GIF</button>
            </div>
            <div class="emoji-picker-panel" id="emojiPanel">
                <div class="emoji-header">
                    <span class="emoji-title">Choisir un emoji</span>
                    <button class="emoji-close" id="emojiClose" onclick="document.getElementById('emojiPanel').style.display='none'; console.log('Fermeture emoji panel');">√ó</button>
                </div>
                <div class="emoji-categories">
                    <button class="emoji-cat active" onclick="window.loadSimpleEmojis()" title="Tous les emojis">üòÄ</button>
                </div>
                <div class="emoji-search">
                    <input type="text" id="emojiSearch" placeholder="Rechercher..." maxlength="20">
                </div>
                <div class="emoji-grid" id="emojiGrid"></div>
                <div class="emoji-footer">
                    <span class="emoji-count" id="emojiCount">0 emojis</span>
                </div>
            </div>
            <input type="file" id="fileInput" accept="image/*,audio/*" style="display: none;">
            <div class="input-container">
                <input type="text" id="chatInput" placeholder="Tapez votre message..." maxlength="200">
                <button id="sendMessage" class="send-btn" type="button">üì§</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Pseudo -->
    <div id="nicknameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ Choisir votre pseudo</h3>
            </div>
            <div class="modal-body">
                <p>Choisissez un pseudo pour le chat et le classement :</p>
                <input type="text" id="nicknameInput" placeholder="Votre pseudo..." maxlength="20">
                <div class="form-actions">
                    <button id="saveNickname" class="btn-primary">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // EMOJIS - Version Ultra Simple qui Fonctionne
        window.toggleEmojiPanel = function() {
            console.log('üéØ Toggle emoji appel√©');
            const panel = document.getElementById('emojiPanel');
            if (panel) {
                const isVisible = panel.style.display === 'block';
                if (isVisible) {
                    panel.style.display = 'none';
                    console.log('‚úÖ Panel emoji: ferm√©');
                } else {
                    panel.style.display = 'block';
                    panel.style.position = 'absolute';
                    panel.style.bottom = '50px';
                    panel.style.left = '0';
                    panel.style.zIndex = '9999';
                    window.loadSimpleEmojis();
                    console.log('‚úÖ Panel emoji: ouvert avec styles forc√©s');
                }
            } else {
                console.error('‚ùå Panel emoji introuvable');
            }
        };
        
        window.addEmojiToChat = function(emoji) {
            console.log('üéØ Ajout emoji au chat:', emoji);
            const input = document.getElementById('chatInput');
            if (input) {
                input.value += emoji;
                input.focus();
                console.log('‚úÖ Emoji ajout√©, input value:', input.value);
            } else {
                console.error('‚ùå Input chat introuvable');
            }
            const panel = document.getElementById('emojiPanel');
            if (panel) {
                panel.style.display = 'none';
                console.log('‚úÖ Panel ferm√© apr√®s ajout');
            }
        };
        
        window.loadSimpleEmojis = function() {
            const grid = document.getElementById('emojiGrid');
            if (!grid) {
                console.error('‚ùå Grid emoji introuvable');
                return;
            }
            
            const emojis = ['üòÄ', 'üòÅ', 'üòÇ', 'ü§£', 'üòÉ', 'üòÑ', 'üòÖ', 'üòÜ', 'üòâ', 'üòä', 'üòã', 'üòé', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üôÇ', 'ü§ó', 'ü§î', 'üòê', 'üòë', 'üò∂', 'üôÑ', 'üòè', 'üò£', 'üò•', 'üòÆ', 'ü§ê', 'üëç', 'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'üëä', '‚úä', 'üëè', 'üôè', 'üí™', '‚ù§Ô∏è', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'üí∞', 'üöÄ', 'üéâ'];
            
            grid.innerHTML = '';
            emojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-item';
                btn.textContent = emoji;
                btn.style.cssText = 'background: none !important; border: none !important; font-size: 20px !important; padding: 8px !important; cursor: pointer !important; border-radius: 5px !important;';
                btn.onclick = function() { 
                    console.log('üéØ Emoji cliqu√©:', emoji);
                    window.addEmojiToChat(emoji); 
                };
                btn.onmouseover = function() {
                    btn.style.background = 'rgba(0, 212, 255, 0.2) !important';
                    btn.style.transform = 'scale(1.2)';
                };
                btn.onmouseout = function() {
                    btn.style.background = 'none !important';
                    btn.style.transform = 'scale(1)';
                };
                grid.appendChild(btn);
            });
            
            // Mettre √† jour le compteur
            const emojiCount = document.getElementById('emojiCount');
            if (emojiCount) {
                emojiCount.textContent = `${emojis.length} emojis`;
            }
            
            console.log('‚úÖ Emojis charg√©s avec styles:', emojis.length);
        };
        
        // Initialiser d√®s que possible
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                console.log('üöÄ Initialisation emojis...');
                window.loadSimpleEmojis();
            }, 1000);
        });
        
        // Gestionnaire du classement VIP simplifi√©
        class VIPRanking {
            constructor() {
                this.currentUser = sessionStorage.getItem('firebaseUID') || 'trader_vip';
                this.userEmail = sessionStorage.getItem('userEmail') || 'Utilisateur';
                this.loadRanking();
                
                // Actualiser plus fr√©quemment (toutes les 10 secondes)
                setInterval(() => this.loadRanking(), 10000);
                
                // √âcouter les changements Firebase en temps r√©el
                this.setupRealtimeListener();
            }
            
            async setupRealtimeListener() {
                try {
                    if (window.firebaseDB) {
                        const { ref, onValue } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        
                        // √âcouter les changements sur les donn√©es de trading
                        const tradingDataRef = ref(window.firebaseDB, 'trading_data');
                        onValue(tradingDataRef, () => {
                            console.log('Trading data changed, updating ranking...');
                            this.loadRanking();
                        });
                        
                        // √âcouter les changements sur les utilisateurs
                        const usersRef = ref(window.firebaseDB, 'users');
                        onValue(usersRef, () => {
                            console.log('Users data changed, updating ranking...');
                            this.loadRanking();
                        });
                    }
                } catch (error) {
                    console.error('Error setting up realtime listener:', error);
                }
            }
            
            async loadRanking() {
                const rankingList = document.getElementById('rankingList');
                
                try {
                    rankingList.innerHTML = '<div class="ranking-loading">üîÑ Chargement...</div>';
                    
                    if (window.firebaseDB) {
                        const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        const usersRef = ref(window.firebaseDB, 'users');
                        const snapshot = await get(usersRef);
                        
                        if (snapshot.exists()) {
                            const users = snapshot.val();
                            const rankings = await this.calculateRankings(users);
                            this.displayRanking(rankings);
                        } else {
                            this.showFallbackRanking();
                        }
                    } else {
                        this.showFallbackRanking();
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    this.showFallbackRanking();
                }
            }
            
            async calculateRankings(users) {
                const today = new Date().toISOString().split('T')[0];
                const rankings = [];
                
                for (const [userId, userData] of Object.entries(users)) {
                    if (userData.isVIP) {
                        const { dailyPnL, tradeCount } = await this.getUserStats(userId, today);
                        const displayName = await this.getDisplayNameForUser(userId, userData.email);
                        rankings.push({
                            name: displayName,
                            dailyPnL,
                            tradeCount,
                            userId
                        });
                    }
                }
                
                rankings.sort((a, b) => b.dailyPnL - a.dailyPnL);
                return rankings;
            }
            
            async getUserStats(userId, date) {
                try {
                    if (window.firebaseDB) {
                        const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        
                        // Essayer plusieurs chemins possibles pour les trades
                        const paths = [
                            `dashboards/${userId}/trades`,
                            `trading_data/${userId}/trades`,
                            `users/${userId}/trades`,
                            `trades/${userId}`,
                            `user_trades/${userId}`,
                            `dashboards/${userId}`
                        ];
                        
                        for (const path of paths) {
                            const tradesRef = ref(window.firebaseDB, path);
                            const snapshot = await get(tradesRef);
                            
                            if (snapshot.exists()) {
                                const data = snapshot.val();
                                let trades = [];
                                
                                // Si c'est un objet avec une propri√©t√© trades
                                if (data.trades && Array.isArray(data.trades)) {
                                    trades = data.trades;
                                } else if (data.trades && typeof data.trades === 'object') {
                                    trades = Object.values(data.trades);
                                } else if (Array.isArray(data)) {
                                    trades = data;
                                } else if (typeof data === 'object') {
                                    // Essayer de trouver des trades dans l'objet
                                    trades = Object.values(data).filter(item => 
                                        item && typeof item === 'object' && item.currency && item.date
                                    );
                                }
                                
                                const todayTrades = trades.filter(trade => {
                                    return trade && trade.date === date && 
                                           (trade.status === 'closed' || trade.status === 'completed');
                                });
                                const dailyPnL = todayTrades.reduce((total, trade) => {
                                    return total + (parseFloat(trade.pnl) || 0);
                                }, 0);
                                console.log(`Found ${todayTrades.length} trades for ${userId} on ${date}, P&L: ${dailyPnL}`);
                                return { dailyPnL, tradeCount: todayTrades.length };
                            }
                        }
                        
                        // Si aucun chemin ne fonctionne, v√©rifier les donn√©es locales
                        const possibleKeys = [
                            `dashboard_${userId}`,
                            `trading_${userId}`,
                            `user_${userId}`,
                            userId
                        ];
                        
                        for (const key of possibleKeys) {
                            const localData = localStorage.getItem(key);
                            if (localData) {
                                try {
                                    const data = JSON.parse(localData);
                                    let trades = [];
                                    
                                    if (data.trades && Array.isArray(data.trades)) {
                                        trades = data.trades;
                                    } else if (data.trades && typeof data.trades === 'object') {
                                        trades = Object.values(data.trades);
                                    }
                                    
                                    if (trades.length > 0) {
                                        const todayTrades = trades.filter(trade => {
                                            return trade && trade.date === date && 
                                                   (trade.status === 'closed' || trade.status === 'completed');
                                        });
                                        const dailyPnL = todayTrades.reduce((total, trade) => {
                                            return total + (parseFloat(trade.pnl) || 0);
                                        }, 0);
                                        console.log(`Found ${todayTrades.length} local trades for ${userId} on ${date}, P&L: ${dailyPnL}`);
                                        return { dailyPnL, tradeCount: todayTrades.length };
                                    }
                                } catch (e) {
                                    console.warn(`Error parsing localStorage for key ${key}:`, e);
                                }
                            }
                        }
                    }
                    return { dailyPnL: 0, tradeCount: 0 };
                } catch (error) {
                    console.error(`Error getting stats for ${userId}:`, error);
                    return { dailyPnL: 0, tradeCount: 0 };
                }
            }
            
            async getDisplayName(email) {
                const fullUID = sessionStorage.getItem('firebaseUID') || this.currentUser;
                
                try {
                    if (window.firebaseDB) {
                        const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        const nicknameRef = ref(window.firebaseDB, `users/${fullUID}/nickname`);
                        const snapshot = await get(nicknameRef);
                        
                        if (snapshot.exists()) {
                            return snapshot.val();
                        }
                    }
                } catch (error) {
                    console.error('Erreur r√©cup√©ration pseudo:', error);
                }
                
                if (!email) return 'Membre VIP';
                const name = email.split('@')[0];
                return name.charAt(0).toUpperCase() + name.slice(1);
            }
            
            async getDisplayNameForUser(userId, email) {
                try {
                    if (window.firebaseDB) {
                        const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        const nicknameRef = ref(window.firebaseDB, `users/${userId}/nickname`);
                        const snapshot = await get(nicknameRef);
                        
                        if (snapshot.exists()) {
                            return snapshot.val();
                        }
                    }
                } catch (error) {
                    console.error('Erreur r√©cup√©ration pseudo:', error);
                }
                
                if (!email) return 'Membre VIP';
                const name = email.split('@')[0];
                return name.charAt(0).toUpperCase() + name.slice(1);
            }
            
            displayRanking(rankings) {
                const rankingList = document.getElementById('rankingList');
                
                console.log('Displaying ranking:', rankings);
                
                if (rankings.length === 0) {
                    rankingList.innerHTML = '<div class="ranking-loading">Aucune donn√©e aujourd\'hui</div>';
                    return;
                }
                
                let html = '';
                rankings.forEach((trader, index) => {
                    const isCurrentUser = trader.userId === this.currentUser;
                    const userClass = isCurrentUser ? ' current-user' : '';
                    
                    // Appliquer directement les couleurs
                    let pnlColor = '#ffc107'; // jaune pour neutre
                    if (trader.dailyPnL > 0) pnlColor = '#00ff00'; // vert pour positif
                    if (trader.dailyPnL < 0) pnlColor = '#ff0000'; // rouge pour n√©gatif
                    
                    html += `
                        <div class="ranking-item${userClass}">
                            <span class="trader-name">${trader.name}${isCurrentUser ? ' (Vous)' : ''}</span>
                            <span class="trade-count">${trader.tradeCount} trades</span>
                            <span class="trader-pnl" style="color: ${pnlColor} !important;">$${trader.dailyPnL.toFixed(2)}</span>
                        </div>
                    `;
                });
                
                rankingList.innerHTML = html;
            }
            
            showFallbackRanking() {
                const demoRankings = [
                    { name: 'Trader Pro', dailyPnL: 250.50, tradeCount: 8 },
                    { name: 'Expert FX', dailyPnL: 180.25, tradeCount: 5 },
                    { name: 'Master Pips', dailyPnL: 120.75, tradeCount: 12 },
                    { name: this.getDisplayName(this.userEmail), dailyPnL: 0, tradeCount: 0 },
                    { name: 'Scalper King', dailyPnL: -45.30, tradeCount: 15 }
                ];
                
                demoRankings.sort((a, b) => b.dailyPnL - a.dailyPnL);
                this.displayRanking(demoRankings);
            }
        }
        
        // Enregistrer le service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
                    })
                    .catch(error => {
                        console.error('‚ùå Erreur Service Worker:', error);
                    });
            });
        }
        
        // Initialiser le classement VIP quand la page est charg√©e
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                new VIPRanking();
                new VIPChat();
                
                // Test direct des emojis
                setTimeout(() => {
                    console.log('Test direct des emojis...');
                    const emojiToggle = document.getElementById('emojiToggle');
                    const emojiPanel = document.getElementById('emojiPanel');
                    console.log('EmojiToggle:', emojiToggle);
                    console.log('EmojiPanel:', emojiPanel);
                    
                    if (emojiToggle && emojiPanel) {
                        console.log('Elements trouv√©s, initialisation directe...');
                        setupEmojisDirect();
                    }
                }, 2000);
            }, 1000);
        });
        
        // Fonctions emoji simplifi√©es d√©j√† d√©finies plus haut
        
        function loadBasicEmojis() {
            const emojiGrid = document.getElementById('emojiGrid');
            if (!emojiGrid) return;
            
            const basicEmojis = ['üòÄ', 'üòÅ', 'üòÇ', 'ü§£', 'üòÉ', 'üòÑ', 'üòÖ', 'üòÜ', 'üòâ', 'üòä', 'üòã', 'üòé', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üôÇ', 'ü§ó', 'ü§î', 'üòê', 'üòë', 'üò∂', 'üôÑ', 'üòè', 'üò£', 'üò•', 'üòÆ', 'ü§ê', 'üëç', 'üëé', 'üëå', '‚ù§Ô∏è', 'üíö', 'üíô', 'üíú', 'üí∞', 'üöÄ', 'üéâ', 'üéÜ', 'üéà'];
            
            emojiGrid.innerHTML = '';
            basicEmojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-item';
                btn.textContent = emoji;
                btn.onclick = function() {
                    addEmojiToChat(emoji);
                };
                emojiGrid.appendChild(btn);
            });
        }
        
        // Setup direct des emojis
        function setupEmojisDirect() {
            console.log('Setup emojis direct...');
            loadBasicEmojis();
        }
        
        // Syst√®me de Chat VIP
        class VIPChat {
            constructor() {
                this.currentUser = sessionStorage.getItem('firebaseUID') || 'trader_vip';
                this.soundEnabled = localStorage.getItem('chatSoundEnabled') !== 'false';
                this.pushEnabled = localStorage.getItem('chatPushEnabled') !== 'false';
                this.init();
            }
            
            async init() {
                this.nickname = await this.getNickname();
                await this.requestNotificationPermission();
                await this.setupFCM();
                this.setupChat();
                this.loadMessages();
                this.setupRealtimeListener();
                this.scheduleReset();
            }
            
            async requestNotificationPermission() {
                if ('Notification' in window && 'serviceWorker' in navigator) {
                    try {
                        // Enregistrer le service worker
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.log('Service Worker enregistr√©:', registration);
                        
                        if (Notification.permission === 'default') {
                            const permission = await Notification.requestPermission();
                            this.pushEnabled = permission === 'granted';
                            localStorage.setItem('chatPushEnabled', this.pushEnabled);
                        } else {
                            this.pushEnabled = Notification.permission === 'granted';
                        }
                    } catch (error) {
                        console.error('Erreur Service Worker:', error);
                        this.pushEnabled = false;
                    }
                }
            }
            
            async setupFCM() {
                try {
                    // Enregistrer le service worker FCM
                    const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                    
                    // Obtenir le token FCM
                    const token = await getToken(messaging, {
                        vapidKey: 'BBJatJBegeXBJjoYq_d7vIxpfIZn0qejbtQ31Fdgz7HzTk7NU-sfgjNsRsgDDxzIUpzr4chavlwjCBTgYHhheCY',
                        serviceWorkerRegistration: registration
                    });
                    
                    if (token) {
                        console.log('üî• Token FCM:', token);
                        // Sauvegarder le token pour l'utilisateur
                        const userRef = ref(db, `users/${this.currentUser}/fcmToken`);
                        await set(userRef, token);
                    }
                    
                    // √âcouter les messages en premier plan
                    onMessage(messaging, (payload) => {
                        console.log('üì± Message FCM re√ßu:', payload);
                        this.showNotification(payload.notification.title, payload.notification.body);
                    });
                    
                } catch (error) {
                    console.error('‚ùå Erreur FCM:', error);
                }
            }
            
            async getNickname() {
                const fullUID = sessionStorage.getItem('firebaseUID') || this.currentUser;
                
                try {
                    if (window.firebaseDB) {
                        const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        const nicknameRef = ref(window.firebaseDB, `users/${fullUID}/nickname`);
                        const snapshot = await get(nicknameRef);
                        
                        if (snapshot.exists()) {
                            const nickname = snapshot.val();
                            localStorage.setItem(`nickname_cache_${fullUID}`, nickname);
                            return nickname;
                        } else {
                            // V√©rifier le cache avant de demander
                            const cachedNickname = localStorage.getItem(`nickname_cache_${fullUID}`);
                            if (cachedNickname) {
                                // Sauvegarder dans Firebase pour la prochaine fois
                                try {
                                    const { set } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                                    await set(nicknameRef, cachedNickname);
                                } catch (saveError) {
                                    console.error('Error saving cached nickname to Firebase:', saveError);
                                }
                                return cachedNickname;
                            }
                            
                            const nickname = await this.promptForNickname();
                            return nickname;
                        }
                    }
                } catch (error) {
                    console.error('Erreur r√©cup√©ration pseudo:', error);
                    const cachedNickname = localStorage.getItem(`nickname_cache_${fullUID}`);
                    if (cachedNickname) {
                        return cachedNickname;
                    }
                }
                
                return 'Membre VIP';
            }
            
            promptForNickname() {
                return new Promise((resolve) => {
                    const modal = document.getElementById('nicknameModal');
                    modal.style.display = 'block';
                    
                    document.getElementById('saveNickname').onclick = async () => {
                        const nickname = document.getElementById('nicknameInput').value.trim();
                        if (nickname) {
                            const fullUID = sessionStorage.getItem('firebaseUID') || this.currentUser;
                            
                            try {
                                if (window.firebaseDB) {
                                    const { ref, set } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                                    const nicknameRef = ref(window.firebaseDB, `users/${fullUID}/nickname`);
                                    await set(nicknameRef, nickname);
                                    // Mettre en cache
                                    localStorage.setItem(`nickname_cache_${fullUID}`, nickname);
                                }
                                
                                modal.style.display = 'none';
                                resolve(nickname);
                            } catch (error) {
                                console.error('Erreur sauvegarde pseudo:', error);
                                alert('Erreur lors de la sauvegarde du pseudo');
                            }
                        }
                    };
                });
            }
            
            showNicknameModal() {
                const modal = document.getElementById('nicknameModal');
                modal.style.display = 'block';
                
                document.getElementById('saveNickname').onclick = async () => {
                    const nickname = document.getElementById('nicknameInput').value.trim();
                    if (nickname) {
                        const fullUID = sessionStorage.getItem('firebaseUID') || this.currentUser;
                        
                        try {
                            if (window.firebaseDB) {
                                const { ref, set } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                                const nicknameRef = ref(window.firebaseDB, `users/${fullUID}/nickname`);
                                await set(nicknameRef, nickname);
                                // Mettre √† jour le cache
                                localStorage.setItem(`nickname_cache_${fullUID}`, nickname);
                            }
                            
                            this.nickname = nickname;
                            modal.style.display = 'none';
                        } catch (error) {
                            console.error('Erreur sauvegarde pseudo:', error);
                            alert('Erreur lors de la sauvegarde du pseudo');
                        }
                    }
                };
            }
            
            setupChat() {
                const sendBtn = document.getElementById('sendMessage');
                const chatInput = document.getElementById('chatInput');
                const chatToggle = document.getElementById('chatToggle');
                const chatWindow = document.getElementById('chatWindow');
                const closeChatBtn = document.getElementById('closeChatBtn');
                
                if (!sendBtn || !chatInput || !chatToggle || !chatWindow || !closeChatBtn) {
                    console.error('√âl√©ments chat manquants');
                    return;
                }
                
                this.messageCount = 0;
                this.lastMessageTime = parseInt(localStorage.getItem('lastChatCheck')) || 0;
                
                // Initialiser le badge
                const badge = document.getElementById('chatBadge');
                if (badge) {
                    this.unreadCount = 0;
                    badge.textContent = '0';
                    badge.style.display = 'none';
                    badge.classList.add('pulse-animation');
                }
                
                // Gestionnaires d'√©v√©nements avec v√©rifications
                sendBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });
                
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Emp√™cher le zoom sur focus (mobile)
                chatInput.addEventListener('focus', () => {
                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        document.querySelector('meta[name=viewport]').setAttribute('content', 
                            'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                    }
                });
                
                chatInput.addEventListener('blur', () => {
                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        document.querySelector('meta[name=viewport]').setAttribute('content', 
                            'width=device-width, initial-scale=1.0');
                    }
                });
                
                chatToggle.addEventListener('click', () => {
                    const isOpening = !chatWindow.classList.contains('show');
                    chatWindow.classList.toggle('show');
                    
                    if (isOpening) {
                        this.resetBadge();
                        this.markMessagesAsRead();
                        // Focus sur l'input apr√®s ouverture
                        setTimeout(() => {
                            chatInput.focus();
                            // Scroll vers le bas
                            const chatMessages = document.getElementById('chatMessages');
                            if (chatMessages) {
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        }, 300);
                    }
                });
                
                closeChatBtn.addEventListener('click', () => {
                    chatWindow.classList.remove('show');
                });
                
                const chatSettingsBtn = document.getElementById('chatSettingsBtn');
                if (chatSettingsBtn) {
                    chatSettingsBtn.addEventListener('click', () => {
                        this.showSettings();
                    });
                }
                
                // Fermer le chat en touchant en dehors (mobile)
                chatWindow.addEventListener('click', (e) => {
                    if (e.target === chatWindow) {
                        chatWindow.classList.remove('show');
                    }
                });
                
                // Initialiser les nouvelles fonctionnalit√©s
                setTimeout(() => {
                    try {
                        console.log('Initialisation des fonctionnalit√©s chat...');
                        window.vipChat = this;
                        console.log('Fonctionnalit√©s chat initialis√©es');
                    } catch (error) {
                        console.error('Erreur initialisation fonctionnalit√©s chat:', error);
                    }
                }, 500);
            }
            
            async sendMessage() {
                const input = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendMessage');
                const message = input.value.trim();
                
                if (!message) return;
                
                // D√©sactiver temporairement le bouton pour √©viter les doublons
                sendBtn.disabled = true;
                sendBtn.style.opacity = '0.6';
                
                const messageData = {
                    id: Date.now(),
                    userId: this.currentUser,
                    nickname: this.nickname,
                    message: message,
                    timestamp: Date.now(),
                    date: new Date().toISOString().split('T')[0]
                };
                
                try {
                    // Vider imm√©diatement l'input pour un feedback rapide
                    input.value = '';
                    
                    if (window.firebaseDB) {
                        const { ref, push } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        const messagesRef = ref(window.firebaseDB, 'vip_chat');
                        await push(messagesRef, messageData);
                        
                        // Envoyer notification push aux autres utilisateurs
                        await this.sendPushNotification(messageData);
                    } else {
                        // Fallback : afficher le message localement
                        this.displayLocalMessage(messageData);
                    }
                } catch (error) {
                    console.error('Erreur envoi message:', error);
                    // Restaurer le message en cas d'erreur
                    input.value = message;
                    alert('Erreur lors de l\'envoi du message. Veuillez r√©essayer.');
                } finally {
                    // R√©activer le bouton apr√®s 1 seconde
                    setTimeout(() => {
                        sendBtn.disabled = false;
                        sendBtn.style.opacity = '1';
                    }, 1000);
                }
            }
            
            displayLocalMessage(messageData) {
                const chatMessages = document.getElementById('chatMessages');
                const time = new Date(messageData.timestamp).toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message message-own';
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-nickname">${messageData.nickname}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">${messageData.message}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            async loadMessages() {
                try {
                    if (window.firebaseDB) {
                        const { ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        const messagesRef = ref(window.firebaseDB, 'vip_chat');
                        const snapshot = await get(messagesRef);
                        
                        if (snapshot.exists()) {
                            const messages = Object.values(snapshot.val());
                            const today = new Date().toISOString().split('T')[0];
                            const todayMessages = messages.filter(msg => msg.date === today);
                            this.displayMessages(todayMessages);
                        }
                    }
                } catch (error) {
                    console.error('Erreur chargement messages:', error);
                }
            }
            
            async setupRealtimeListener() {
                try {
                    if (window.firebaseDB) {
                        const { ref, onValue } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        const messagesRef = ref(window.firebaseDB, 'vip_chat');
                        
                        onValue(messagesRef, (snapshot) => {
                            if (snapshot.exists()) {
                                const messages = Object.values(snapshot.val());
                                const today = new Date().toISOString().split('T')[0];
                                const todayMessages = messages.filter(msg => msg.date === today);
                                this.displayMessages(todayMessages);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Erreur listener temps r√©el:', error);
                }
            }
            
            displayMessages(messages) {
                const chatMessages = document.getElementById('chatMessages');
                messages.sort((a, b) => a.timestamp - b.timestamp);
                
                // Compter les nouveaux messages
                const newMessages = messages.filter(msg => 
                    msg.timestamp > this.lastMessageTime && msg.userId !== this.currentUser
                );
                
                const chatWindow = document.getElementById('chatWindow');
                const isChatOpen = chatWindow && chatWindow.classList.contains('show');
                
                if (newMessages.length > 0) {
                    if (!isChatOpen) {
                        this.updateBadge(newMessages.length);
                        this.playNotificationSound();
                        this.showPushNotification(newMessages[newMessages.length - 1]);
                    } else {
                        // Si le chat est ouvert, marquer comme lu automatiquement
                        this.markMessagesAsRead();
                    }
                }
                
                let html = '';
                messages.forEach(msg => {
                    const time = new Date(msg.timestamp).toLocaleTimeString('fr-FR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const isCurrentUser = msg.userId === this.currentUser;
                    const messageClass = isCurrentUser ? 'message-own' : 'message-other';
                    
                    let content = '';
                    if (msg.file) {
                        if (msg.file.type.startsWith('image/')) {
                            content = `<img src="${msg.file.data}" alt="${msg.file.name}" class="message-image">`;
                        } else if (msg.file.type.startsWith('audio/')) {
                            content = `<audio controls class="message-audio"><source src="${msg.file.data}" type="${msg.file.type}"></audio>`;
                        } else {
                            content = `<div class="message-file">üìÅ ${msg.file.name}</div>`;
                        }
                    } else if (msg.message.includes('[GIF:')) {
                        const gifUrl = msg.message.match(/\[GIF:(.+?)\]/)?.[1];
                        if (gifUrl) {
                            content = `<img src="${gifUrl}" alt="GIF" class="message-gif">`;
                        } else {
                            content = msg.message;
                        }
                    } else {
                        content = msg.message;
                    }
                    
                    html += `
                        <div class="chat-message ${messageClass}">
                            <div class="message-header">
                                <span class="message-nickname">${msg.nickname}</span>
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-content">${content}</div>
                        </div>
                    `;
                });
                
                chatMessages.innerHTML = html;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Mettre √† jour le timestamp de derni√®re v√©rification
                if (messages.length > 0) {
                    this.lastMessageTime = Math.max(...messages.map(m => m.timestamp));
                    localStorage.setItem('lastChatCheck', this.lastMessageTime);
                }
            }
            
            scheduleReset() {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const timeUntilMidnight = tomorrow.getTime() - now.getTime();
                
                setTimeout(() => {
                    this.resetChat();
                    setInterval(() => this.resetChat(), 24 * 60 * 60 * 1000);
                }, timeUntilMidnight);
            }
            
            async resetChat() {
                try {
                    if (window.firebaseDB) {
                        const { ref, remove } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                        const messagesRef = ref(window.firebaseDB, 'vip_chat');
                        await remove(messagesRef);
                    }
                    
                    document.getElementById('chatMessages').innerHTML = '<div class="chat-reset">üí¨ Nouveau jour, nouveau chat !</div>';
                } catch (error) {
                    console.error('Erreur reset chat:', error);
                }
            }
        }
        
        // Syst√®me d'√©mojis complet et optimis√©
        const emojiData = {
            smileys: ['üòÄ', 'üòÅ', 'üòÇ', 'ü§£', 'üòÉ', 'üòÑ', 'üòÖ', 'üòÜ', 'üòâ', 'üòä', 'üòã', 'üòé', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üôÇ', 'ü§ó', 'ü§î', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üôÑ', 'üòè', 'üò£', 'üò•', 'üòÆ', 'ü§ê', 'üòØ', 'üò™', 'üò´', 'ü•±', 'üò¥', 'üòå', 'üòõ', 'üòú', 'üòù', 'ü§§'],
            people: ['üëç', 'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'üëä', '‚úä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'üôè', '‚úçÔ∏è', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ', 'üíã', 'ü©∏'],
            nature: ['üå±', 'üåø', 'üçÄ', 'üå≥', 'üå≤', 'üå¥', 'üåµ', 'üåæ', 'üå∑', 'üå∏', 'üåπ', 'ü•Ä', 'üå∫', 'üåª', 'üåº', 'üåΩ', 'üçÑ', 'üå∞', 'üåä', 'üíß', 'üî•', '‚≠ê', 'üåü', 'üí´', '‚ö°', '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', 'üå®Ô∏è', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', 'üå¨Ô∏è', 'üí®', 'üå™Ô∏è', 'üå´Ô∏è', 'üåà'],
            food: ['üçé', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï', 'ü´í', 'üßÑ', 'üßÖ', 'ü•î', 'üç†', 'ü•ê', 'ü•ñ', 'üçû', 'ü•®', 'ü•Ø', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'üå≠', 'üçî', 'üçü', 'üçï'],
            travel: ['üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üõª', 'üöö', 'üöõ', 'üöú', 'üèçÔ∏è', 'üõµ', 'üö≤', 'üõ¥', 'üõπ', 'üõº', 'üöÅ', 'üõ∏', '‚úàÔ∏è', 'üõ©Ô∏è', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÄ', 'üõ∞Ô∏è', 'üö¢', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üöÇ', 'üöÉ', 'üöÑ', 'üöÖ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöä', 'üöù', 'üöû', 'üöã', 'üöå'],
            objects: ['üí∞', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'ü™ô', 'üí≥', 'üíé', '‚öñÔ∏è', 'ü™ú', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'üî©', '‚öôÔ∏è', 'ü™ö', 'üî´', 'üèπ', 'üõ°Ô∏è', 'ü™É', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 'üí£', 'ü™ì', 'üîÆ', 'üìø', 'üßø', 'ü™¨', '‚öóÔ∏è', 'üî≠', 'üî¨', 'üï≥Ô∏è', 'ü©π', 'ü©∫', 'üíä', 'üíâ', 'üß¨', 'ü¶†', 'üß´', 'üß™', 'üå°Ô∏è', 'üßπ', 'ü™†', 'üßΩ', 'üß¥', 'üß∑', 'üß≤', 'ü™ù'],
            symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù§Ô∏è‚Äçüî•', '‚ù§Ô∏è‚Äçü©π', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚ö°', 'üí•', 'üí´', 'üí¶', 'üí®', 'üï≥Ô∏è', 'üí¨', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üó®Ô∏è', 'üóØÔ∏è', 'üí≠', 'üí§']
        };
        
        function initEmojiPicker() {
            const emojiToggle = document.getElementById('emojiToggle');
            const emojiPanel = document.getElementById('emojiPanel');
            const emojiGrid = document.getElementById('emojiGrid');
            
            if (!emojiToggle || !emojiPanel || !emojiGrid) {
                console.warn('√âl√©ments emoji picker manquants');
                return;
            }
            
            let isOpen = false;
            
            // Charger les emojis de base
            loadEmojis('smileys');
            
            // Toggle du panel
            emojiToggle.onclick = function(e) {
                e.preventDefault();
                isOpen = !isOpen;
                emojiPanel.style.display = isOpen ? 'block' : 'none';
            };
            
            // Cat√©gories
            document.querySelectorAll('.emoji-cat').forEach(cat => {
                cat.onclick = function(e) {
                    e.preventDefault();
                    document.querySelectorAll('.emoji-cat').forEach(c => c.classList.remove('active'));
                    cat.classList.add('active');
                    loadEmojis(cat.dataset.cat);
                };
            });
            
            // Fermer en cliquant ailleurs
            document.onclick = function(e) {
                if (!emojiPanel.contains(e.target) && !emojiToggle.contains(e.target)) {
                    isOpen = false;
                    emojiPanel.style.display = 'none';
                }
            };
            
            function loadEmojis(category) {
                if (!emojiData[category]) return;
                
                emojiGrid.innerHTML = '';
                const emojis = emojiData[category];
                
                emojis.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.className = 'emoji-item';
                    btn.textContent = emoji;
                    btn.type = 'button';
                    
                    btn.onclick = function(e) {
                        e.preventDefault();
                        insertEmoji(emoji);
                    };
                    
                    emojiGrid.appendChild(btn);
                });
                
                // Mettre √† jour le compteur
                const emojiCount = document.getElementById('emojiCount');
                if (emojiCount) {
                    emojiCount.textContent = `${emojis.length} emojis`;
                }
            }
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('chatInput');
            if (input) {
                input.value += emoji;
                input.focus();
            }
            
            // Fermer le panel
            const emojiPanel = document.getElementById('emojiPanel');
            if (emojiPanel) {
                emojiPanel.style.display = 'none';
            }
        }
        
        function initFileUpload() {
            const fileBtn = document.getElementById('fileBtn');
            const fileInput = document.getElementById('fileInput');
            
            fileBtn.onclick = () => fileInput.click();
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Fichier trop volumineux (max 5MB)');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            data: e.target.result,
                            size: file.size
                        };
                        sendFileMessage(fileData);
                    };
                    reader.readAsDataURL(file);
                }
            };
        }
        
        async function sendFileMessage(fileData) {
            const messageData = {
                id: Date.now(),
                userId: window.vipChat.currentUser,
                nickname: window.vipChat.nickname,
                message: '',
                file: fileData,
                timestamp: Date.now(),
                date: new Date().toISOString().split('T')[0]
            };
            
            try {
                if (window.firebaseDB) {
                    const { ref, push } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js');
                    const messagesRef = ref(window.firebaseDB, 'vip_chat');
                    await push(messagesRef, messageData);
                }
            } catch (error) {
                console.error('Erreur envoi fichier:', error);
            }
        }
        
        function initGifSearch() {
            const gifBtn = document.getElementById('gifBtn');
            gifBtn.onclick = () => {
                const gifUrl = prompt('URL du GIF (Giphy, Tenor, etc.):');
                if (gifUrl) {
                    insertEmoji(`[GIF:${gifUrl}]`);
                }
            };
        }
        
        // Fonction d'am√©liorations suppl√©mentaires du chat
        function initChatEnhancements() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendMessage');
            const emojiClose = document.getElementById('emojiClose');
            
            // Bouton de fermeture du picker d'emojis
            if (emojiClose) {
                emojiClose.onclick = function(e) {
                    e.preventDefault();
                    document.getElementById('emojiPanel').style.display = 'none';
                };
            }
            
            // Animation du bouton d'envoi
            if (sendBtn && chatInput) {
                chatInput.oninput = function() {
                    if (chatInput.value.trim()) {
                        sendBtn.classList.add('active');
                    } else {
                        sendBtn.classList.remove('active');
                    }
                };
            }
        }
        
        function filterEmojis(query) {
            const emojiGrid = document.getElementById('emojiGrid');
            const emojiCount = document.getElementById('emojiCount');
            
            if (!query) {
                // Recharger la cat√©gorie active
                const activeCategory = document.querySelector('.emoji-cat.active');
                if (activeCategory) {
                    loadEmojis(activeCategory.dataset.cat);
                }
                return;
            }
            
            // Recherche dans tous les emojis
            const allEmojis = [];
            Object.values(emojiData).forEach(categoryEmojis => {
                allEmojis.push(...categoryEmojis);
            });
            
            // Filtrer (recherche simple par maintenant)
            const filteredEmojis = allEmojis.filter(emoji => {
                // Ici on pourrait ajouter une logique de recherche plus sophistiqu√©e
                return true; // Pour l'instant, on affiche tous les emojis
            });
            
            // Afficher les r√©sultats
            emojiGrid.innerHTML = '';
            filteredEmojis.slice(0, 50).forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-item';
                btn.textContent = emoji;
                btn.type = 'button';
                
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    insertEmoji(emoji);
                });
                
                emojiGrid.appendChild(btn);
            });
            
            if (emojiCount) {
                emojiCount.textContent = `${Math.min(filteredEmojis.length, 50)} emojis`;
            }
        }
        
        function showTypingIndicator() {
            // Placeholder pour indicateur de frappe
        }
        
        function hideTypingIndicator() {
            // Placeholder pour cacher l'indicateur
        }
        
        // Fonctions emoji simplifi√©es d√©j√† d√©finies plus haut
        
        // M√©thodes pour le badge et les notifications
        VIPChat.prototype.updateBadge = function(count) {
            const badge = document.getElementById('chatBadge');
            this.unreadCount = (this.unreadCount || 0) + count;
            
            if (this.unreadCount > 0) {
                badge.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
                badge.style.display = 'flex';
                badge.classList.add('bounce-animation');
                
                // Animation de pulsation
                setTimeout(() => {
                    badge.classList.remove('bounce-animation');
                }, 600);
            }
        };
        
        VIPChat.prototype.resetBadge = function() {
            const badge = document.getElementById('chatBadge');
            this.unreadCount = 0;
            badge.textContent = '0';
            badge.style.display = 'none';
            badge.classList.remove('bounce-animation', 'pulse-animation');
        };
        
        VIPChat.prototype.markMessagesAsRead = function() {
            this.lastMessageTime = Date.now();
            localStorage.setItem('lastChatCheck', this.lastMessageTime);
        };
        
        VIPChat.prototype.playNotificationSound = function() {
            const notificationsDisabled = localStorage.getItem('chatNotificationsDisabled') === 'true';
            if (!this.soundEnabled || notificationsDisabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log('Son de notification non disponible');
            }
        };
        
        VIPChat.prototype.showPushNotification = function(message) {
            const notificationsDisabled = localStorage.getItem('chatNotificationsDisabled') === 'true';
            if (!this.pushEnabled || !('Notification' in window) || notificationsDisabled) return;
            
            // V√©rifier si on est sur mobile et que l'app n'est pas au premier plan
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isBackground = document.hidden || document.visibilityState === 'hidden';
            const chatWindowOpen = document.getElementById('chatWindow').classList.contains('show');
            
            // Afficher la notification si :
            // - On est sur mobile ET (en arri√®re-plan OU chat ferm√©)
            // - Ou on est sur desktop et en arri√®re-plan
            // - Ou envoyer notification push si site ferm√©
            if ((isMobile && (isBackground || !chatWindowOpen)) || (!isMobile && isBackground)) {
                // Envoyer aussi une notification push pour persistance
                this.sendPushNotification(message);
                const notificationOptions = {
                    body: `${message.nickname}: ${message.message.substring(0, 50)}${message.message.length > 50 ? '...' : ''}`,
                    icon: '/Misterpips.jpg',
                    badge: '/Misterpips.jpg',
                    tag: 'vip-chat',
                    requireInteraction: false,
                    silent: false
                };
                
                // Ajouter vibration sur mobile (sauf iOS)
                if (isMobile && !isIOS) {
                    notificationOptions.vibrate = [200, 100, 200];
                }
                
                // Essayer d'utiliser le service worker d'abord
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'SHOW_NOTIFICATION',
                        title: 'üí¨ Nouveau message VIP',
                        body: notificationOptions.body,
                        icon: '/Misterpips.jpg'
                    });
                } else {
                    // Fallback vers notification normale
                    const notification = new Notification('üí¨ Nouveau message VIP', notificationOptions);
                    
                    notification.onclick = () => {
                        window.focus();
                        document.getElementById('chatWindow').classList.add('show');
                        this.resetBadge();
                        notification.close();
                    };
                    
                    // Auto-fermer apr√®s 6 secondes (plus long sur mobile)
                    setTimeout(() => notification.close(), isMobile ? 8000 : 5000);
                }
            } else {
                // Si pas de conditions pour notification locale, envoyer quand m√™me push
                this.sendPushNotification(message);
            }
        };
        
        VIPChat.prototype.sendPushNotification = async function(message) {
            try {
                // Obtenir tous les tokens FCM des utilisateurs VIP
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const tokens = [];
                    
                    Object.entries(users).forEach(([uid, userData]) => {
                        if (userData.isVIP && userData.fcmToken && uid !== this.currentUser) {
                            tokens.push(userData.fcmToken);
                        }
                    });
                    
                    if (tokens.length > 0) {
                        // Stocker la notification pour envoi via Cloud Function
                        const notificationData = {
                            title: 'üí¨ Nouveau message VIP',
                            body: `${message.nickname}: ${message.message.substring(0, 50)}${message.message.length > 50 ? '...' : ''}`,
                            tokens: tokens,
                            timestamp: Date.now(),
                            processed: false
                        };
                        
                        const pendingRef = ref(db, 'pendingNotifications');
                        await push(pendingRef, notificationData);
                    }
                }
            } catch (error) {
                console.error('Erreur envoi push notification:', error);
            }
        };
        
        VIPChat.prototype.showSettings = function() {
            const notificationsDisabled = localStorage.getItem('chatNotificationsDisabled') === 'true';
            const settingsHtml = `
                <div class="chat-settings">
                    <h4>‚öôÔ∏è Param√®tres du Chat</h4>
                    <div class="setting-item">
                        <label class="setting-label">
                            <div class="checkbox-container">
                                <input type="checkbox" id="notificationsToggle" ${!notificationsDisabled ? 'checked' : ''}>
                                <span class="checkmark"></span>
                            </div>
                            <span class="setting-text">Activer toutes les notifications</span>
                        </label>
                        <small class="setting-help">
                            D√©sactive compl√®tement sons et notifications push
                        </small>
                    </div>
                    <div class="setting-item" id="soundSetting" style="${notificationsDisabled ? 'opacity: 0.5; pointer-events: none;' : ''}">
                        <label class="setting-label">
                            <div class="checkbox-container">
                                <input type="checkbox" id="soundToggle" ${this.soundEnabled && !notificationsDisabled ? 'checked' : ''}>
                                <span class="checkmark"></span>
                            </div>
                            <span class="setting-text">Sons de notification</span>
                        </label>
                    </div>
                    <div class="setting-item" id="pushSetting" style="${notificationsDisabled ? 'opacity: 0.5; pointer-events: none;' : ''}">
                        <label class="setting-label">
                            <div class="checkbox-container">
                                <input type="checkbox" id="pushToggle" ${this.pushEnabled && !notificationsDisabled ? 'checked' : ''}>
                                <span class="checkmark"></span>
                            </div>
                            <span class="setting-text">Notifications push (mobile)</span>
                        </label>
                        <small class="setting-help">
                            ${this.getNotificationHelp()}
                        </small>
                    </div>
                    <div class="setting-item">
                        <button id="changeNicknameBtn" class="setting-btn">üë§ Changer le pseudo</button>
                    </div>
                    <div class="setting-actions">
                        <button id="saveSettingsBtn" class="setting-btn primary">üí¨ Retour au chat</button>
                    </div>
                </div>
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = settingsHtml;
            
            document.getElementById('notificationsToggle').onchange = (e) => {
                const enabled = e.target.checked;
                localStorage.setItem('chatNotificationsDisabled', !enabled);
                
                const soundSetting = document.getElementById('soundSetting');
                const pushSetting = document.getElementById('pushSetting');
                const soundToggle = document.getElementById('soundToggle');
                const pushToggle = document.getElementById('pushToggle');
                
                if (enabled) {
                    soundSetting.style.opacity = '1';
                    soundSetting.style.pointerEvents = 'auto';
                    pushSetting.style.opacity = '1';
                    pushSetting.style.pointerEvents = 'auto';
                } else {
                    soundSetting.style.opacity = '0.5';
                    soundSetting.style.pointerEvents = 'none';
                    pushSetting.style.opacity = '0.5';
                    pushSetting.style.pointerEvents = 'none';
                    soundToggle.checked = false;
                    pushToggle.checked = false;
                    this.soundEnabled = false;
                    this.pushEnabled = false;
                    localStorage.setItem('chatSoundEnabled', false);
                    localStorage.setItem('chatPushEnabled', false);
                }
            };
            
            document.getElementById('soundToggle').onchange = (e) => {
                this.soundEnabled = e.target.checked;
                localStorage.setItem('chatSoundEnabled', this.soundEnabled);
            };
            
            document.getElementById('pushToggle').onchange = async (e) => {
                if (e.target.checked) {
                    const permission = await Notification.requestPermission();
                    this.pushEnabled = permission === 'granted';
                    e.target.checked = this.pushEnabled;
                    
                    if (this.pushEnabled) {
                        // Tester la notification
                        const testNotification = new Notification('üîî Notifications activ√©es', {
                            body: 'Vous recevrez maintenant les notifications de chat sur mobile',
                            icon: '/Misterpips.jpg',
                            tag: 'test-notification',
                            vibrate: /Android/.test(navigator.userAgent) ? [100, 50, 100] : undefined
                        });
                        
                        setTimeout(() => testNotification.close(), 3000);
                    }
                } else {
                    this.pushEnabled = false;
                }
                localStorage.setItem('chatPushEnabled', this.pushEnabled);
                
                // Afficher un message d'aide pour iOS
                if (!this.pushEnabled && /iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    setTimeout(() => {
                        alert('üì± Sur iOS: Pour recevoir les notifications, ajoutez ce site √† votre √©cran d\'accueil via Safari > Partager > Sur l\'\u00e9cran d\'accueil');
                    }, 500);
                }
            };
            
            document.getElementById('changeNicknameBtn').onclick = () => {
                this.showNicknameModal();
            };
            
            document.getElementById('saveSettingsBtn').onclick = () => {
                this.loadMessages();
            };
        };
        
        VIPChat.prototype.getNotificationHelp = function() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            if (isIOS) {
                return 'Sur iOS: Ajoutez le site √† l\'\u00e9cran d\'accueil pour les notifications';
            } else if (isAndroid) {
                return 'Notifications push disponibles sur Android';
            } else {
                return 'Notifications disponibles sur mobile et en arri√®re-plan';
            }
        };
    </script>
</body>
</html>