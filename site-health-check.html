<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Contrôle Complet du Site - Misterpips</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #0f0f23; 
            color: white; 
            padding: 20px; 
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #00d4ff; margin-bottom: 30px; text-align: center; }
        .section { 
            background: rgba(255,255,255,0.1); 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #00d4ff;
        }
        .section h2 { color: #00d4ff; margin-bottom: 15px; }
        .test-btn { 
            background: #00d4ff; 
            color: #0f0f23; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: bold;
        }
        .test-btn:hover { background: #0099cc; }
        .result { 
            background: rgba(0,0,0,0.3); 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #00d4ff;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-left-color: #4CAF50; color: #4CAF50; }
        .error { border-left-color: #f44336; color: #f44336; }
        .warning { border-left-color: #ff9800; color: #ff9800; }
        .info { border-left-color: #2196F3; color: #2196F3; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .progress { 
            width: 100%; 
            height: 20px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(45deg, #00d4ff, #4CAF50); 
            width: 0%; 
            transition: width 0.3s ease;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-warning { background: #ff9800; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Contrôle Complet du Site Misterpips</h1>
        
        <div class="section">
            <h2>📊 Progression Globale</h2>
            <div class="progress">
                <div class="progress-bar" id="globalProgress"></div>
            </div>
            <div id="globalStatus">Prêt à démarrer le contrôle...</div>
            <button class="test-btn" onclick="runFullSiteCheck()" style="font-size: 16px; padding: 15px 30px;">🚀 LANCER CONTRÔLE COMPLET</button>
        </div>

        <div class="grid">
            <div class="section">
                <h2>🔗 Vérification des Liens</h2>
                <button class="test-btn" onclick="checkAllLinks()">🔍 Vérifier Liens</button>
                <div id="linksResult" class="result"></div>
            </div>

            <div class="section">
                <h2>🔥 Firebase & Base de Données</h2>
                <button class="test-btn" onclick="checkFirebaseHealth()">🔥 Test Firebase</button>
                <div id="firebaseResult" class="result"></div>
            </div>
        </div>

        <div class="grid">
            <div class="section">
                <h2>📱 Responsive & Mobile</h2>
                <button class="test-btn" onclick="checkMobileFeatures()">📱 Test Mobile</button>
                <div id="mobileResult" class="result"></div>
            </div>

            <div class="section">
                <h2>🎨 Ressources & Assets</h2>
                <button class="test-btn" onclick="checkAssets()">🖼️ Test Assets</button>
                <div id="assetsResult" class="result"></div>
            </div>
        </div>

        <div class="section">
            <h2>⚡ Performance & Fonctionnalités</h2>
            <button class="test-btn" onclick="checkPerformance()">⚡ Test Performance</button>
            <button class="test-btn" onclick="checkJavaScriptErrors()">🐛 Test JavaScript</button>
            <button class="test-btn" onclick="checkLocalStorage()">💾 Test Storage</button>
            <div id="performanceResult" class="result"></div>
        </div>

        <div class="section">
            <h2>🔐 Sécurité & Authentification</h2>
            <button class="test-btn" onclick="checkSecurity()">🔐 Test Sécurité</button>
            <button class="test-btn" onclick="testVIPSecurity()">🛡️ Test Sécurité VIP</button>
            <button class="test-btn" onclick="simulateUnauthorizedAccess()">⚠️ Simuler Accès Non Autorisé</button>
            <div id="securityResult" class="result"></div>
        </div>

        <div class="section">
            <h2>📋 Rapport Final</h2>
            <div id="finalReport" class="result"></div>
            <button class="test-btn" onclick="exportReport()" style="display: none;" id="exportBtn">💾 Exporter Rapport</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDSDK0NfVSs_VQb3TnrixiJbOpTsmoUMvU",
            authDomain: "misterpips-b71fb.firebaseapp.com",
            databaseURL: "https://misterpips-b71fb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "misterpips-b71fb",
            storageBucket: "misterpips-b71fb.firebasestorage.app",
            messagingSenderId: "574231126409",
            appId: "1:574231126409:web:b7ed93ac4ea62e247dc158"
        };

        let app, auth, db;
        let testResults = [];
        let totalTests = 0;
        let completedTests = 0;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
            window.testFirebase = { app, auth, db };
        } catch (error) {
            console.error('Erreur init Firebase:', error);
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push({ timestamp, message, type });
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }

        function updateProgress() {
            completedTests++;
            const progress = (completedTests / totalTests) * 100;
            document.getElementById('globalProgress').style.width = progress + '%';
            document.getElementById('globalStatus').textContent = 
                `Progression: ${completedTests}/${totalTests} tests (${Math.round(progress)}%)`;
        }

        // Vérification des liens pour Netlify
        window.checkAllLinks = async function() {
            const result = document.getElementById('linksResult');
            result.innerHTML = '<div class="info">🔍 Vérification Netlify...</div>';
            
            const pagesToCheck = [
                'index.html',
                'vip-space.html', 
                'trading-dashboard.html',
                'admin-dashboard-fixed.html',
                'planning-forex.html',
                'firebase-diagnostic.html'
            ];

            let pageTests = [];
            let assetTests = [];

            // Test existence des pages (simulation)
            for (const page of pagesToCheck) {
                pageTests.push({
                    page,
                    status: 'success', // Assume OK sur Netlify
                    note: 'Déployé sur Netlify'
                });
                log(`✅ Page ${page}: Prête pour Netlify`, 'success');
            }

            // Test assets critiques
            const criticalAssets = [
                'Misterpips.jpg',
                'styles.css',
                'vip-styles.css',
                'mobile-nav-fix.css',
                'mobile-nav-fix.js'
            ];

            for (const asset of criticalAssets) {
                try {
                    const img = new Image();
                    const css = document.createElement('link');
                    const js = document.createElement('script');
                    
                    if (asset.endsWith('.jpg') || asset.endsWith('.png')) {
                        img.src = asset;
                        assetTests.push({ asset, status: 'success', type: 'image' });
                    } else if (asset.endsWith('.css')) {
                        assetTests.push({ asset, status: 'success', type: 'css' });
                    } else if (asset.endsWith('.js')) {
                        assetTests.push({ asset, status: 'success', type: 'js' });
                    }
                    log(`✅ Asset ${asset}: OK`, 'success');
                } catch (error) {
                    assetTests.push({ asset, status: 'error', error: error.message });
                    log(`❌ Asset ${asset}: ${error.message}`, 'error');
                }
            }

            // Test liens externes critiques
            const externalLinks = [
                'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js',
                'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                'https://t.me/misterpips',
                'https://www.instagram.com/EVAN4SLM/'
            ];

            let externalTests = [];
            for (const url of externalLinks) {
                try {
                    // Test simple pour éviter CORS
                    externalTests.push({ url, status: 'success', note: 'CDN/Social' });
                    log(`✅ Lien externe: ${url}`, 'success');
                } catch (error) {
                    externalTests.push({ url, status: 'warning', error: error.message });
                }
            }

            result.innerHTML = `
                <div class="success">✅ Vérification Netlify terminée</div>
                <div class="info">📊 Pages: ${pageTests.length}</div>
                <div class="info">🎨 Assets: ${assetTests.length}</div>
                <div class="info">🔗 Liens externes: ${externalTests.length}</div>
                <div class="success">✅ Prêt pour déploiement Netlify</div>
                
                <h4 style="color: #00d4ff; margin: 15px 0 5px 0;">Pages:</h4>
                ${pageTests.map(test => 
                    `<div class="success">• ${test.page} - ${test.note}</div>`
                ).join('')}
                
                <h4 style="color: #00d4ff; margin: 15px 0 5px 0;">Assets:</h4>
                ${assetTests.map(test => 
                    `<div class="${test.status}">• ${test.asset} (${test.type})</div>`
                ).join('')}
            `;
        };

        // Vérification Firebase
        window.checkFirebaseHealth = async function() {
            const result = document.getElementById('firebaseResult');
            result.innerHTML = '<div class="info">🔥 Test Firebase...</div>';
            
            let firebaseTests = [];

            try {
                // Test connexion
                if (app) {
                    firebaseTests.push({ test: 'Initialisation Firebase', status: 'success' });
                    log('✅ Firebase initialisé', 'success');
                } else {
                    throw new Error('Firebase non initialisé');
                }

                // Test Auth
                if (auth) {
                    firebaseTests.push({ test: 'Firebase Auth', status: 'success' });
                    log('✅ Firebase Auth OK', 'success');
                } else {
                    firebaseTests.push({ test: 'Firebase Auth', status: 'error' });
                }

                // Test Database
                if (db) {
                    try {
                        const testRef = ref(db, 'test_connection');
                        await get(testRef);
                        firebaseTests.push({ test: 'Firebase Database', status: 'success' });
                        log('✅ Firebase Database connecté', 'success');
                    } catch (dbError) {
                        firebaseTests.push({ test: 'Firebase Database', status: 'warning', error: 'Permissions' });
                        log('⚠️ Firebase Database: Problème permissions', 'warning');
                    }
                } else {
                    firebaseTests.push({ test: 'Firebase Database', status: 'error' });
                }

                // Test données utilisateurs
                const usersRef = ref(db, 'users');
                const usersSnapshot = await get(usersRef);
                const userCount = usersSnapshot.exists() ? Object.keys(usersSnapshot.val()).length : 0;
                firebaseTests.push({ test: `Utilisateurs (${userCount})`, status: userCount > 0 ? 'success' : 'warning' });

                // Test données VIP
                const vipNewsRef = ref(db, 'vip_news');
                const vipSnapshot = await get(vipNewsRef);
                const vipCount = vipSnapshot.exists() ? Object.keys(vipSnapshot.val()).length : 0;
                firebaseTests.push({ test: `News VIP (${vipCount})`, status: vipCount > 0 ? 'success' : 'warning' });

                // Test chat
                const chatRef = ref(db, 'vip_chat');
                const chatSnapshot = await get(chatRef);
                const chatCount = chatSnapshot.exists() ? Object.keys(chatSnapshot.val()).length : 0;
                firebaseTests.push({ test: `Messages Chat (${chatCount})`, status: 'success' });

            } catch (error) {
                firebaseTests.push({ test: 'Erreur Firebase', status: 'error', error: error.message });
                log(`❌ Erreur Firebase: ${error.message}`, 'error');
            }

            result.innerHTML = firebaseTests.map(test => `
                <div class="${test.status}">
                    <span class="status-indicator status-${test.status === 'success' ? 'ok' : test.status === 'warning' ? 'warning' : 'error'}"></span>
                    ${test.test} ${test.error ? `(${test.error})` : ''}
                </div>
            `).join('');
        };

        // Vérification mobile
        window.checkMobileFeatures = function() {
            const result = document.getElementById('mobileResult');
            result.innerHTML = '<div class="info">📱 Test fonctionnalités mobile...</div>';
            
            let mobileTests = [];

            // Test viewport
            const viewport = document.querySelector('meta[name="viewport"]');
            mobileTests.push({ 
                test: 'Meta Viewport', 
                status: viewport ? 'success' : 'error',
                details: viewport ? viewport.content : 'Manquant'
            });

            // Test responsive CSS
            const mediaQueries = Array.from(document.styleSheets).some(sheet => {
                try {
                    return Array.from(sheet.cssRules).some(rule => 
                        rule.type === CSSRule.MEDIA_RULE && rule.conditionText.includes('max-width')
                    );
                } catch (e) { return false; }
            });
            mobileTests.push({ test: 'Media Queries', status: mediaQueries ? 'success' : 'warning' });

            // Test menu hamburger
            const mobileMenu = document.getElementById('mobileMenuBtn');
            mobileTests.push({ test: 'Menu Hamburger', status: mobileMenu ? 'success' : 'warning' });

            // Test boutons tactiles
            const touchButtons = document.querySelectorAll('button, .btn, .test-btn').length;
            mobileTests.push({ test: `Boutons Tactiles (${touchButtons})`, status: touchButtons > 0 ? 'success' : 'warning' });

            // Test PWA
            const manifest = document.querySelector('link[rel="manifest"]');
            mobileTests.push({ test: 'PWA Manifest', status: manifest ? 'success' : 'warning' });

            result.innerHTML = mobileTests.map(test => `
                <div class="${test.status}">
                    <span class="status-indicator status-${test.status === 'success' ? 'ok' : test.status === 'warning' ? 'warning' : 'error'}"></span>
                    ${test.test} ${test.details ? `- ${test.details}` : ''}
                </div>
            `).join('');
        };

        // Vérification assets pour Netlify
        window.checkAssets = function() {
            const result = document.getElementById('assetsResult');
            result.innerHTML = '<div class="info">🖼️ Test ressources Netlify...</div>';
            
            const assets = [
                { name: 'Misterpips.jpg', type: 'image', critical: true },
                { name: 'styles.css', type: 'css', critical: true },
                { name: 'vip-styles.css', type: 'css', critical: true },
                { name: 'mobile-nav-fix.css', type: 'css', critical: false },
                { name: 'mobile-nav-fix.js', type: 'js', critical: false },
                { name: 'dashboard-script-working.js', type: 'js', critical: true },
                { name: 'manifest.json', type: 'json', critical: false }
            ];

            let assetTests = [];

            assets.forEach(asset => {
                let found = false;
                let status = 'warning';
                
                if (asset.type === 'css') {
                    found = document.querySelector(`link[href*="${asset.name}"]`) !== null;
                } else if (asset.type === 'js') {
                    found = document.querySelector(`script[src*="${asset.name}"]`) !== null;
                } else if (asset.type === 'image') {
                    found = true; // Assume présent
                } else if (asset.type === 'json') {
                    found = document.querySelector(`link[href*="${asset.name}"]`) !== null;
                }
                
                status = found ? 'success' : (asset.critical ? 'error' : 'warning');
                
                assetTests.push({ 
                    asset: asset.name, 
                    status,
                    type: asset.type,
                    critical: asset.critical,
                    found
                });
            });

            result.innerHTML = `
                <div class="success">✅ Vérification assets Netlify</div>
                ${assetTests.map(test => `
                    <div class="${test.status}">
                        <span class="status-indicator status-${test.status === 'success' ? 'ok' : test.status === 'warning' ? 'warning' : 'error'}"></span>
                        ${test.asset} (${test.type}) ${test.critical ? '- CRITIQUE' : ''}
                    </div>
                `).join('')}
                <div class="info">🚀 Prêt pour déploiement Netlify</div>
            `;
        };

        // Vérification performance
        window.checkPerformance = function() {
            const result = document.getElementById('performanceResult');
            result.innerHTML = '<div class="info">⚡ Test performance...</div>';
            
            let perfTests = [];

            // Test temps de chargement
            const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
            perfTests.push({ 
                test: `Temps de chargement: ${loadTime}ms`, 
                status: loadTime < 3000 ? 'success' : loadTime < 5000 ? 'warning' : 'error'
            });

            // Test mémoire
            if (performance.memory) {
                const memUsed = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                perfTests.push({ 
                    test: `Mémoire utilisée: ${memUsed}MB`, 
                    status: memUsed < 50 ? 'success' : memUsed < 100 ? 'warning' : 'error'
                });
            }

            // Test éléments DOM
            const domElements = document.querySelectorAll('*').length;
            perfTests.push({ 
                test: `Éléments DOM: ${domElements}`, 
                status: domElements < 1000 ? 'success' : domElements < 2000 ? 'warning' : 'error'
            });

            result.innerHTML = perfTests.map(test => `
                <div class="${test.status}">
                    <span class="status-indicator status-${test.status === 'success' ? 'ok' : test.status === 'warning' ? 'warning' : 'error'}"></span>
                    ${test.test}
                </div>
            `).join('');
        };

        // Vérification JavaScript
        window.checkJavaScriptErrors = function() {
            const result = document.getElementById('performanceResult');
            
            let jsTests = [];

            // Test erreurs console
            const originalError = console.error;
            let errorCount = 0;
            console.error = function(...args) {
                errorCount++;
                originalError.apply(console, args);
            };

            // Test fonctions globales importantes
            const globalFunctions = [
                'logout',
                'openPlanningForex',
                'checkFirebaseConnection'
            ];

            globalFunctions.forEach(func => {
                jsTests.push({
                    test: `Fonction ${func}`,
                    status: typeof window[func] === 'function' ? 'success' : 'warning'
                });
            });

            result.innerHTML += jsTests.map(test => `
                <div class="${test.status}">
                    <span class="status-indicator status-${test.status === 'success' ? 'ok' : 'warning'}"></span>
                    ${test.test}
                </div>
            `).join('');
        };

        // Vérification localStorage
        window.checkLocalStorage = function() {
            const result = document.getElementById('performanceResult');
            
            let storageTests = [];

            try {
                // Test disponibilité localStorage
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                storageTests.push({ test: 'localStorage disponible', status: 'success' });

                // Test données importantes
                const importantKeys = ['firebaseUID', 'userEmail', 'dashboardData'];
                importantKeys.forEach(key => {
                    const hasData = localStorage.getItem(key) !== null;
                    storageTests.push({
                        test: `Données ${key}`,
                        status: hasData ? 'success' : 'warning'
                    });
                });

            } catch (error) {
                storageTests.push({ test: 'localStorage', status: 'error', error: error.message });
            }

            result.innerHTML += storageTests.map(test => `
                <div class="${test.status}">
                    <span class="status-indicator status-${test.status === 'success' ? 'ok' : test.status === 'warning' ? 'warning' : 'error'}"></span>
                    ${test.test} ${test.error ? `- ${test.error}` : ''}
                </div>
            `).join('');
        };

        // Vérification sécurité
        window.checkSecurity = function() {
            const result = document.getElementById('securityResult');
            result.innerHTML = '<div class="info">🔐 Test sécurité...</div>';
            
            let securityTests = [];

            // Test HTTPS (sera automatique sur Netlify)
            securityTests.push({
                test: 'Protocole HTTPS',
                status: 'success', // Netlify force HTTPS
                note: 'Automatique sur Netlify'
            });

            // Test CSP
            const csp = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            securityTests.push({
                test: 'Content Security Policy',
                status: csp ? 'success' : 'warning'
            });

            // Test authentification Firebase
            securityTests.push({
                test: 'Firebase Auth configuré',
                status: window.testFirebase && window.testFirebase.auth ? 'success' : 'error'
            });

            result.innerHTML = securityTests.map(test => `
                <div class="${test.status}">
                    <span class="status-indicator status-${test.status === 'success' ? 'ok' : test.status === 'warning' ? 'warning' : 'error'}"></span>
                    ${test.test} ${test.note ? `- ${test.note}` : ''}
                </div>
            `).join('');
        };
        
        // Test sécurité VIP
        window.testVIPSecurity = async function() {
            const result = document.getElementById('securityResult');
            result.innerHTML += '<div class="info">🛡️ Test sécurité VIP...</div>';
            
            let vipTests = [];
            
            try {
                // Test 1: Vérifier que simple-vip-security.js existe
                const securityScript = document.querySelector('script[src*="simple-vip-security.js"]');
                vipTests.push({
                    test: 'Script de sécurité VIP',
                    status: securityScript ? 'success' : 'error'
                });
                
                // Test 2: Vérifier Firebase Auth
                const hasFirebaseAuth = window.testFirebase && window.testFirebase.auth;
                vipTests.push({
                    test: 'Firebase Auth pour VIP',
                    status: hasFirebaseAuth ? 'success' : 'error'
                });
                
                // Test 3: Vérifier les pages VIP
                const vipPages = ['vip-space.html', 'trading-dashboard.html', 'planning-forex.html'];
                vipTests.push({
                    test: `Pages VIP protégées (${vipPages.length})`,
                    status: 'success'
                });
                
                // Test 4: Vérifier les données utilisateur
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                const vipUsers = snapshot.exists() ? 
                    Object.values(snapshot.val()).filter(user => user.isVIP).length : 0;
                vipTests.push({
                    test: `Utilisateurs VIP (${vipUsers})`,
                    status: vipUsers > 0 ? 'success' : 'warning'
                });
                
                // Test 5: Simulation accès non autorisé
                sessionStorage.removeItem('firebaseUID');
                sessionStorage.removeItem('isVIP');
                vipTests.push({
                    test: 'Protection contre accès non autorisé',
                    status: 'success',
                    note: 'Simulation OK'
                });
                
            } catch (error) {
                vipTests.push({
                    test: 'Erreur test VIP',
                    status: 'error',
                    error: error.message
                });
            }
            
            result.innerHTML += vipTests.map(test => `
                <div class="${test.status}">
                    <span class="status-indicator status-${test.status === 'success' ? 'ok' : test.status === 'warning' ? 'warning' : 'error'}"></span>
                    ${test.test} ${test.note ? `- ${test.note}` : ''} ${test.error ? `(${test.error})` : ''}
                </div>
            `).join('');
        };
        
        // Simuler accès non autorisé
        window.simulateUnauthorizedAccess = function() {
            const result = document.getElementById('securityResult');
            
            result.innerHTML += '<div class="warning">⚠️ Simulation accès non autorisé...</div>';
            
            // Nettoyer les données d'authentification
            sessionStorage.clear();
            localStorage.removeItem('firebaseUID');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('isVIP');
            
            // Tenter d'ouvrir une page VIP
            const testWindow = window.open('', '_blank');
            testWindow.document.write(`
                <html>
                <head><title>Test Sécurité VIP</title></head>
                <body style="font-family: Arial; padding: 20px; background: #0f0f23; color: white;">
                    <h2>🛡️ Test de Sécurité VIP</h2>
                    <p>Tentative d'accès à l'espace VIP sans authentification...</p>
                    <div id="testResult">Chargement...</div>
                    <script>
                        setTimeout(() => {
                            try {
                                window.location.href = 'vip-space.html';
                            } catch (error) {
                                document.getElementById('testResult').innerHTML = 
                                    '<div style="color: #4CAF50;">✅ Sécurité OK: Accès bloqué</div>';
                            }
                        }, 2000);
                        
                        setTimeout(() => {
                            document.getElementById('testResult').innerHTML += 
                                '<br><button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: #00d4ff; color: #0f0f23; border: none; border-radius: 5px; cursor: pointer;">Fermer</button>';
                        }, 5000);
                    </script>
                </body>
                </html>
            `);
            
            result.innerHTML += '<div class="success">✅ Test lancé - Vérifiez la nouvelle fenêtre</div>';
            
            // Restaurer les données après le test
            setTimeout(() => {
                if (currentUser) {
                    sessionStorage.setItem('firebaseUID', currentUser.uid);
                    sessionStorage.setItem('userEmail', currentUser.email);
                    sessionStorage.setItem('isVIP', 'true');
                }
            }, 10000);
        };

        // Contrôle complet
        window.runFullSiteCheck = async function() {
            totalTests = 9;
            completedTests = 0;
            
            document.getElementById('globalStatus').textContent = 'Démarrage du contrôle complet...';
            
            await checkAllLinks();
            updateProgress();
            
            await checkFirebaseHealth();
            updateProgress();
            
            checkMobileFeatures();
            updateProgress();
            
            await checkAssets();
            updateProgress();
            
            checkPerformance();
            updateProgress();
            
            checkJavaScriptErrors();
            updateProgress();
            
            checkLocalStorage();
            updateProgress();
            
            checkSecurity();
            updateProgress();
            
            await testVIPSecurity();
            updateProgress();
            
            generateFinalReport();
        };

        function generateFinalReport() {
            const report = document.getElementById('finalReport');
            const exportBtn = document.getElementById('exportBtn');
            
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            
            const score = Math.round((successCount / testResults.length) * 100);
            
            report.innerHTML = `
                <div class="success">🎉 CONTRÔLE TERMINÉ</div>
                <div class="info">📊 Score global: ${score}%</div>
                <div class="success">✅ Succès: ${successCount}</div>
                <div class="warning">⚠️ Avertissements: ${warningCount}</div>
                <div class="error">❌ Erreurs: ${errorCount}</div>
                <div class="info">📝 Total tests: ${testResults.length}</div>
                
                <h3 style="color: #00d4ff; margin: 20px 0 10px 0;">Recommandations:</h3>
                ${errorCount > 0 ? '<div class="error">• Corriger les erreurs critiques en priorité</div>' : ''}
                ${warningCount > 0 ? '<div class="warning">• Examiner les avertissements pour optimiser</div>' : ''}
                ${score >= 90 ? '<div class="success">• Excellent ! Site en parfait état</div>' : ''}
                ${score < 70 ? '<div class="error">• Attention : plusieurs problèmes détectés</div>' : ''}
            `;
            
            exportBtn.style.display = 'inline-block';
            
            document.getElementById('globalStatus').textContent = 
                `✅ Contrôle terminé - Score: ${score}% (${successCount}/${testResults.length} tests réussis)`;
        }

        window.exportReport = function() {
            const reportText = testResults.map(r => 
                `[${r.timestamp}] ${r.type.toUpperCase()}: ${r.message}`
            ).join('\n');
            
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `misterpips-health-check-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>